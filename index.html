
<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nusadua Store</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0ea5e9"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/0ea5e9/ffffff?text=App">
    <link rel="manifest" id="manifest-link">
    <link rel="icon" href="/logobaru.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
            /* Ukuran font dasar yang lebih besar dan fluid, ideal untuk tablet */
        html {
            font-size: clamp(16px, 1.5vw + 0.25rem, 20px);
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-item.active svg,
        .nav-item.active .nav-text {
            color: #0ea5e9; /* sky-500 */
        }

        /* --- Animasi Transisi Halaman --- */
        @keyframes page-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page, .sub-page, .modal-container { display: none; }

        .page.active { 
            display: block; 
            animation: page-fade-in 0.3s ease-out;
        }
        .sub-page.active { 
            display: flex;
            animation: page-fade-in 0.3s ease-out;
        }
        .modal-container.active { 
            display: flex;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .form-field { display: block; }
        .form-field.hidden { display: none; }
</style>
</head>
<body class="bg-gray-100 h-full text-gray-800 antialiased">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-900 transition-opacity duration-300 ease-in-out">
        <img src="logobaru.png" alt="Nusadua Store Logo" class="h-15 w-80 rounded-l mb-10 animate-pulse">
    </div>

    <!-- Sidebar Akun (Lebar disesuaikan untuk tablet) -->
    <aside id="account-sidebar" class="fixed top-0 left-0 z-[60] w-72 lg:w-[25%] h-screen transition-transform -translate-x-full lg:translate-x-0 bg-slate-800 border-r border-slate-700">
        <div class="h-20 lg:h-16 flex items-center px-4 border-b border-slate-700">
             <img src="logobaru.png" alt="Nusadua Store Logo" class="h-15 w-140 rounded-md">
        </div>
        <div class="py-4 px-3 h-[calc(100%-5rem)] lg:h-[calc(100%-4rem)] overflow-y-auto">
            <h3 class="px-1 mb-2 text-sm font-semibold text-gray-400">Daftar Akun</h3>
            <div id="account-sidebar-list" class="divide-y divide-slate-700">
                 <!-- Daftar Akun akan dirender di sini -->
            </div>
        </div>
    </aside>

    <!-- Backdrop untuk Sidebar Akun Mobile -->
    <div id="account-sidebar-backdrop" class="fixed inset-0 z-50 bg-gray-900/50 hidden lg:hidden"></div>
    
    <!-- Wrapper Konten Utama (Padding disesuaikan dengan sidebar) -->
    <div class="lg:pl-[25%] transition-all duration-300">
        <!-- Header (Posisi disesuaikan dengan sidebar) -->
        <header class="fixed top-0 left-0 right-0 lg:left-[25%] bg-slate-900/90 backdrop-blur-sm border-b border-slate-700 z-40 h-20 lg:h-16">
            <div class="flex justify-between items-center w-full h-full px-4 sm:px-6 lg:px-8">
                <!-- Left: Title -->
                <div class="flex items-center space-x-3">
                    <span id="header-icon" class="text-gray-400">
                        <!-- Icon will be injected here by JavaScript -->
                    </span>
                    <h1 id="header-title" class="text-xl font-bold text-gray-100">Pengaturan</h1>
                </div>

                <!-- Right: Icons -->
                <div class="flex items-center space-x-2">
                    <!-- Tombol Tentang -->
                    <button id="about-button" type="button" class="inline-flex items-center p-2 text-sm text-gray-400 rounded-lg hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                    <!-- Tombol Sidebar (Hanya tampil di mode portrait/mobile) -->
                    <button id="account-sidebar-toggle" type="button" class="inline-flex items-center p-2 text-sm text-gray-400 rounded-lg lg:hidden hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-600">
                        <span class="sr-only">Buka sidebar akun</span>
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pt-24 pb-24 lg:pt-20 lg:pb-20 px-4 sm:px-6 lg:px-8">
             <!-- Halaman Dasbor -->
            <div id="dasbor" class="page active">
                <div class="space-y-8">
                    <!-- Analisa Umum -->
                    <div>
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Analisa Umum</h2>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div id="total-saldo-card" class="p-4 rounded-lg shadow h-24 bg-blue-500 text-white"></div>
                            <div id="total-cash-card" class="p-4 rounded-lg shadow h-24 bg-emerald-500 text-white"></div>
                            <div id="modal-saldo-card" class="p-4 rounded-lg shadow h-24 bg-indigo-500 text-white"></div>
                        </div>
                        <div class="grid grid-cols-3 grid-rows-2 gap-4">
                            <div class="bg-white p-4 rounded-lg shadow col-span-2 row-span-2 min-h-[208px]">
                                <canvas id="revenue-chart"></canvas>
                            </div>
                            <div id="total-laba-bersih-card" class="p-4 rounded-lg shadow col-span-1 h-24 bg-green-500"></div>
                            <div id="pengeluaran-card" class="p-4 rounded-lg shadow col-span-1 h-24 bg-red-500"></div>
                        </div>
                    </div>

                    <!-- Filter Minimalis -->
                    <div class="bg-white p-2 rounded-lg shadow">
                        <div class="flex flex-wrap items-center justify-between gap-2">
                            <!-- Tombol Preset -->
                            <div id="filter-presets" class="flex items-center gap-1 bg-sky-50 p-1 rounded-lg">
                                <button data-filter="today" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md text-sky-700 hover:bg-sky-100">Hari Ini</button>
                                <button data-filter="month" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md text-sky-700 hover:bg-sky-100">Bulan Ini</button>
                                <button data-filter="year" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md text-sky-700 hover:bg-sky-100">Tahun Ini</button>
                            </div>
                            <!-- Rentang Tanggal Kustom -->
                            <div class="flex items-center gap-2 flex-grow sm:flex-grow-0">
                                 <input type="date" id="filter-start-date" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                                 <span class="text-gray-400">-</span>
                                 <input type="date" id="filter-end-date" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                        </div>
                    </div>
            
                    <!-- Analisa Khusus -->
                    <div>
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Analisa Khusus</h2>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div id="fee-bri-link-card" class="p-4 rounded-lg shadow h-24 bg-white"></div>
                            <div id="bri-nussa-card" class="p-4 rounded-lg shadow h-24 bg-white"></div>
                            <div id="tabungan-card" class="p-4 rounded-lg shadow h-24 bg-white"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div id="laba-bersih-card" class="p-4 rounded-lg shadow h-24 bg-green-100"></div>
                            <div id="pengeluaran-rumah-card" class="p-4 rounded-lg shadow h-24 bg-red-100"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div id="hutang-aktif-card" class="p-4 rounded-lg shadow col-span-2 min-h-[208px] bg-white"></div>
                            <div id="hutang-card" class="p-4 rounded-lg shadow col-span-1 min-h-[208px] bg-white"></div>
                        </div>
                    </div>
            
                    <!-- Analisa Penjualan -->
                    <div>
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Analisa Penjualan</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Left: Chart -->
                            <div class="bg-white p-4 rounded-lg shadow flex items-center justify-center min-h-[320px]">
                                <canvas id="sales-chart"></canvas>
                            </div>

                            <!-- Right: Small Cards -->
                            <div class="grid grid-cols-2 gap-4">
                                <div id="produk-terjual-card" class="bg-white p-4 rounded-lg shadow h-24"></div>
                                <div id="laba-produk-card" class="bg-white p-4 rounded-lg shadow h-24"></div>
                                <div id="jasa-terjual-card" class="bg-white p-4 rounded-lg shadow h-24"></div>
                                <div id="laba-jasa-card" class="bg-white p-4 rounded-lg shadow h-24"></div>
                                <div id="laba-aplikasi-card" class="bg-white p-4 rounded-lg shadow h-24"></div>
                                <div id="laba-transaksi-card" class="bg-white p-4 rounded-lg shadow h-24"></div>
                                <div id="laba-penjualan-filter-card" class="bg-white p-4 rounded-lg shadow col-span-2 h-24"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Halaman Kasir -->
            <div id="kasir" class="page">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Left Section: Form and Cart -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- 1. Form Penjualan -->
                        <div class="bg-sky-50 rounded-xl border border-sky-200 shadow-sm p-4">
                            <!-- Tabs -->
                            <div class="mb-4">
                                <div class="flex space-x-2">
                                    <button class="tab-btn flex-1 py-2 px-2 rounded-lg text-sm font-bold text-white bg-blue-500 shadow-lg" data-target="panel-produk">
                                        Produk
                                    </button>
                                    <button class="tab-btn flex-1 py-2 px-2 rounded-lg text-sm font-semibold text-gray-700 bg-gray-200" data-target="panel-jasa">
                                        Jasa
                                    </button>
                                    <button class="tab-btn flex-1 py-2 px-2 rounded-lg text-sm font-semibold text-gray-700 bg-gray-200" data-target="panel-aplikasi">
                                        Aplikasi
                                    </button>
                                </div>
                            </div>

                            <!-- Tab Panels -->
                            <div id="tab-panels">
                                <div id="panel-produk" class="tab-panel space-y-3">
                                    <div>
                                        <label for="kasir-produk-select" class="block text-xs font-medium text-gray-600 mb-1">Cari Produk</label>
                                        <select id="kasir-produk-select" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="kasir-produk-jumlah" class="block text-xs font-medium text-gray-600 mb-1">Jumlah</label>
                                            <input type="number" id="kasir-produk-jumlah" value="1" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        </div>
                                         <div>
                                            <label for="kasir-produk-tanggal" class="block text-xs font-medium text-gray-600 mb-1">Tanggal</label>
                                            <input type="date" id="kasir-produk-tanggal" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        </div>
                                    </div>
                                    <button id="kasir-tambah-produk" class="w-full bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg text-sm">Tambah ke Keranjang</button>
                                </div>
                                <div id="panel-jasa" class="tab-panel hidden space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="kasir-jasa-nama" class="block text-xs font-medium text-gray-600 mb-1">Nama Jasa</label>
                                            <input type="text" id="kasir-jasa-nama" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Contoh: Service Printer">
                                        </div>
                                        <div>
                                            <label for="kasir-jasa-tanggal" class="block text-xs font-medium text-gray-600 mb-1">Tanggal</label>
                                            <input type="date" id="kasir-jasa-tanggal" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="kasir-jasa-harga-modal" class="block text-xs font-medium text-gray-600 mb-1">Harga Modal</label>
                                            <input type="number" id="kasir-jasa-harga-modal" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="0">
                                        </div>
                                        <div>
                                            <label for="kasir-jasa-harga-jual" class="block text-xs font-medium text-gray-600 mb-1">Harga Jual</label>
                                            <input type="number" id="kasir-jasa-harga-jual" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="0">
                                        </div>
                                    </div>
                                    <button id="kasir-tambah-jasa" class="w-full bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg text-sm">Tambah ke Keranjang</button>
                                </div>
                                <div id="panel-aplikasi" class="tab-panel hidden space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="kasir-aplikasi-tanggal" class="block text-xs font-medium text-gray-600 mb-1">Tanggal</label>
                                            <input type="date" id="kasir-aplikasi-tanggal" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        </div>
                                        <div>
                                            <label for="kasir-aplikasi-sumber-akun" class="block text-xs font-medium text-gray-600 mb-1">Sumber Akun</label>
                                            <select id="kasir-aplikasi-sumber-akun" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="kasir-aplikasi-harga-modal" class="block text-xs font-medium text-gray-600 mb-1">Harga Modal</label>
                                            <input type="number" id="kasir-aplikasi-harga-modal" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="0">
                                        </div>
                                        <div>
                                            <label for="kasir-aplikasi-harga-jual" class="block text-xs font-medium text-gray-600 mb-1">Harga Jual</label>
                                            <input type="number" id="kasir-aplikasi-harga-jual" class="w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="0">
                                        </div>
                                    </div>
                                    <button id="kasir-tambah-aplikasi" class="w-full bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg text-sm">Tambah ke Keranjang</button>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Keranjang Belanja -->
                        <div class="bg-emerald-50 rounded-xl border border-emerald-200 shadow-sm">
                            <div id="keranjang-item-list" class="p-4 max-h-[40vh] overflow-y-auto">
                                <p class="text-center text-gray-500 text-sm py-8">Keranjang masih kosong.</p>
                            </div>
                            <div class="p-2 border-t border-emerald-200 flex items-center justify-between space-x-2">
                                <div class="text-base font-bold">
                                    <span class="text-gray-500 text-sm">Total:</span>
                                    <span id="keranjang-total">Rp 0</span>
                                </div>
                                <button id="keranjang-bayar-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-5 rounded-lg text-sm transition-colors">
                                    Bayar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Section: History -->
                    <div class="lg:col-span-3">
                        <!-- 3. Riwayat Transaksi -->
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full">
                            <div class="p-4 border-b flex-shrink-0">
                                <h3 class="text-base font-semibold text-gray-800">Riwayat Penjualan Terakhir</h3>
                            </div>
                            <div id="kasir-riwayat-list" class="overflow-y-auto flex-grow">
                                <!-- Riwayat Penjualan dirender di sini -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Halaman Transaksi -->
            <div id="transaksi" class="page">
                <div class="w-full max-w-6xl mx-auto">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Riwayat Transaksi</h2>
                        <button id="btn-add-transaksi" class="bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-2 px-5 rounded-lg text-sm flex items-center whitespace-nowrap shadow-lg hover:shadow-xl transition-shadow">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Tambah Transaksi
                        </button>
                    </div>
                    <div id="transaksi-list-container" class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <!-- Konten riwayat transaksi baru akan dirender di sini -->
                    </div>
                </div>
            </div>
             <!-- Halaman Laporan -->
            <div id="laporan" class="page">
                <div class="w-full max-w-4xl mx-auto space-y-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Laporan Umum</h2>
                        <p class="text-sm text-gray-500">Berikut adalah ringkasan keseluruhan data Anda tanpa filter.</p>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6 text-sm">
                        <!-- Laba Rugi -->
                        <section>
                            <h3 class="text-base font-semibold text-gray-800 border-b pb-2 mb-3">Laporan Laba Rugi</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Nilai Penjualan</span><span id="report-total-penjualan" class="font-semibold text-gray-900"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Pemasukan Lainnya</span><span id="report-total-pemasukan" class="font-semibold text-gray-900"></span></div>
                                <div class="flex justify-between items-center border-t pt-2 mt-2"><span class="font-bold">Total Pendapatan (A)</span><span id="report-total-pendapatan" class="font-bold text-green-600"></span></div>
                            </div>
                            <div class="space-y-2 mt-4">
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Modal Penjualan (HPP)</span><span id="report-total-modal" class="font-semibold text-gray-900"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Pengeluaran</span><span id="report-total-pengeluaran" class="font-semibold text-gray-900"></span></div>
                                <div class="flex justify-between items-center border-t pt-2 mt-2"><span class="font-bold">Total Beban (B)</span><span id="report-total-beban" class="font-bold text-red-600"></span></div>
                            </div>
                            <div class="flex justify-between items-center border-t-2 border-gray-300 pt-3 mt-3"><h4 class="text-base font-bold">Laba Kotor (A - B)</h4><span id="report-laba-kotor" class="text-base font-bold text-sky-600"></span></div>
                        </section>
                        
                        <!-- Rincian Penjualan & Laba -->
                        <section>
                            <h3 class="text-base font-semibold text-gray-800 border-b pb-2 mb-3">Rincian Penjualan & Laba</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                                <div class="flex justify-between items-center"><span class="text-gray-600">Unit Produk Terjual</span><span id="report-produk-terjual" class="font-semibold text-gray-900"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Unit Jasa Terjual</span><span id="report-jasa-terjual" class="font-semibold text-gray-900"></span></div>
                                
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Penjualan Produk</span><span id="report-penjualan-produk" class="font-semibold text-gray-900"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Penjualan Jasa</span><span id="report-penjualan-jasa" class="font-semibold text-gray-900"></span></div>

                                <div class="flex justify-between items-center"><span class="text-gray-600">Laba dari Produk</span><span id="report-laba-produk" class="font-semibold text-green-600"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Laba dari Jasa</span><span id="report-laba-jasa" class="font-semibold text-green-600"></span></div>
                                
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Penjualan Aplikasi</span><span id="report-penjualan-aplikasi" class="font-semibold text-gray-900"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Laba dari Aplikasi</span><span id="report-laba-aplikasi" class="font-semibold text-green-600"></span></div>
                            </div>
                            <div class="flex justify-between items-center border-t pt-2 mt-2">
                                <span class="font-bold">Total Laba Penjualan</span>
                                <span id="report-total-laba-penjualan" class="font-bold text-green-700"></span>
                            </div>
                        </section>

                        <!-- Laporan Hutang -->
                        <section>
                            <h3 class="text-base font-semibold text-gray-800 border-b pb-2 mb-3">Laporan Hutang</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Nominal Hutang Aktif</span><span id="report-total-hutang" class="font-semibold text-red-600"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Jumlah Pihak Berhutang</span><span id="report-jumlah-penghutang" class="font-semibold text-gray-900"></span></div>
                            </div>
                        </section>

                        <!-- Laporan Transaksi Keuangan -->
                        <section>
                            <h3 class="text-base font-semibold text-gray-800 border-b pb-2 mb-3">Laporan Transaksi Keuangan</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Transaksi Keuangan (Jumlah)</span><span id="report-total-transaksi-keuangan" class="font-semibold text-gray-900"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Pemasukan (Laba Bersih)</span><span id="report-nominal-laba-bersih" class="font-semibold text-green-600"></span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-600">Total Pengeluaran (Rumah)</span><span id="report-nominal-pengeluaran-rumah" class="font-semibold text-red-600"></span></div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
             <!-- Halaman Produk -->
            <div id="produk" class="page">
                 <div class="w-full max-w-4xl mx-auto">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Daftar Produk</h2>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="export-produk-csv" class="text-sm font-semibold text-emerald-600 bg-emerald-100 hover:bg-emerald-200 rounded-lg px-3 py-2 whitespace-nowrap">Export</button>
                            <button id="import-produk-csv" class="text-sm font-semibold text-sky-600 bg-sky-100 hover:bg-sky-200 rounded-lg px-3 py-2 whitespace-nowrap">Import</button>
                            <input type="file" id="produk-csv-file-input" class="hidden" accept=".csv">
                            <button id="btn-add-produk" class="bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Tambah Produk
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                        <div class="bg-white rounded-xl border border-gray-200 p-3">
                            <h3 class="text-xs font-medium text-gray-500">Total Stok Produk</h3>
                            <p id="total-stok-produk" class="text-xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-3">
                            <h3 class="text-xs font-medium text-gray-500">Total Aset Produk</h3>
                            <p id="total-aset-produk" class="text-xl font-bold text-gray-900 mt-1">Rp 0</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200">
                        <div id="produk-list-container" class="overflow-y-auto" style="max-height: 50vh;">
                            <!-- Daftar produk akan dirender di sini -->
                        </div>
                    </div>
                </div>
            </div>
             <!-- Halaman Hutang -->
            <div id="hutang" class="page">
                 <div class="w-full max-w-4xl mx-auto">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Daftar Hutang (Belum Lunas)</h2>
                        <button id="btn-add-hutang" class="bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center whitespace-nowrap">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Tambah Hutang
                        </button>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 mb-6">
                        <div id="hutang-list-container" class="overflow-y-auto">
                            <!-- Daftar hutang belum lunas -->
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Riwayat Hutang (Lunas)</h2>
                        <button id="toggle-lunas-history" class="text-sm font-semibold text-sky-600 px-3 py-1 rounded-lg hover:bg-sky-100">
                            Tampilkan
                        </button>
                    </div>
                    <div id="hutang-lunas-wrapper" class="bg-white rounded-xl border border-gray-200 hidden">
                        <div id="hutang-lunas-list-container" class="overflow-y-auto">
                            <!-- Daftar hutang lunas -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Halaman Pengaturan -->
            <div id="pengaturan" class="page">
                <!-- Menu Utama Pengaturan (Lebar Konten Disesuaikan) -->
                <div id="pengaturan-main" class="sub-page active flex-col">
                     <div class="w-full max-w-4xl xl:max-w-6xl mx-auto space-y-6">
                        <div>
                            <h2 class="text-sm font-semibold text-gray-500 mb-2 px-1">Master Data</h2>
                            <div class="bg-white rounded-xl border border-gray-200">
                                <a href="#" data-subpage="pengaturan-kategori" class="sub-nav-item flex items-center p-4 border-b border-gray-200">
                                    <svg class="w-6 h-6 text-sky-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h2zm0 0V3m0 4v.01M17 13v-3a2 2 0 00-2-2h-2m8 8h-3a2 2 0 01-2-2v-3a2 2 0 012-2h3v5a2 2 0 01-2 2zm-4-4v.01"></path></svg>
                                    <span class="flex-1 font-medium text-gray-800">Kelola Kategori</span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </a>
                                 <a href="#" data-subpage="pengaturan-akun" class="sub-nav-item flex items-center p-4 border-b border-gray-200">
                                    <svg class="w-6 h-6 text-sky-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                                    <span class="flex-1 font-medium text-gray-800">Kelola Akun</span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </a>
                                 <a href="#" data-subpage="pengaturan-aplikasi" class="sub-nav-item flex items-center p-4 border-b border-gray-200">
                                    <svg class="w-6 h-6 text-sky-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                    <span class="flex-1 font-medium text-gray-800">Kelola Aplikasi</span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </a>
                                <a href="#" data-subpage="pengaturan-pengguna" class="sub-nav-item flex items-center p-4">
                                    <svg class="w-6 h-6 text-sky-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.122-1.28-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.122-1.28.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    <span class="flex-1 font-medium text-gray-800">Kelola Pengguna</span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </a>
                            </div>
                        </div>

                        <div>
                            <h2 class="text-sm font-semibold text-gray-500 mb-2 px-1">Utilitas</h2>
                             <div class="bg-white rounded-xl border border-gray-200 p-4">
                                <p class="font-medium mb-3">Backup & Restore (Semua Data)</p>
                                <div class="flex space-x-2">
                                    <button id="export-all-data" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 text-white font-semibold py-2 px-3 rounded-lg hover:opacity-90 transition-opacity text-sm flex items-center justify-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
                                        Share Backup
                                    </button>
                                    <button id="import-all-data" class="flex-1 bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-semibold py-2 px-3 rounded-lg hover:opacity-90 transition-opacity text-sm flex items-center justify-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                        Import Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sub-halaman CRUD akan ada di sini -->
                <div id="pengaturan-kategori" class="sub-page crud-page flex-col" data-type="kategori"><div class="w-full max-w-4xl xl:max-w-6xl mx-auto"><div class="flex justify-between items-center mb-4"><button class="back-to-settings text-sky-500 font-medium">&larr; Kembali</button><h2 class="text-lg font-semibold">Kelola Kategori</h2><button class="btn-add bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1 px-3 rounded-lg text-sm">Tambah</button></div><div class="bg-white p-4 rounded-xl border border-gray-200"><ul class="divide-y divide-gray-200 list-container"></ul></div></div></div>
                <div id="pengaturan-akun" class="sub-page crud-page flex-col" data-type="akun"><div class="w-full max-w-4xl xl:max-w-6xl mx-auto"><div class="flex justify-between items-center mb-4"><button class="back-to-settings text-sky-500 font-medium">&larr; Kembali</button><h2 class="text-lg font-semibold">Kelola Akun</h2><button class="btn-add bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1 px-3 rounded-lg text-sm">Tambah</button></div><div class="bg-white p-4 rounded-xl border border-gray-200"><ul class="divide-y divide-gray-200 list-container"></ul></div></div></div>
                <div id="pengaturan-aplikasi" class="sub-page crud-page flex-col" data-type="aplikasi"><div class="w-full max-w-4xl xl:max-w-6xl mx-auto"><div class="flex justify-between items-center mb-4"><button class="back-to-settings text-sky-500 font-medium">&larr; Kembali</button><h2 class="text-lg font-semibold">Kelola Aplikasi</h2><button class="btn-add bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1 px-3 rounded-lg text-sm">Tambah</button></div><div class="bg-white p-4 rounded-xl border border-gray-200"><ul class="divide-y divide-gray-200 list-container"></ul></div></div></div>
                <div id="pengaturan-pengguna" class="sub-page crud-page flex-col" data-type="pengguna"><div class="w-full max-w-4xl xl:max-w-6xl mx-auto"><div class="flex justify-between items-center mb-4"><button class="back-to-settings text-sky-500 font-medium">&larr; Kembali</button><h2 class="text-lg font-semibold">Kelola Pengguna</h2><button class="btn-add bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1 px-3 rounded-lg text-sm">Tambah</button></div><div class="bg-white p-4 rounded-xl border border-gray-200"><ul class="divide-y divide-gray-200 list-container"></ul></div></div></div>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation (Padding disesuaikan dengan sidebar) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm border-t border-gray-200 z-50 lg:pl-[25%]">
        <div class="flex justify-around text-gray-500">
            <a href="#" data-page="dasbor" class="nav-item flex-1 p-3 lg:py-2 text-center"><div class="flex flex-col items-center"><svg class="w-6 h-6 mb-1 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span class="text-xs nav-text font-medium">Dasbor</span></div></a>
            <a href="#" data-page="kasir" class="nav-item flex-1 p-3 lg:py-2 text-center"><div class="flex flex-col items-center"><svg class="w-6 h-6 mb-1 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4z"></path></svg><span class="text-xs nav-text font-medium">Kasir</span></div></a>
            <a href="#" data-page="transaksi" class="nav-item flex-1 p-3 lg:py-2 text-center"><div class="flex flex-col items-center"><svg class="w-6 h-6 mb-1 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="text-xs nav-text font-medium">Transaksi</span></div></a>
            <a href="#" data-page="produk" class="nav-item flex-1 p-3 lg:py-2 text-center"><div class="flex flex-col items-center"><svg class="w-6 h-6 mb-1 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg><span class="text-xs nav-text font-medium">Produk</span></div></a>
            <a href="#" data-page="hutang" class="nav-item flex-1 p-3 lg:py-2 text-center"><div class="flex flex-col items-center"><svg class="w-6 h-6 mb-1 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg><span class="text-xs nav-text font-medium">Hutang</span></div></a>
            <a href="#" data-page="laporan" class="nav-item flex-1 p-3 lg:py-2 text-center"><div class="flex flex-col items-center"><svg class="w-6 h-6 mb-1 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><span class="text-xs nav-text font-medium">Laporan</span></div></a>
            <a href="#" data-page="pengaturan" class="nav-item flex-1 p-3 lg:py-2 text-center"><div class="flex flex-col items-center"><svg class="w-6 h-6 mb-1 lg:w-5 lg:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span class="text-xs nav-text font-medium">Pengaturan</span></div></a>
        </div>
    </nav>
    
    <!-- Modal untuk Tambah/Ubah Data Master -->
    <div id="form-modal" class="modal-container fixed inset-0 z-[51] items-center justify-center">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-4 w-full max-w-sm m-4 z-10">
            <h3 id="modal-title" class="text-base font-bold mb-3">Modal Title</h3>
            <form id="modal-form">
                <div>
                    <label id="modal-label" for="modal-input" class="block text-xs font-medium text-gray-600">Nama</label>
                    <input type="text" id="modal-input" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" id="modal-cancel" class="bg-gray-200 text-gray-800 font-semibold py-1.5 px-3 text-sm rounded-lg">Batal</button>
                    <button type="submit" class="bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1.5 px-3 text-sm rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal untuk Produk -->
    <div id="produk-modal" class="modal-container fixed inset-0 z-[51] items-center justify-center">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-4 w-full max-w-sm m-4 z-10">
            <h3 id="produk-modal-title" class="text-base font-bold mb-3">Tambah Produk</h3>
            <form id="produk-form" class="space-y-3">
                <input type="hidden" id="produk-edit-id">
                <div>
                    <label for="produk-nama" class="block text-xs font-medium text-gray-600">Nama Produk</label>
                    <input type="text" id="produk-nama" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div>
                    <label for="produk-harga-modal" class="block text-xs font-medium text-gray-600">Harga Modal</label>
                    <input type="number" id="produk-harga-modal" placeholder="0" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div>
                    <label for="produk-harga-jual" class="block text-xs font-medium text-gray-600">Harga Jual</label>
                    <input type="number" id="produk-harga-jual" placeholder="0" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div>
                    <label for="produk-stok" class="block text-xs font-medium text-gray-600">Stok</label>
                    <input type="number" id="produk-stok" placeholder="0" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div class="flex justify-end space-x-2 pt-3">
                    <button type="button" id="produk-modal-cancel" class="bg-gray-200 text-gray-800 font-semibold py-1.5 px-3 text-sm rounded-lg">Batal</button>
                    <button type="submit" class="bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1.5 px-3 text-sm rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

     <!-- Modal untuk Hutang -->
    <div id="hutang-modal" class="modal-container fixed inset-0 z-[51] items-center justify-center">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-4 w-full max-w-sm m-4 z-10">
            <h3 id="hutang-modal-title" class="text-base font-bold mb-3">Tambah Hutang</h3>
            <form id="hutang-form" class="space-y-3">
                <input type="hidden" id="hutang-edit-id">
                 <div>
                    <label for="hutang-tanggal" class="block text-xs font-medium text-gray-600">Tanggal</label>
                    <input type="date" id="hutang-tanggal" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div>
                    <label for="hutang-nama" class="block text-xs font-medium text-gray-600">Nama</label>
                    <input type="text" id="hutang-nama" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div>
                    <label for="hutang-nominal" class="block text-xs font-medium text-gray-600">Nominal</label>
                    <input type="number" id="hutang-nominal" placeholder="0" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div>
                    <label for="hutang-catatan" class="block text-xs font-medium text-gray-600">Catatan</label>
                    <input type="text" id="hutang-catatan" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div class="flex justify-end space-x-2 pt-3">
                    <button type="button" id="hutang-modal-cancel" class="bg-gray-200 text-gray-800 font-semibold py-1.5 px-3 text-sm rounded-lg">Batal</button>
                    <button type="submit" class="bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1.5 px-3 text-sm rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Transaksi -->
    <div id="transaksi-modal" class="modal-container fixed inset-0 z-[51] items-center justify-center">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-4 w-full max-w-sm m-4 z-10 overflow-y-auto max-h-[90vh]">
            <h3 id="transaksi-modal-title" class="text-base font-bold mb-3">Tambah Transaksi</h3>
            <form id="transaksi-form" class="space-y-3">
                 <input type="hidden" id="transaksi-edit-id">
                 <div>
                    <label for="transaksi-jenis-select" class="block text-xs font-medium text-gray-600">Jenis Transaksi</label>
                    <select id="transaksi-jenis-select" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        <option value="Pemasukan">Pemasukan</option>
                        <option value="Pengeluaran">Pengeluaran</option>
                        <option value="Transfer">Transfer</option>
                        <option value="Dana">Trx.</option>
                    </select>
                </div>
                <div>
                    <label for="transaksi-tanggal" class="block text-xs font-medium text-gray-600">Tanggal</label>
                    <input type="date" id="transaksi-tanggal" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div id="kategori-field" class="form-field">
                    <label for="transaksi-kategori" class="block text-xs font-medium text-gray-600">Kategori</label>
                    <select id="transaksi-kategori" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required></select>
                </div>
                <div id="akun-field" class="form-field">
                    <label for="transaksi-akun" class="block text-xs font-medium text-gray-600">Akun</label>
                    <select id="transaksi-akun" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required></select>
                </div>
                <div id="transfer-fields" class="form-field hidden space-y-3">
                    <div>
                        <label for="transaksi-akun-dari" class="block text-xs font-medium text-gray-600">Dari Akun</label>
                        <select id="transaksi-akun-dari" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    </div>
                    <div>
                        <label for="transaksi-akun-ke" class="block text-xs font-medium text-gray-600">Ke Akun</label>
                        <select id="transaksi-akun-ke" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    </div>
                </div>
                 <div id="dana-opsi-field" class="form-field hidden">
                     <label class="block text-xs font-medium text-gray-600">Opsi Biaya</label>
                     <div class="mt-1 flex space-x-4">
                        <label class="inline-flex items-center text-sm"><input type="radio" name="transaksi-dana-opsi" value="Admin Bayar" class="form-radio text-sky-500" checked> <span class="ml-1.5">Admin Bayar</span></label>
                        <label class="inline-flex items-center text-sm"><input type="radio" name="transaksi-dana-opsi" value="Admin Potong" class="form-radio text-rose-500"> <span class="ml-1.5">Admin Potong</span></label>
                    </div>
                </div>
                <div>
                    <label for="transaksi-jumlah" class="block text-xs font-medium text-gray-600">Jumlah Nominal</label>
                    <input type="number" id="transaksi-jumlah" placeholder="0" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                </div>
                <div id="fee-dana-field" class="form-field hidden">
                    <label for="transaksi-fee-dana" class="block text-xs font-medium text-gray-600">Fee Dana</label>
                    <input type="number" id="transaksi-fee-dana" placeholder="0" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                 <div>
                    <label for="transaksi-keterangan" class="block text-xs font-medium text-gray-600">Keterangan</label>
                    <input type="text" id="transaksi-keterangan" class="mt-1 block w-full bg-gray-100 border-transparent rounded-lg py-1.5 px-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="flex justify-end space-x-2 pt-3">
                    <button type="button" id="transaksi-modal-cancel" class="bg-gray-200 text-gray-800 font-semibold py-1.5 px-3 text-sm rounded-lg">Batal</button>
                    <button type="submit" id="transaksi-modal-save" class="bg-gradient-to-r from-sky-500 to-cyan-500 text-white font-semibold py-1.5 px-3 text-sm rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal untuk Konfirmasi Hapus -->
    <div id="delete-modal" class="modal-container fixed inset-0 z-[52] items-center justify-center">
         <div class="modal-backdrop fixed inset-0"></div>
         <div class="modal-content bg-white rounded-lg shadow-xl p-4 w-full max-w-sm m-4 z-10 text-center">
            <h3 class="text-base font-bold mb-2">Anda Yakin?</h3>
            <p id="delete-modal-text" class="text-sm text-gray-500 mb-4"></p>
            <div class="flex justify-center space-x-2">
                <button id="delete-cancel" class="flex-1 bg-gray-200 font-semibold py-1.5 px-3 text-sm rounded-lg">Batal</button>
                <button id="delete-confirm" class="flex-1 bg-gradient-to-r from-rose-500 to-red-500 text-white font-semibold py-1.5 px-3 text-sm rounded-lg">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Fallback Export -->
    <div id="backup-modal" class="modal-container fixed inset-0 z-[52] items-center justify-center">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-4 w-full max-w-lg m-4 z-10 flex flex-col max-h-[90vh]">
            <h3 id="backup-modal-title" class="text-base font-bold mb-3">Export Data</h3>
            <textarea id="backup-data-area" class="w-full flex-grow bg-gray-100 border-gray-300 rounded-lg p-2 text-xs font-mono" readonly></textarea>
            <div id="copy-feedback" class="text-center text-sm text-green-600 mt-2 h-5"></div>
            <div class="flex justify-end space-x-2 mt-4">
                <button type="button" id="backup-modal-cancel" class="bg-gray-200 text-gray-800 font-semibold py-1.5 px-3 text-sm rounded-lg">Tutup</button>
                <button type="button" id="backup-modal-copy" class="bg-sky-500 text-white font-semibold py-1.5 px-3 text-sm rounded-lg">Salin ke Clipboard</button>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Tentang Aplikasi -->
    <div id="about-modal" class="modal-container fixed inset-0 z-[52] items-center justify-center">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-4 w-full max-w-sm m-4 z-10 text-center">
            <h3 class="text-base font-bold mb-2">Nusadua Store</h3>
            <p class="text-xs text-gray-600 mb-3">
                Aplikasi Keuangan v1.0<br>
                Dibuat untuk membantu manajemen keuangan pribadi dan usaha kecil.
            </p>
            <p class="text-xs text-gray-400 mb-4">
                 2025 - Dibuat oleh Galih Ashar.
            </p>
            <div class="flex justify-center">
                <button id="about-modal-close" class="bg-sky-500 text-white font-semibold py-1.5 px-6 text-sm rounded-lg">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Input file tersembunyi untuk Import -->
    <input type="file" id="import-json-input" class="hidden" accept=".json,.txt">

    <script>
        // PWA Registration Script
        window.addEventListener('load', () => {
            const manifest = {
                "name": "Nusadua Store", "short_name": "Nusadua Store", "start_url": ".", "display": "standalone",
                "background_color": "#f3f4f6", "theme_color": "#0ea5e9", "description": "Aplikasi untuk manajemen data master.",
                "icons": [ { "src": "logo.png", "type": "image/png", "sizes": "192x192" }, { "src": "logo.png", "type": "image/png", "sizes": "512x512" } ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-link').setAttribute('href', manifestUrl);
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DATA MANAGEMENT ---
        let appData = {};
        let keranjang = [];
        let revenueChartInstance = null;
        let salesChartInstance = null;
        let dateFilter = { type: 'month' }; // 'all', 'today', 'month', 'year', 'custom'

        const initialData = {
            kategori: { title: "Kategori", items: ["Order Kuota", "Dana", "Go-Pay", "Shopee-Pay", "Kas / Cash", "Modal", "Laba Bersih", "Fee BRI Link", "I-Simple", "Digipos", "Hutang", "BNI", "BRI Nussa", "BRI Galih", "Pemasukan", "Pengeluaran", "Penyesuaian", "Penjualan ATK", "Service", "Tabungan", "Save Plus", "Pengeluaran Rumah", "Transfer", "Tarik Tunai", "Setor Tunai", "APK", "Kulak (SP/Voucher/dll)"] },
            akun: { 
                title: "Akun", 
                items: [ 
                    { name: "Cash", balance: 0 }, { name: "BRI Galih", balance: 0 }, { name: "BRI Nussa", balance: 0 },
                    { name: "BNI", balance: 0 }, { name: "Bank Jateng", balance: 0 }, { name: "Buku Warung", balance: 0 },
                    { name: "DANA Galih", balance: 0 }, { name: "DANA Nussa", balance: 0 }, { name: "Shopee Pay", balance: 0 },
                    { name: "Go-Pay", balance: 0 }, { name: "Order Kuota", balance: 0 }, { name: "Digipos", balance: 0 },
                    { name: "Save Plus", balance: 0 }, { name: "I-Simple", balance: 0 }, { name: "Tabungan", balance: 0 },
                    { name: "Laba Bersih", balance: 0 }, { name: "Fee BRI Link", balance: 0 }, { name: "Hutang", balance: 0 },
                    { name: "Modal", balance: 0 }
                ] 
            },
            aplikasi: { title: "Aplikasi", items: ["Dana", "Digipos", "I-Simple", "Gopay", "Save Plus", "Shopee Pay", "Buku Warung/Agen", "OVO", "Order Kuota"] },
            pengguna: { title: "Pengguna", items: ["Admin", "Kasir 1", "Kasir 2"] },
            produk: { title: "Produk", items: [] },
            transaksi: { title: "Transaksi", items: [] },
            hutang: { title: "Hutang", items: [] }
        };

        function saveData() {
            localStorage.setItem('appData', JSON.stringify(appData));
        }

        function loadData() {
            const savedData = localStorage.getItem('appData');
            if (savedData) {
                appData = JSON.parse(savedData);
                 if (!appData.produk) appData.produk = { title: "Produk", items: [] };
                if (!appData.transaksi) appData.transaksi = { title: "Transaksi", items: [] };
                if (!appData.hutang) appData.hutang = { title: "Hutang", items: [] };
            } else {
                 appData = JSON.parse(JSON.stringify(initialData));
            }
        }

        // --- UI RENDERING ---
        function renderAll() {
            renderAllLists();
            renderAccountSidebar();
            renderTransaksiList();
            renderProdukList();
            renderProdukSummary();
            renderKasirDropdowns();
            renderKeranjang();
            renderKasirRiwayat();
            renderHutangLists();
            renderDashboard();
            renderLaporanPage();
        }

        function renderAllLists() {
            document.querySelectorAll('.crud-page').forEach(page => {
                const type = page.dataset.type;
                if (appData[type]) {
                    renderList(type, page.querySelector('.list-container'));
                }
            });
        }
        
        function renderLaporanPage() {
            const allTransactions = appData.transaksi.items;
            const salesTransactions = allTransactions.filter(t => t.kategori === 'Penjualan');
            const financialTransactions = allTransactions.filter(t => t.kategori !== 'Penjualan');
            const allHutang = appData.hutang.items;

            // --- Calculations ---
            let produkTerjualCount = 0;
            let jasaTerjualCount = 0;
            let totalNilaiPenjualan = 0;
            let totalModalPenjualan = 0;
            let totalLabaProduk = 0;
            let totalLabaJasa = 0;
            let totalLabaAplikasi = 0;
            let totalPenjualanProduk = 0;
            let totalPenjualanJasa = 0;
            let totalPenjualanAplikasi = 0;

            salesTransactions.forEach(trx => {
                totalNilaiPenjualan += trx.jumlah;
                trx.items.forEach(item => {
                    const itemLaba = (item.harga * item.jumlah) - ((item.hargaModal || 0) * item.jumlah);
                    totalModalPenjualan += (item.hargaModal || 0) * item.jumlah;
                    const itemJual = item.harga * item.jumlah;

                    if (item.type === 'produk') {
                        produkTerjualCount += item.jumlah;
                        totalLabaProduk += itemLaba;
                        totalPenjualanProduk += itemJual;
                    } else if (item.type === 'jasa') {
                        jasaTerjualCount += item.jumlah;
                        totalLabaJasa += itemLaba;
                        totalPenjualanJasa += itemJual;
                    } else if (item.type === 'aplikasi') {
                        totalLabaAplikasi += itemLaba;
                        totalPenjualanAplikasi += itemJual;
                    }
                });
            });

            const totalPemasukanLainnya = financialTransactions
                .filter(t => t.jenis === 'pemasukan')
                .reduce((sum, t) => sum + t.jumlah, 0);

            const totalPengeluaran = financialTransactions
                .filter(t => t.jenis === 'pengeluaran')
                .reduce((sum, t) => sum + t.jumlah, 0);
                
            const hutangAktif = allHutang.filter(h => h.status === 'Belum Lunas');
            const totalHutangAktif = hutangAktif.reduce((sum, h) => sum + h.nominal, 0);
            const jumlahPenghutang = new Set(hutangAktif.map(h => h.nama.toLowerCase())).size;

            const totalPendapatan = totalNilaiPenjualan + totalPemasukanLainnya;
            const totalBeban = totalModalPenjualan + totalPengeluaran;
            const labaKotor = totalPendapatan - totalBeban;
            const totalLabaPenjualan = totalLabaProduk + totalLabaJasa + totalLabaAplikasi;

            // Laporan Transaksi Keuangan
            const totalTransaksiKeuangan = financialTransactions.length;
            const nominalLabaBersih = financialTransactions
                .filter(t => t.kategori === 'Laba Bersih' && t.jenis === 'pemasukan')
                .reduce((sum, t) => sum + t.jumlah, 0);
            const nominalPengeluaranRumah = financialTransactions
                .filter(t => t.kategori === 'Pengeluaran Rumah' && t.jenis === 'pengeluaran')
                .reduce((sum, t) => sum + t.jumlah, 0);


            // --- Update UI ---
            // Laba Rugi
            document.getElementById('report-total-penjualan').textContent = formatCurrency(totalNilaiPenjualan);
            document.getElementById('report-total-pemasukan').textContent = formatCurrency(totalPemasukanLainnya);
            document.getElementById('report-total-pendapatan').textContent = formatCurrency(totalPendapatan);
            document.getElementById('report-total-modal').textContent = formatCurrency(totalModalPenjualan);
            document.getElementById('report-total-pengeluaran').textContent = formatCurrency(totalPengeluaran);
            document.getElementById('report-total-beban').textContent = formatCurrency(totalBeban);
            document.getElementById('report-laba-kotor').textContent = formatCurrency(labaKotor);
            
            // Rincian Penjualan
            document.getElementById('report-produk-terjual').textContent = `${produkTerjualCount.toLocaleString('id-ID')} unit`;
            document.getElementById('report-jasa-terjual').textContent = `${jasaTerjualCount.toLocaleString('id-ID')} unit`;
            document.getElementById('report-penjualan-produk').textContent = formatCurrency(totalPenjualanProduk);
            document.getElementById('report-penjualan-jasa').textContent = formatCurrency(totalPenjualanJasa);
            document.getElementById('report-laba-produk').textContent = formatCurrency(totalLabaProduk);
            document.getElementById('report-laba-jasa').textContent = formatCurrency(totalLabaJasa);
            document.getElementById('report-penjualan-aplikasi').textContent = formatCurrency(totalPenjualanAplikasi);
            document.getElementById('report-laba-aplikasi').textContent = formatCurrency(totalLabaAplikasi);
            document.getElementById('report-total-laba-penjualan').textContent = formatCurrency(totalLabaPenjualan);

            // Rincian Hutang
            document.getElementById('report-total-hutang').textContent = formatCurrency(totalHutangAktif);
            document.getElementById('report-jumlah-penghutang').textContent = `${jumlahPenghutang.toLocaleString('id-ID')} orang`;
        
            // Laporan Transaksi Keuangan
            document.getElementById('report-total-transaksi-keuangan').textContent = `${totalTransaksiKeuangan.toLocaleString('id-ID')} transaksi`;
            document.getElementById('report-nominal-laba-bersih').textContent = formatCurrency(nominalLabaBersih);
            document.getElementById('report-nominal-pengeluaran-rumah').textContent = formatCurrency(nominalPengeluaranRumah);
        }
        
        const formatCurrency = (value) => {
            const val = parseFloat(value) || 0;
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            if (val < 0) {
                return '-' + formatter.format(Math.abs(val));
            }
            return formatter.format(val);
        };

        function renderList(type, container) {
            container.innerHTML = '';

            if (type === 'akun') {
                 appData[type].items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'py-3 flex justify-between items-center';
                    li.innerHTML = `
                        <div class="flex-1 flex items-center justify-between min-w-0 mr-4">
                            <p class="font-medium text-gray-800 truncate">${item.name}</p>
                            <p class="text-sm text-gray-500 ml-4 flex-shrink-0">${formatCurrency(item.balance)}</p>
                        </div>
                        <div class="flex items-center space-x-3 flex-shrink-0">
                            <button class="btn-saldo text-xs text-sky-600 font-semibold" data-index="${index}">Saldo</button>
                            <button class="btn-edit text-amber-500 hover:text-amber-600" data-index="${index}" title="Ubah">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                            </button>
                            <button class="btn-delete text-rose-500 hover:text-rose-600" data-index="${index}" title="Hapus">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>`;
                    container.appendChild(li);
                });
            } else {
                appData[type].items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'py-3 flex justify-between items-center';
                    li.innerHTML = `<p class="font-medium text-gray-800">${item}</p>
                        <div class="flex space-x-3">
                            <button class="btn-edit text-amber-500 hover:text-amber-600" data-index="${index}" title="Ubah">
                                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                            </button>
                            <button class="btn-delete text-rose-500 hover:text-rose-600" data-index="${index}" title="Hapus">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>`;
                    container.appendChild(li);
                });
            }
        }

        function renderAccountSidebar() {
            const container = document.getElementById('account-sidebar-list');
            container.innerHTML = '';
            
            const feeBriLinkAkun = appData.akun.items.find(item => item.name === "Fee BRI Link");
            const feeBriLinkSaldo = feeBriLinkAkun ? feeBriLinkAkun.balance : 0;

            const accountsToDisplay = appData.akun.items.filter(item => item.name !== "Fee BRI Link");

            accountsToDisplay.forEach(item => {
                let displayBalance = item.balance;
                
                if (item.name === "BRI Nussa") {
                    displayBalance += feeBriLinkSaldo;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center text-xs p-2 hover:bg-slate-700';
                itemDiv.innerHTML = `
                    <span class="font-medium text-gray-300 truncate">${item.name}</span>
                    <span class="text-gray-400 font-semibold">${formatCurrency(displayBalance)}</span>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function filterTransactionsByDate(transactions) {
            if (dateFilter.type === 'all') {
                return transactions;
            }
            return transactions.filter(t => {
                const trxDate = new Date(t.tanggal);
                return trxDate >= dateFilter.start && trxDate <= dateFilter.end;
            });
        }
        
        function renderDashboard() {
            const filteredTransactions = filterTransactionsByDate(appData.transaksi.items);

            const totalSaldoCard = document.getElementById('total-saldo-card');
            const totalCashCard = document.getElementById('total-cash-card');
            const modalSaldoCard = document.getElementById('modal-saldo-card');
            const totalLabaBersihCard = document.getElementById('total-laba-bersih-card');
            const pengeluaranCard = document.getElementById('pengeluaran-card');

            // Analisa Khusus cards
            const feeBriLinkCard = document.getElementById('fee-bri-link-card');
            const briNussaCard = document.getElementById('bri-nussa-card');
            const tabunganCard = document.getElementById('tabungan-card');
            const labaBersihCard = document.getElementById('laba-bersih-card');
            const pengeluaranRumahCard = document.getElementById('pengeluaran-rumah-card');
            const hutangCard = document.getElementById('hutang-card');

            // Analisa Penjualan cards
            const produkTerjualCard = document.getElementById('produk-terjual-card');
            const jasaTerjualCard = document.getElementById('jasa-terjual-card');
            const labaTransaksiCard = document.getElementById('laba-transaksi-card');
            const labaPenjualanFilterCard = document.getElementById('laba-penjualan-filter-card');
            const labaProdukCard = document.getElementById('laba-produk-card');
            const labaJasaCard = document.getElementById('laba-jasa-card');
            const labaAplikasiCard = document.getElementById('laba-aplikasi-card');

            if (!appData.akun || !appData.akun.items || !appData.transaksi) return;

            // --- Analisa Umum (Sebagian tidak difilter) ---
            const totalSaldo = appData.akun.items.reduce((sum, akun) => sum + akun.balance, 0);
            totalSaldoCard.innerHTML = `
                <h3 class="text-xs font-medium text-blue-200">Total Saldo</h3>
                <p class="text-xl font-bold text-white mt-1">${formatCurrency(totalSaldo)}</p>
            `;

            // 2. Total Cash (dihitung dari jumlah akun Cash, Laba Bersih, Modal dan tabungan)
            const cashAccounts = ["Cash", "Laba Bersih", "Tabungan", "Modal"];
            const totalCash = appData.akun.items
                .filter(akun => cashAccounts.includes(akun.name))
                .reduce((sum, akun) => sum + akun.balance, 0);
            totalCashCard.innerHTML = `
                <h3 class="text-xs font-medium text-emerald-200">Total Uang Tunai</h3>
                <p class="text-xl font-bold text-white mt-1">${formatCurrency(totalCash)}</p>
            `;

            // 3. Saldo akun Modal
            const modalAkun = appData.akun.items.find(akun => akun.name === "Modal");
            const modalSaldo = modalAkun ? modalAkun.balance : 0;
            modalSaldoCard.innerHTML = `
                <h3 class="text-xs font-medium text-indigo-200">Saldo Modal</h3>
                <p class="text-xl font-bold text-white mt-1">${formatCurrency(modalSaldo)}</p>
            `;

            // --- Analisa Khusus (Sebagian tidak difilter) ---
            const feeBriLinkAkun = appData.akun.items.find(akun => akun.name === "Fee BRI Link");
            const feeBriLinkSaldo = feeBriLinkAkun ? feeBriLinkAkun.balance : 0;
            feeBriLinkCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Fee BRI Link</h3>
                <p class="text-xl font-bold text-cyan-800 mt-1">${formatCurrency(feeBriLinkSaldo)}</p>
            `;

            const briNussaAkun = appData.akun.items.find(akun => akun.name === "BRI Nussa");
            const briNussaSaldo = briNussaAkun ? briNussaAkun.balance : 0;
            briNussaCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">BRI Nussa</h3>
                <p class="text-xl font-bold text-sky-800 mt-1">${formatCurrency(briNussaSaldo)}</p>
            `;

            const tabunganAkun = appData.akun.items.find(akun => akun.name === "Tabungan");
            const tabunganSaldo = tabunganAkun ? tabunganAkun.balance : 0;
            tabunganCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Tabungan</h3>
                <p class="text-xl font-bold text-amber-800 mt-1">${formatCurrency(tabunganSaldo)}</p>
            `;

            // --- Laba Bersih (Periode) Calculation ---
            let labaBersihPeriode = 0;
            // 1. Laba dari Penjualan (Produk, Jasa, Aplikasi)
            const salesTransactionsInPeriod = filteredTransactions.filter(t => t.kategori === 'Penjualan');
            salesTransactionsInPeriod.forEach(trx => {
                trx.items.forEach(item => {
                    const itemLaba = (item.harga * item.jumlah) - ((item.hargaModal || 0) * item.jumlah);
                    labaBersihPeriode += itemLaba;
                });
            });
            // 2. Laba dari Transaksi Keuangan (cth: Fee Dana)
            const labaTransaksiLainnya = filteredTransactions
                .filter(t => t.kategori === 'Laba Bersih' && t.jenis === 'pemasukan')
                .reduce((sum, t) => sum + t.jumlah, 0);
            labaBersihPeriode += labaTransaksiLainnya;
            // 3. Laba dari fee transaksi Dana
            const labaDana = filteredTransactions
                .filter(t => t.jenis === 'dana')
                .reduce((sum, t) => sum + (t.fee || 0), 0);
            labaBersihPeriode += labaDana;
            
            labaBersihCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Laba Bersih (Periode)</h3>
                <p class="text-xl font-bold text-lime-800 mt-1">${formatCurrency(labaBersihPeriode)}</p>
            `;
            
            const hutangAkun = appData.akun.items.find(akun => akun.name === "Hutang");
            const hutangSaldo = hutangAkun ? hutangAkun.balance : 0;
            hutangCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Akun Hutang</h3>
                <p class="text-xl font-bold text-fuchsia-800 mt-1">${formatCurrency(hutangSaldo)}</p>
            `;

            // --- Hutang Aktif Card ---
            const hutangAktifCard = document.getElementById('hutang-aktif-card');
            const hutangBelumLunas = appData.hutang.items
                .filter(item => item.status === 'Belum Lunas')
                .sort((a, b) => b.id - a.id) // Urutkan dari yang terbaru
                .slice(0, 5);

            if (hutangAktifCard) {
                let contentHTML = '<h3 class="text-xs font-medium text-gray-500">5 Hutang Aktif Terakhir</h3>';
                if (hutangBelumLunas.length === 0) {
                    contentHTML += `
                        <div class="flex flex-col items-center justify-center h-full text-center text-gray-400 pt-4">
                            <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p class="text-sm">Tidak ada hutang aktif.</p>
                        </div>`;
                } else {
                    contentHTML += '<ul class="divide-y divide-gray-100 mt-2">';
                    hutangBelumLunas.forEach(item => {
                        contentHTML += `
                            <li class="py-1.5 flex justify-between items-center text-sm">
                                <span class="font-semibold text-gray-700 truncate pr-2">${item.nama}</span>
                                <span class="font-bold text-red-600 ml-2 whitespace-nowrap">${formatCurrency(item.nominal)}</span>
                            </li>
                        `;
                    });
                    contentHTML += '</ul>';
                }
                hutangAktifCard.innerHTML = contentHTML;
            }


            // --- Metrik Berbasis Transaksi (DIFILTER) ---

            const totalPengeluaranRumah = filteredTransactions
                .filter(t => t.kategori === 'Pengeluaran Rumah')
                .reduce((sum, t) => sum + t.jumlah, 0);
            pengeluaranRumahCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Pengeluaran Rumah (Periode)</h3>
                <p class="text-xl font-bold text-rose-800 mt-1">${formatCurrency(totalPengeluaranRumah)}</p>
            `;

            const salesTransactions = filteredTransactions.filter(t => t.kategori === 'Penjualan');
            
            let produkTerjualCount = 0;
            let jasaTerjualCount = 0;
            let labaProduk = 0;
            let labaJasa = 0;
            let labaAplikasi = 0;

            salesTransactions.forEach(trx => {
                trx.items.forEach(item => {
                    const itemLaba = (item.harga * item.jumlah) - ((item.hargaModal || 0) * item.jumlah);
                    if (item.type === 'produk') {
                        produkTerjualCount += item.jumlah;
                        labaProduk += itemLaba;
                    } else if (item.type === 'jasa') {
                        jasaTerjualCount += item.jumlah;
                        labaJasa += itemLaba;
                    } else if (item.type === 'aplikasi') {
                        labaAplikasi += itemLaba;
                    }
                });
            });

            produkTerjualCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Produk Terjual</h3>
                <p class="text-xl font-bold text-gray-900 mt-1">${produkTerjualCount}</p>
            `;
            
            jasaTerjualCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Jasa Terjual</h3>
                <p class="text-xl font-bold text-gray-900 mt-1">${jasaTerjualCount}</p>
            `;

            labaProdukCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Laba Produk</h3>
                <p class="text-xl font-bold text-green-600 mt-1">${formatCurrency(labaProduk)}</p>
            `;

            labaJasaCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Laba Jasa</h3>
                <p class="text-xl font-bold text-green-600 mt-1">${formatCurrency(labaJasa)}</p>
            `;

            labaAplikasiCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Laba Aplikasi</h3>
                <p class="text-xl font-bold text-green-600 mt-1">${formatCurrency(labaAplikasi)}</p>
            `;

            const labaDariKategoriBersih = filteredTransactions
                .filter(t => t.kategori === 'Laba Bersih')
                .reduce((sum, t) => sum + t.jumlah, 0);
            const labaDariFeeDana = filteredTransactions
                .filter(t => t.jenis === 'dana')
                .reduce((sum, t) => sum + (t.fee || 0), 0);
            const totalLabaTransaksi = labaDariKategoriBersih + labaDariFeeDana;
            labaTransaksiCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Laba Transaksi</h3>
                <p class="text-xl font-bold text-green-600 mt-1">${formatCurrency(totalLabaTransaksi)}</p>
            `;
            
            // --- Total Laba Penjualan (berdasarkan filter) ---
            const totalLabaPenjualanFilter = labaProduk + labaJasa + labaAplikasi + totalLabaTransaksi;
            labaPenjualanFilterCard.innerHTML = `
                <h3 class="text-xs font-medium text-gray-500">Total Laba Keseluruhan (Periode)</h3>
                <p class="text-xl font-bold text-green-600 mt-1">${formatCurrency(totalLabaPenjualanFilter)}</p>
            `;


            const totalPendapatan = filteredTransactions
                .filter(t => t.jenis === 'pemasukan')
                .reduce((sum, t) => sum + t.jumlah, 0);
            
            const labaBersihAkunDashboard = appData.akun.items.find(akun => akun.name === "Laba Bersih");
            const totalLabaBersih = labaBersihAkunDashboard ? labaBersihAkunDashboard.balance : 0;
            totalLabaBersihCard.innerHTML = `
                <h3 class="text-xs font-medium text-green-200">Total Laba Bersih</h3>
                <p class="text-xl font-bold text-white mt-1">${formatCurrency(totalLabaBersih)}</p>
            `;

            // Mengambil total pengeluaran rumah dari seluruh transaksi, bukan yang difilter
            const totalPengeluaranRumahSeluruhnya = appData.transaksi.items
                .filter(t => t.kategori === 'Pengeluaran Rumah')
                .reduce((sum, t) => sum + t.jumlah, 0);
            pengeluaranCard.innerHTML = `
                <h3 class="text-xs font-medium text-red-200">Pengeluaran Rumah</h3>
                <p class="text-xl font-bold text-white mt-1">${formatCurrency(totalPengeluaranRumahSeluruhnya)}</p>
            `;

            // Grafik
            renderRevenueChart(totalLabaBersih, totalPengeluaranRumahSeluruhnya);
            renderSalesChart(filteredTransactions);
        }

        function renderRevenueChart(labaBersih, pengeluaranRumah) {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            if (revenueChartInstance) {
                revenueChartInstance.destroy();
            }
            revenueChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total'],
                    datasets: [{
                        label: 'Total Laba Bersih',
                        data: [labaBersih],
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Pengeluaran Rumah',
                        data: [pengeluaranRumah],
                        backgroundColor: 'rgba(239, 68, 68, 0.5)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Laba Bersih vs Pengeluaran Rumah'
                        }
                    }
                }
            });
        }

        function renderSalesChart(filteredTransactions) {
            const ctx = document.getElementById('sales-chart').getContext('2d');
            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            let totalProdukSales = 0;
            let totalJasaSales = 0;
            let totalAplikasiSales = 0;

            const salesTransactions = filteredTransactions.filter(t => t.kategori === 'Penjualan');

            salesTransactions.forEach(trx => {
                trx.items.forEach(item => {
                    const itemTotal = item.harga * item.jumlah;
                    if (item.type === 'produk') {
                        totalProdukSales += itemTotal;
                    } else if (item.type === 'jasa') {
                        totalJasaSales += itemTotal;
                    } else if (item.type === 'aplikasi') {
                        totalAplikasiSales += itemTotal;
                    }
                });
            });

            salesChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Produk', 'Jasa', 'Aplikasi'],
                    datasets: [{
                        label: 'Penjualan',
                        data: [totalProdukSales, totalJasaSales, totalAplikasiSales],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',  // blue
                            'rgba(16, 185, 129, 0.7)', // emerald
                            'rgba(139, 92, 246, 0.7)'  // violet
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(139, 92, 246, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Komposisi Penjualan'
                        }
                    }
                }
            });
        }


        function renderTransaksiList() {
            const container = document.getElementById('transaksi-list-container');
            container.innerHTML = '';

            const transactions = appData.transaksi.items.filter(t => t.kategori !== 'Penjualan');
            if (transactions.length === 0) {
                 container.innerHTML = `<div class="text-center py-16 px-4">
                    <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <p class="text-gray-500 mt-4">Tidak ada transaksi untuk ditampilkan.</p>
                    <p class="text-sm text-gray-400 mt-1">Transaksi penjualan hanya akan muncul di halaman Kasir.</p>
                </div>`;
                return;
            }

            const displayTransactions = transactions.sort((a, b) => b.id - a.id);

            container.innerHTML = `
                <div class="grid grid-cols-12 gap-4 p-3 bg-sky-100 border-b border-sky-200 font-semibold text-xs text-sky-800 uppercase sticky top-0 z-10">
                    <div class="col-span-2 text-right">Waktu</div>
                    <div class="col-span-4">Rincian</div>
                    <div class="col-span-2 text-right">Nominal</div>
                    <div class="col-span-2">Kategori</div>
                    <div class="col-span-2 text-right">Aksi</div>
                </div>
            `;
            
            let lastDate = null;
            displayTransactions.forEach((trx, index) => {
                const trxDate = new Date(trx.tanggal).toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'});
                
                if (trxDate !== lastDate) {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'p-2 bg-yellow-50 text-xs font-bold text-yellow-800 text-center';
                    dateHeader.textContent = trxDate;
                    container.appendChild(dateHeader);
                    lastDate = trxDate;
                }

                const row = document.createElement('div');
                const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.className = `grid grid-cols-12 gap-4 p-3 border-b text-sm items-center ${rowBg}`;
                
                let nominalHTML, rincianHTML, typeLabel, typeColorClass, kategoriText;
                const time = new Date(trx.id).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                switch(trx.jenis) {
                    case 'pemasukan':
                        typeLabel = 'Pemasukan';
                        typeColorClass = 'text-green-700';
                        nominalHTML = `<span class="font-semibold text-green-600">+${formatCurrency(trx.jumlah)}</span>`;
                        kategoriText = trx.kategori;
                        rincianHTML = `
                            <p class="font-semibold text-gray-800 truncate">${trx.akun}</p>
                            <p class="text-xs text-gray-500">${trx.keterangan || trx.kategori}</p>
                        `;
                        break;
                    case 'pengeluaran':
                        typeLabel = 'Pengeluaran';
                        typeColorClass = 'text-red-700';
                        nominalHTML = `<span class="font-semibold text-red-600">-${formatCurrency(trx.jumlah)}</span>`;
                        kategoriText = trx.kategori;
                        rincianHTML = `
                            <p class="font-semibold text-gray-800 truncate">${trx.akun}</p>
                            <p class="text-xs text-gray-500">${trx.keterangan || trx.kategori}</p>
                        `;
                        break;
                    case 'transfer':
                        typeLabel = 'Transfer';
                        typeColorClass = 'text-sky-700';
                        nominalHTML = `<span>${formatCurrency(trx.jumlah)}</span>`;
                        kategoriText = 'Transfer';
                        rincianHTML = `<p class="font-semibold text-gray-800">${trx.akunDari} &rarr; ${trx.akunKe}</p>
                                     <p class="text-xs text-gray-500">${trx.keterangan || 'Transfer antar akun'}</p>`;
                        break;
                    case 'dana':
                        typeLabel = 'Trx. Penjualan';
                        typeColorClass = 'text-purple-700';
                        nominalHTML = `<p class="font-semibold text-green-600">${formatCurrency(trx.jumlah)}</p>
                                    <p class="font-semibold text-blue-500">+${formatCurrency(trx.fee)}</p>`;
                        kategoriText = 'Trx. Penjualan';
                         rincianHTML = `
                            <p class="font-semibold text-gray-800">${trx.akunDari} &rarr; ${trx.akunKe}</p>
                            <p class="text-xs text-gray-500">${trx.opsiDana}</p>
                        `;
                        break;
                    default:
                        typeLabel = trx.jenis;
                        typeColorClass = 'text-gray-700';
                        nominalHTML = `<span>${formatCurrency(trx.jumlah)}</span>`;
                        kategoriText = trx.kategori || 'Lainnya';
                        rincianHTML = `<p class="font-semibold text-gray-800">${trx.keterangan || 'Detail tidak tersedia'}</p>`;
                }

                row.innerHTML = `
                    <div class="col-span-2 text-right text-xs">
                        <p class="font-bold ${typeColorClass}">${typeLabel}</p>
                        <p class="text-gray-500">${time}</p>
                    </div>
                    <div class="col-span-4 text-sm">${rincianHTML}</div>
                    <div class="col-span-2 text-right text-sm font-semibold">${nominalHTML}</div>
                    <div class="col-span-2 text-sm text-gray-700 truncate">${kategoriText}</div>
                    <div class="col-span-2 text-right flex justify-end items-center gap-2">
                         <button class="btn-edit-transaksi text-gray-400 hover:text-amber-500 p-1" data-id="${trx.id}" title="Ubah"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></button>
                         <button class="btn-delete-transaksi text-gray-400 hover:text-rose-500 p-1" data-id="${trx.id}" title="Hapus"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                `;
                container.appendChild(row);
            });
        }
        
        // --- MODAL MANAGEMENT ---
        const formModal = document.getElementById('form-modal');
        const deleteModal = document.getElementById('delete-modal');
        const backupModal = document.getElementById('backup-modal');
        const aboutModal = document.getElementById('about-modal');
        const transaksiModal = document.getElementById('transaksi-modal');
        const produkModal = document.getElementById('produk-modal');
        const hutangModal = document.getElementById('hutang-modal');
        let currentModalCallback;

        function openModal(config) {
            const { title, label, value, inputType = 'text', callback } = config;
            formModal.querySelector('#modal-title').textContent = title;
            formModal.querySelector('#modal-label').textContent = label;
            const input = formModal.querySelector('#modal-input');
            input.value = value;
            input.type = inputType;
            input.placeholder = label;
            currentModalCallback = callback;
            formModal.classList.add('active');
            input.focus();
        }

        function openDeleteModal(itemName, callback) {
            deleteModal.querySelector('#delete-modal-text').textContent = `Tindakan ini akan menghapus "${itemName}" secara permanen.`;
            currentModalCallback = callback;
            deleteModal.classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal-container').forEach(m => m.classList.remove('active'));
            currentModalCallback = null;
        }

        [formModal, deleteModal, backupModal, aboutModal, transaksiModal, produkModal, hutangModal].forEach(modal => {
            modal.querySelector('.modal-backdrop')?.addEventListener('click', closeModal);
            modal.querySelector('button[id$="-cancel"]')?.addEventListener('click', closeModal);
        });
        document.getElementById('about-modal-close').addEventListener('click', closeModal);


        formModal.querySelector('#modal-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const value = formModal.querySelector('#modal-input').value.trim();
            if (value && currentModalCallback) currentModalCallback(value);
            closeModal();
        });
        
        deleteModal.querySelector('#delete-confirm').addEventListener('click', () => {
            if (currentModalCallback) currentModalCallback();
            closeModal();
        });
        
        document.getElementById('about-button').addEventListener('click', () => {
            aboutModal.classList.add('active');
        });

        // --- CRUD & EVENT HANDLING ---
        document.getElementById('pengaturan').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const crudPage = target.closest('.crud-page');
            if (!crudPage) return;

            const type = crudPage.dataset.type;
            const index = target.dataset.index;

            if (target.classList.contains('btn-add')) {
                 const isAkun = type === 'akun';
                 openModal({
                    title: `Tambah ${appData[type].title} Baru`,
                    label: `Nama ${appData[type].title}`,
                    value: '',
                    callback: (newValue) => {
                        if (isAkun) appData[type].items.push({ name: newValue, balance: 0 });
                        else appData[type].items.push(newValue);
                        saveData();
                        renderAll();
                    }
                });
            } else if (target.classList.contains('btn-edit')) {
                const isAkun = type === 'akun';
                const currentItem = appData[type].items[index];
                openModal({
                    title: `Ubah ${appData[type].title}`,
                    label: `Nama ${appData[type].title}`,
                    value: isAkun ? currentItem.name : currentItem,
                    callback: (newValue) => {
                        if (isAkun) appData[type].items[index].name = newValue;
                        else appData[type].items[index] = newValue;
                        saveData();
                        renderAll();
                    }
                });
            } else if (target.classList.contains('btn-delete')) {
                const isAkun = type === 'akun';
                const itemName = isAkun ? appData[type].items[index].name : appData[type].items[index];
                openDeleteModal(itemName, () => {
                    appData[type].items.splice(index, 1);
                    saveData();
                    renderAll();
                });
            } else if (target.classList.contains('btn-saldo') && type === 'akun') {
                const currentItem = appData[type].items[index];
                openModal({
                    title: `Penyesuaian Saldo`,
                    label: `Saldo untuk ${currentItem.name}`,
                    value: currentItem.balance,
                    inputType: 'number',
                    callback: (newValue) => {
                        appData[type].items[index].balance = parseFloat(newValue) || 0;
                        saveData();
                        renderAll();
                    }
                });
            }
        });
        
        // --- ALL DATA BACKUP/RESTORE ---
        const backupModalTitle = document.getElementById('backup-modal-title');
        const backupDataArea = document.getElementById('backup-data-area');
        const backupCopyBtn = document.getElementById('backup-modal-copy');
        const copyFeedback = document.getElementById('copy-feedback');
        const importJsonInput = document.getElementById('import-json-input');

        document.getElementById('export-all-data').addEventListener('click', async () => {
            const dataToShare = JSON.stringify(appData, null, 2);
            const date = new Date().toISOString().slice(0, 10);
            const fileName = `backup_keuangan_${date}.json`;
            const blob = new Blob([dataToShare], { type: 'application/json' });
            const file = new File([blob], fileName, { type: 'application/json' });

            // Helper function for direct download
            const triggerDownload = () => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // 1. Try modern Web Share API (ideal for mobile/tablet)
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        title: 'Backup Data Aplikasi Keuangan',
                        text: `Backup data ${date}`,
                        files: [file],
                    });
                } catch (err) {
                    console.error('Share API gagal, mencoba download langsung:', err);
                    // If sharing is cancelled by user or fails, try direct download as a fallback
                    triggerDownload();
                }
            } else {
                // 2. Fallback to direct download (ideal for desktop)
                try {
                     triggerDownload();
                } catch (err) {
                    // 3. Last resort fallback: show copy-paste modal
                    console.error('Download langsung gagal, menampilkan modal fallback:', err);
                    backupDataArea.value = dataToShare;
                    backupModal.classList.add('active');
                }
            }
        });

        document.getElementById('import-all-data').addEventListener('click', () => {
            importJsonInput.click();
        });

        importJsonInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataToImport = e.target.result;
                 try {
                    const parsedData = JSON.parse(dataToImport);
                    openDeleteModal("Ini akan menimpa SEMUA data saat ini dengan data dari file backup. Anda yakin ingin melanjutkan?", () => {
                        appData = parsedData;
                        saveData();
                        loadData(); // Reload untuk memastikan integritas data
                        renderAll();
                    });
                } catch (error) {
                    alert('File backup tidak valid atau rusak. Pastikan file tersebut adalah file JSON yang benar.');
                    console.error("Import Error:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input agar bisa memilih file yang sama lagi
        });

        backupCopyBtn.addEventListener('click', () => {
            backupDataArea.select();
            document.execCommand('copy');
            copyFeedback.textContent = 'Data berhasil disalin!';
            setTimeout(() => { copyFeedback.textContent = '' }, 2000);
        });
        
        // --- TRANSAKSI ---
        function updateTransaksiFormUI(jenis) {
            const isTransfer = jenis === 'Transfer';
            const isDana = jenis === 'Dana';
            const isPemasukanPengeluaran = jenis === 'Pemasukan' || jenis === 'Pengeluaran';

            document.getElementById('kategori-field').style.display = isPemasukanPengeluaran ? 'block' : 'none';
            document.getElementById('akun-field').style.display = isPemasukanPengeluaran ? 'block' : 'none';
            document.getElementById('transfer-fields').style.display = (isTransfer || isDana) ? 'block' : 'none';
            document.getElementById('fee-dana-field').style.display = isDana ? 'block' : 'none';
            document.getElementById('dana-opsi-field').style.display = isDana ? 'block' : 'none';
        }

        function openTransaksiModal(trxToEdit = null) {
            const form = document.getElementById('transaksi-form');
            form.reset();
            
            document.getElementById('transaksi-kategori').innerHTML = appData.kategori.items.map(k => `<option value="${k}">${k}</option>`).join('');
            const akunOptions = appData.akun.items.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            document.getElementById('transaksi-akun').innerHTML = akunOptions;
            document.getElementById('transaksi-akun-dari').innerHTML = akunOptions;
            document.getElementById('transaksi-akun-ke').innerHTML = akunOptions;
            
            if (trxToEdit) {
                document.getElementById('transaksi-modal-title').textContent = 'Ubah Transaksi';
                document.getElementById('transaksi-edit-id').value = trxToEdit.id;
                document.getElementById('transaksi-jenis-select').value = trxToEdit.jenis.charAt(0).toUpperCase() + trxToEdit.jenis.slice(1);
                document.getElementById('transaksi-tanggal').value = trxToEdit.tanggal;
                document.getElementById('transaksi-jumlah').value = trxToEdit.jumlah;
                document.getElementById('transaksi-keterangan').value = trxToEdit.keterangan;
                if(trxToEdit.jenis === 'transfer' || trxToEdit.jenis === 'dana') {
                    document.getElementById('transaksi-akun-dari').value = trxToEdit.akunDari;
                    document.getElementById('transaksi-akun-ke').value = trxToEdit.akunKe;
                } else {
                    document.getElementById('transaksi-kategori').value = trxToEdit.kategori;
                    document.getElementById('transaksi-akun').value = trxToEdit.akun;
                }
                if(trxToEdit.jenis === 'dana') {
                    document.getElementById('transaksi-fee-dana').value = trxToEdit.fee;
                    form.querySelector(`input[name="transaksi-dana-opsi"][value="${trxToEdit.opsiDana}"]`).checked = true;
                }
            } else {
                document.getElementById('transaksi-modal-title').textContent = 'Tambah Transaksi';
                document.getElementById('transaksi-edit-id').value = '';
                document.getElementById('transaksi-tanggal').valueAsDate = new Date();
            }
            updateTransaksiFormUI(document.getElementById('transaksi-jenis-select').value);
            transaksiModal.classList.add('active');
        }

        document.getElementById('btn-add-transaksi').addEventListener('click', () => openTransaksiModal());
        document.getElementById('transaksi-jenis-select').addEventListener('change', (e) => updateTransaksiFormUI(e.target.value));
        
        function revertTransactionBalance(trx) {
            if (!trx) return;
            if (trx.jenis === 'transfer') {
                const akunDari = appData.akun.items.find(a => a.name === trx.akunDari);
                const akunKe = appData.akun.items.find(a => a.name === trx.akunKe);
                if (akunDari) akunDari.balance += trx.jumlah;
                if (akunKe) akunKe.balance -= trx.jumlah;
            } else if (trx.jenis === 'dana') {
                const akunDari = appData.akun.items.find(a => a.name === trx.akunDari);
                const akunKe = appData.akun.items.find(a => a.name === trx.akunKe);
                const labaBersih = appData.akun.items.find(a => a.name === "Laba Bersih");
                if (akunKe) akunKe.balance -= trx.jumlah;
                if (labaBersih) labaBersih.balance -= trx.fee;
                if (akunDari) {
                    if (trx.opsiDana === 'Admin Potong') {
                        akunDari.balance += (trx.jumlah - trx.fee);
                    } else { // Admin Bayar
                        akunDari.balance += trx.jumlah;
                    }
                }
            } else {
                const akun = appData.akun.items.find(a => a.name === trx.akun);
                if (akun) {
                    akun.balance -= (trx.jenis === 'pemasukan' ? trx.jumlah : -trx.jumlah);
                }
            }
        }
        
        document.getElementById('transaksi-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const editId = parseInt(form.querySelector('#transaksi-edit-id').value);
            const jumlah = parseFloat(form.querySelector('#transaksi-jumlah').value) || 0;
            
            if (editId) {
                revertTransactionBalance(appData.transaksi.items.find(t => t.id === editId));
            }

            const transactionData = {
                id: editId || Date.now(),
                tanggal: form.querySelector('#transaksi-tanggal').value,
                jumlah: jumlah,
                keterangan: form.querySelector('#transaksi-keterangan').value,
                jenis: form.querySelector('#transaksi-jenis-select').value.toLowerCase(),
            };

            if (transactionData.jenis === 'transfer') {
                transactionData.akunDari = form.querySelector('#transaksi-akun-dari').value;
                transactionData.akunKe = form.querySelector('#transaksi-akun-ke').value;
                const akunDari = appData.akun.items.find(a => a.name === transactionData.akunDari);
                const akunKe = appData.akun.items.find(a => a.name === transactionData.akunKe);
                if (akunDari) akunDari.balance -= jumlah;
                if (akunKe) akunKe.balance += jumlah;
            } else if (transactionData.jenis === 'dana') {
                transactionData.akunDari = form.querySelector('#transaksi-akun-dari').value;
                transactionData.akunKe = form.querySelector('#transaksi-akun-ke').value;
                transactionData.fee = parseFloat(form.querySelector('#transaksi-fee-dana').value) || 0;
                transactionData.opsiDana = form.querySelector('input[name="transaksi-dana-opsi"]:checked').value;
                const akunDari = appData.akun.items.find(a => a.name === transactionData.akunDari);
                const akunKe = appData.akun.items.find(a => a.name === transactionData.akunKe);
                const labaBersih = appData.akun.items.find(a => a.name === "Laba Bersih");
                
                if(akunKe) akunKe.balance += jumlah;
                if(labaBersih) labaBersih.balance += transactionData.fee;
                if(akunDari){
                    if(transactionData.opsiDana === 'Admin Potong') {
                        akunDari.balance -= (jumlah - transactionData.fee);
                    } else { // Admin Bayar
                        akunDari.balance -= jumlah;
                    }
                }
            } else {
                transactionData.kategori = form.querySelector('#transaksi-kategori').value;
                transactionData.akun = form.querySelector('#transaksi-akun').value;
                const akun = appData.akun.items.find(a => a.name === transactionData.akun);
                if (akun) {
                    akun.balance += (transactionData.jenis === 'pemasukan' ? jumlah : -jumlah);
                }
            }
            
            if (editId) {
                const index = appData.transaksi.items.findIndex(t => t.id === editId);
                if (index > -1) appData.transaksi.items[index] = transactionData;
            } else {
                appData.transaksi.items.push(transactionData);
            }

            saveData();
            renderAll();
            closeModal();
        });
        
        document.getElementById('transaksi-list-container').addEventListener('click', (e) => {
            const editBtn = e.target.closest('.btn-edit-transaksi');
            const deleteBtn = e.target.closest('.btn-delete-transaksi');

            if(editBtn) {
                const trxId = parseInt(editBtn.dataset.id);
                const trx = appData.transaksi.items.find(t => t.id === trxId);
                if (trx) openTransaksiModal(trx);
            }
            if(deleteBtn) {
                const trxId = parseInt(deleteBtn.dataset.id);
                 const trx = appData.transaksi.items.find(t => t.id === trxId);
                if(trx) {
                    let trxName = trx.keterangan || trx.kategori || `Transaksi ${trx.jenis}`;
                    openDeleteModal(`Transaksi "${trxName}"`, () => {
                        revertTransactionBalance(trx);
                        appData.transaksi.items = appData.transaksi.items.filter(t => t.id !== trxId);
                        saveData();
                        renderAll();
                    });
                }
            }
        });

        // --- PRODUK ---
        document.getElementById('btn-add-produk').addEventListener('click', () => openProdukModal());
        
        function openProdukModal(produkToEdit = null) {
            const form = document.getElementById('produk-form');
            form.reset();
            const modalTitle = document.getElementById('produk-modal-title');
            const editIdInput = document.getElementById('produk-edit-id');

            if (produkToEdit) {
                modalTitle.textContent = 'Ubah Produk';
                editIdInput.value = produkToEdit.id;
                form.querySelector('#produk-nama').value = produkToEdit.nama;
                form.querySelector('#produk-harga-modal').value = produkToEdit.hargaModal;
                form.querySelector('#produk-harga-jual').value = produkToEdit.hargaJual;
                form.querySelector('#produk-stok').value = produkToEdit.stok;
            } else {
                modalTitle.textContent = 'Tambah Produk';
                editIdInput.value = '';
            }
            produkModal.classList.add('active');
        }

        document.getElementById('produk-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const editId = parseFloat(form.querySelector('#produk-edit-id').value);
            
            const produkData = {
                id: editId || (Date.now() + Math.random()),
                nama: form.querySelector('#produk-nama').value,
                hargaModal: parseFloat(form.querySelector('#produk-harga-modal').value) || 0,
                hargaJual: parseFloat(form.querySelector('#produk-harga-jual').value) || 0,
                stok: parseInt(form.querySelector('#produk-stok').value) || 0,
            };

            if (editId) {
                const index = appData.produk.items.findIndex(p => p.id === editId);
                if (index !== -1) {
                    appData.produk.items[index] = produkData;
                }
            } else {
                appData.produk.items.push(produkData);
            }

            saveData();
            renderAll();
            closeModal();
        });
        
        document.getElementById('produk-list-container').addEventListener('click', (e) => {
            const editBtn = e.target.closest('.btn-edit-produk');
            const deleteBtn = e.target.closest('.btn-delete-produk');

            if (editBtn) {
                const produkId = parseFloat(editBtn.dataset.id);
                const produkToEdit = appData.produk.items.find(p => p.id === produkId);
                if (produkToEdit) {
                    openProdukModal(produkToEdit);
                }
            }

            if (deleteBtn) {
                const produkId = parseFloat(deleteBtn.dataset.id);
                const index = appData.produk.items.findIndex(p => p.id === produkId);
                if (index !== -1) {
                    openDeleteModal(`produk "${appData.produk.items[index].nama}"`, () => {
                        appData.produk.items.splice(index, 1);
                        saveData();
                        renderAll();
                    });
                }
            }
        });
        
        function renderProdukList() {
            const container = document.getElementById('produk-list-container');
            container.innerHTML = '';

            if (appData.produk.items.length === 0) {
                 container.innerHTML = `<div class="text-center py-10 px-4">
                    <p class="text-gray-500">Belum ada produk.</p>
                    <p class="text-sm text-gray-400 mt-1">Klik 'Tambah Produk' untuk memulai.</p>
                </div>`;
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';

            table.innerHTML = `
                <thead class="bg-gray-50 text-xs text-gray-600 uppercase sticky top-0">
                    <tr>
                        <th class="p-3">Nama Produk</th>
                        <th class="p-3">Harga</th>
                        <th class="p-3 text-center">Stok</th>
                        <th class="p-3 text-right">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    ${appData.produk.items.map(produk => `
                        <tr class="border-b">
                            <td class="p-3 font-semibold text-gray-800">${produk.nama}</td>
                            <td class="p-3 text-gray-600 whitespace-nowrap">
                                <span class="mr-3">Modal: <b class="text-gray-800">${formatCurrency(produk.hargaModal)}</b></span>
                                <span>Jual: <b class="text-gray-800">${formatCurrency(produk.hargaJual)}</b></span>
                            </td>
                            <td class="p-3 text-center font-semibold">${produk.stok}</td>
                            <td class="p-3">
                                <div class="flex items-center justify-end space-x-2">
                                    <button class="btn-edit-produk text-amber-500 hover:text-amber-600 p-1" data-id="${produk.id}" title="Ubah">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                                    </button>
                                    <button class="btn-delete-produk text-rose-500 hover:text-rose-600 p-1" data-id="${produk.id}" title="Hapus">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.appendChild(table);
        }

        function renderProdukSummary() {
            const totalStokEl = document.getElementById('total-stok-produk');
            const totalAsetEl = document.getElementById('total-aset-produk');

            const totalStok = appData.produk.items.reduce((sum, produk) => sum + produk.stok, 0);
            const totalAset = appData.produk.items.reduce((sum, produk) => sum + (produk.hargaModal * produk.stok), 0);

            totalStokEl.textContent = totalStok.toLocaleString('id-ID');
            totalAsetEl.textContent = formatCurrency(totalAset);
        }
        
        // --- PRODUK CSV ---
        document.getElementById('export-produk-csv').addEventListener('click', () => {
            let csvContent = "data:text/csv;charset=utf-8,nama,harga_modal,harga_jual,stok\n";
            appData.produk.items.forEach(p => {
                const row = `"${p.nama.replace(/"/g, '""')}",${p.hargaModal},${p.hargaJual},${p.stok}\n`;
                csvContent += row;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `backup_produk_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        const produkFileInput = document.getElementById('produk-csv-file-input');
        document.getElementById('import-produk-csv').addEventListener('click', () => produkFileInput.click());
        produkFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const newProdukList = [];
                const rows = text.split('\n').slice(1);

                rows.forEach(row => {
                    if (!row.trim()) return;
                    const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    const nama = (values[0] || '').trim().replace(/^"|"$/g, '');
                    const hargaModal = parseFloat(values[1]) || 0;
                    const hargaJual = parseFloat(values[2]) || 0;
                    const stok = parseInt(values[3]) || 0;
                    
                    if (nama) {
                        newProdukList.push({ id: Date.now() + Math.random(), nama, hargaModal, hargaJual, stok });
                    }
                });
                
                openDeleteModal("Mengimpor akan menimpa semua data produk saat ini. Lanjutkan?", () => {
                    appData.produk.items = newProdukList;
                    saveData();
                    renderAll();
                });
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        // --- KASIR ---
        const kasirPage = document.getElementById('kasir');
        const tabBtns = kasirPage.querySelectorAll('.tab-btn');
        const tabPanels = kasirPage.querySelectorAll('.tab-panel');
        const kasirProdukSelect = document.getElementById('kasir-produk-select');
        const kasirAplikasiSelect = document.getElementById('kasir-aplikasi-select');
        const kasirJasaSumberAkunSelect = document.getElementById('kasir-jasa-sumber-akun');
        const kasirAplikasiSumberAkunSelect = document.getElementById('kasir-aplikasi-sumber-akun');
        const keranjangItemList = document.getElementById('keranjang-item-list');
        const keranjangTotalEl = document.getElementById('keranjang-total');

        function getKeranjangItemIcon(type) {
            switch (type) {
                case 'produk':
                    return `<div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-500 flex items-center justify-center mr-3 flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                            </div>`;
                case 'jasa':
                    return `<div class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-500 flex items-center justify-center mr-3 flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path></svg>
                            </div>`;
                case 'aplikasi':
                    return `<div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-500 flex items-center justify-center mr-3 flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            </div>`;
                default:
                    return `<div class="w-8 h-8 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center mr-3 flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            </div>`;
            }
        }

        function renderKasirDropdowns() {
            // Populate produk
            kasirProdukSelect.innerHTML = appData.produk.items.map(p => `<option value="${p.id}">${p.nama} - ${formatCurrency(p.hargaJual)}</option>`).join('');
            // Populate aplikasi dropdowns
            if (kasirAplikasiSelect) { // Fallback for old structure
                kasirAplikasiSelect.innerHTML = appData.aplikasi.items.map(a => `<option value="${a}">${a}</option>`).join('');
            }
            if (kasirAplikasiSumberAkunSelect) {
                kasirAplikasiSumberAkunSelect.innerHTML = appData.akun.items.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            }
            // Populate sumber akun for jasa
            if (kasirJasaSumberAkunSelect) {
                kasirJasaSumberAkunSelect.innerHTML = appData.akun.items.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            }
        }

        function updateKeranjangTotal() {
            const total = keranjang.reduce((sum, item) => sum + item.harga * item.jumlah, 0);
            keranjangTotalEl.textContent = formatCurrency(total);
        }

        function renderKeranjang() {
            if (keranjang.length === 0) {
                keranjangItemList.innerHTML = `<p class="text-center text-gray-500 text-sm py-8">Keranjang masih kosong.</p>`;
                updateKeranjangTotal();
                return;
            }

            keranjangItemList.innerHTML = keranjang.map((item, index) => `
                <div class="py-2 border-b border-gray-100 flex items-center">
                    ${getKeranjangItemIcon(item.type)}
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 mr-2">
                                <p class="font-semibold text-xs">${item.nama}</p>
                                <p class="text-xs text-gray-500">${item.jumlah} x ${formatCurrency(item.harga)}</p>
                            </div>
                            <div class="flex items-center">
                                 <p class="font-semibold text-xs mr-2">${formatCurrency(item.jumlah * item.harga)}</p>
                                 <button class="btn-hapus-keranjang text-rose-500 hover:text-rose-600 p-1" data-index="${index}" title="Hapus">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            updateKeranjangTotal();
        }

        function addToKeranjang(item) {
            // Cek jika produk sudah ada, update jumlahnya
            const existingItem = keranjang.find(i => i.id === item.id && i.id !== undefined);
            if (existingItem) {
                existingItem.jumlah += item.jumlah;
            } else {
                keranjang.push(item);
            }
            renderKeranjang();
        }

        function renderKasirRiwayat() {
            const container = document.getElementById('kasir-riwayat-list');
            const salesTransactions = appData.transaksi.items
                .filter(t => t.kategori === 'Penjualan')
                .sort((a, b) => {
                    // Urutkan berdasarkan tanggal (terbaru dulu), lalu berdasarkan waktu (terbaru dulu)
                    const dateComparison = new Date(b.tanggal) - new Date(a.tanggal);
                    if (dateComparison !== 0) {
                        return dateComparison;
                    }
                    return b.id - a.id;
                });

            if (salesTransactions.length === 0) {
                container.innerHTML = `<div class="text-center py-10 px-4"><p class="text-gray-500">Belum ada penjualan.</p></div>`;
                return;
            }
            
            container.innerHTML = `<div class="bg-gray-50 text-xs font-semibold text-gray-500 uppercase grid grid-cols-12 gap-x-2 px-3 py-2 border-b">
                <div class="col-span-2 text-right">Waktu</div>
                <div class="col-span-7">Rincian</div>
                <div class="col-span-2 text-right">Harga</div>
                <div class="col-span-1 text-right">Aksi</div>
            </div>`;

            let lastDate = null;
            salesTransactions.forEach((trx, index) => {
                const trxDate = new Date(trx.tanggal).toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'});
                
                if (trxDate !== lastDate) {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'text-center text-xs font-bold text-gray-500 py-2 bg-gray-100 border-b';
                    dateHeader.textContent = trxDate;
                    container.appendChild(dateHeader);
                    lastDate = trxDate;
                }

                const row = document.createElement('div');
                row.className = `grid grid-cols-12 gap-x-2 px-3 py-2 border-b text-xs items-start`;
                
                const time = new Date(trx.id).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const item = trx.items[0];

                const totalModal = (item.hargaModal || 0) * item.jumlah;
                const totalLaba = trx.jumlah - totalModal;

                const saleType = item.type.charAt(0).toUpperCase() + item.type.slice(1);
                const typeColorClass = saleType === 'Produk' ? 'text-blue-600' : (saleType === 'Jasa' ? 'text-emerald-600' : 'text-indigo-600');

                row.innerHTML = `
                    <div class="col-span-2 text-right">
                        <p class="font-bold ${typeColorClass}">${saleType}</p>
                        <p class="text-gray-500">${time}</p>
                    </div>
                    <div class="col-span-7 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${item.nama}</p>
                        <p class="text-gray-500">${item.jumlah} x ${formatCurrency(item.harga)}</p>
                    </div>
                    <div class="col-span-2 text-right">
                        <p class="font-semibold text-gray-700">${formatCurrency(totalModal)}</p>
                        <p class="text-green-600">${formatCurrency(totalLaba)}</p>
                    </div>
                    <div class="col-span-1 text-right flex justify-end items-center h-full">
                         <button class="btn-delete-penjualan text-gray-400 hover:text-rose-500 p-1" data-id="${trx.id}" title="Hapus">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // Event Listeners for Kasir Page
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetPanelId = btn.dataset.target;

                // Reset all buttons to inactive state
                tabBtns.forEach(b => {
                    b.classList.remove('bg-blue-500', 'bg-emerald-500', 'bg-indigo-500', 'text-white', 'font-bold', 'shadow-lg');
                    b.classList.add('bg-gray-200', 'text-gray-700', 'font-semibold');
                });

                // Set active state for the clicked button
                btn.classList.remove('bg-gray-200', 'text-gray-700', 'font-semibold');
                let activeClasses = [];
                switch (targetPanelId) {
                    case 'panel-produk':
                        activeClasses = ['bg-blue-500', 'text-white', 'font-bold', 'shadow-lg'];
                        break;
                    case 'panel-jasa':
                        activeClasses = ['bg-emerald-500', 'text-white', 'font-bold', 'shadow-lg'];
                        break;
                    case 'panel-aplikasi':
                        activeClasses = ['bg-indigo-500', 'text-white', 'font-bold', 'shadow-lg'];
                        break;
                }
                btn.classList.add(...activeClasses);


                // Show the correct panel
                tabPanels.forEach(p => p.classList.add('hidden'));
                document.getElementById(targetPanelId).classList.remove('hidden');
            });
        });

        document.getElementById('kasir-tambah-produk').addEventListener('click', () => {
            const produkId = parseFloat(kasirProdukSelect.value);
            const produk = appData.produk.items.find(p => p.id === produkId);
            if (!produk) return;

            const jumlah = parseInt(document.getElementById('kasir-produk-jumlah').value) || 1;
            const tanggal = document.getElementById('kasir-produk-tanggal').value;

            addToKeranjang({
                id: produk.id,
                nama: produk.nama,
                jumlah,
                harga: produk.hargaJual,
                hargaModal: produk.hargaModal,
                type: 'produk',
                tanggal: tanggal
            });
        });

        document.getElementById('kasir-tambah-jasa').addEventListener('click', () => {
            const nama = document.getElementById('kasir-jasa-nama').value.trim();
            const hargaModal = parseFloat(document.getElementById('kasir-jasa-harga-modal').value) || 0;
            const hargaJual = parseFloat(document.getElementById('kasir-jasa-harga-jual').value) || 0;
            const tanggal = document.getElementById('kasir-jasa-tanggal').value;
            if (!nama || hargaJual <= 0) return;

            addToKeranjang({
                id: `jasa-${Date.now()}`,
                nama,
                jumlah: 1,
                harga: hargaJual,
                hargaModal: hargaModal,
                type: 'jasa',
                tanggal: tanggal
            });
            document.getElementById('kasir-jasa-nama').value = '';
            document.getElementById('kasir-jasa-harga-modal').value = '';
            document.getElementById('kasir-jasa-harga-jual').value = '';
        });

        document.getElementById('kasir-tambah-aplikasi').addEventListener('click', () => {
            const sumberAkun = kasirAplikasiSumberAkunSelect.value;
            const hargaModal = parseFloat(document.getElementById('kasir-aplikasi-harga-modal').value) || 0;
            const hargaJual = parseFloat(document.getElementById('kasir-aplikasi-harga-jual').value) || 0;
            const tanggal = document.getElementById('kasir-aplikasi-tanggal').value;
            if (hargaJual <= 0 || !sumberAkun) return;
            
            addToKeranjang({
                id: `apk-${Date.now()}`,
                nama: `Aplikasi (${sumberAkun})`,
                jumlah: 1,
                harga: hargaJual,
                hargaModal: hargaModal,
                sumberAkun: sumberAkun,
                type: 'aplikasi',
                tanggal: tanggal
            });
             document.getElementById('kasir-aplikasi-harga-modal').value = '';
             document.getElementById('kasir-aplikasi-harga-jual').value = '';
        });

        keranjangItemList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.btn-hapus-keranjang');
            if (deleteBtn) {
                const index = parseInt(deleteBtn.dataset.index);
                keranjang.splice(index, 1);
                renderKeranjang();
            }
        });

        document.getElementById('keranjang-bayar-btn').addEventListener('click', () => {
            if (keranjang.length === 0) return;

            const akunKas = appData.akun.items.find(a => a.name === 'Cash');
            const akunLaba = appData.akun.items.find(a => a.name === 'Laba Bersih');
            const akunModalProduk = appData.akun.items.find(a => a.name === 'Modal');

            // Proses setiap item di keranjang sebagai transaksi terpisah
            keranjang.forEach(item => {
                const itemJual = item.harga * item.jumlah;
                const itemModal = (item.hargaModal || 0) * item.jumlah;
                const itemLaba = itemJual - itemModal;

                // --- UPDATE SALDO ---
                // 1. Laba bersih selalu dicatat ke Laba Bersih
                if (akunLaba) {
                    akunLaba.balance += itemLaba;
                }
                
                // 2. Logika saldo berdasarkan tipe item
                if (item.type === 'produk' || item.type === 'jasa') {
                    // Nilai modal produk & jasa ditambahkan ke akun "Modal"
                    if (akunModalProduk) akunModalProduk.balance += itemModal;
                    
                    // Kurangi stok jika itu produk
                    if (item.type === 'produk') {
                        const produkDiData = appData.produk.items.find(p => p.id === item.id);
                        if (produkDiData) {
                            produkDiData.stok -= item.jumlah;
                        }
                    }
                } else if (item.type === 'aplikasi') {
                    const akunSumber = appData.akun.items.find(a => a.name === item.sumberAkun);
                    // Kurangi modal dari sumber akun
                    if (akunSumber) akunSumber.balance -= itemModal;
                    // Tambahkan modal ke cash
                    if (akunKas) akunKas.balance += itemModal;
                }
                
                // 3. Buat entri transaksi terpisah
                const transactionData = {
                    id: Date.now() + Math.random(), // Tambah Math.random() untuk handle transaksi cepat
                    tanggal: item.tanggal,
                    jumlah: itemJual,
                    items: [JSON.parse(JSON.stringify(item))], // Hanya item ini dalam transaksi
                    keterangan: `Penjualan: ${item.nama} (x${item.jumlah})`,
                    jenis: 'pemasukan',
                    kategori: 'Penjualan',
                    akun: 'Cash'
                };
                
                appData.transaksi.items.push(transactionData);
            });
            
            // Clear keranjang setelah semua item diproses
            keranjang = [];
            renderKeranjang();
            saveData();
            renderAll();
        });

        function revertSaleTransaction(trx) {
            if (!trx || trx.kategori !== 'Penjualan' || trx.items.length === 0) return;

            const item = trx.items[0];
            const totalJual = trx.jumlah;
            const itemModal = (item.hargaModal || 0) * item.jumlah;
            const itemLaba = totalJual - itemModal;

            const akunKas = appData.akun.items.find(a => a.name === 'Cash');
            const akunLaba = appData.akun.items.find(a => a.name === 'Laba Bersih');
            const akunModalProduk = appData.akun.items.find(a => a.name === 'Modal');
            
            // 1. Revert Laba for all types
            if (akunLaba) akunLaba.balance -= itemLaba;

            // 2. Revert modal, cash, and stock based on type
            if (item.type === 'produk' || item.type === 'jasa') {
                // Revert modal addition
                if (akunModalProduk) akunModalProduk.balance -= itemModal;
                
                // Add back stock if it's a product
                if (item.type === 'produk') {
                    const produkDiData = appData.produk.items.find(p => p.id === item.id);
                    if (produkDiData) {
                        produkDiData.stok += item.jumlah;
                    }
                }
            } else if (item.type === 'aplikasi') {
                // Revert modal reduction from source account
                const akunSumber = appData.akun.items.find(a => a.name === item.sumberAkun);
                if (akunSumber) akunSumber.balance += itemModal;
                 // Revert modal addition to cash
                if (akunKas) akunKas.balance -= itemModal;
            }
        }

        document.getElementById('kasir-riwayat-list').addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.btn-delete-penjualan');
            
            if (deleteBtn) {
                const trxId = parseFloat(deleteBtn.dataset.id);
                const trx = appData.transaksi.items.find(t => t.id === trxId);
                if (trx) {
                    openDeleteModal(`Penjualan senilai ${formatCurrency(trx.jumlah)}`, () => {
                        revertSaleTransaction(trx);
                        appData.transaksi.items = appData.transaksi.items.filter(t => t.id !== trxId);
                        saveData();
                        renderAll();
                    });
                }
            }

        });

        // --- FILTER Minimalis ---
        const filterPresetContainer = document.getElementById('filter-presets');
        const filterStartDate = document.getElementById('filter-start-date');
        const filterEndDate = document.getElementById('filter-end-date');

        function applyFilter(type, start = null, end = null) {
            dateFilter = { type, start, end };
            renderDashboard();
            updateFilterUI();
        }

        function updateFilterUI() {
            // Reset all preset buttons to inactive state
            document.querySelectorAll('#filter-presets .filter-btn').forEach(btn => {
                btn.classList.remove('bg-sky-500', 'text-white', 'shadow');
                btn.classList.add('text-sky-700', 'hover:bg-sky-100');
            });

            // If a preset is active, highlight it
            if (dateFilter.type !== 'custom') {
                const activeButton = document.querySelector(`.filter-btn[data-filter="${dateFilter.type}"]`);
                if (activeButton) {
                    activeButton.classList.add('bg-sky-500', 'text-white', 'shadow');
                    activeButton.classList.remove('text-sky-700', 'hover:bg-sky-100');
                }
                // Clear date inputs when a preset is active
                filterStartDate.value = '';
                filterEndDate.value = '';
            }
        }

        function setInitialFilter() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            applyFilter('month', startOfMonth, endOfMonth);
        }

        filterPresetContainer.addEventListener('click', (e) => {
            const filterBtn = e.target.closest('.filter-btn');
            if (!filterBtn) return;

            const selection = filterBtn.dataset.filter;
            let start, end;
            const now = new Date();

            switch(selection) {
                case 'today':
                    start = new Date(new Date().setHours(0, 0, 0, 0));
                    end = new Date(new Date().setHours(23, 59, 59, 999));
                    break;
                case 'month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'year':
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                    break;
            }
            applyFilter(selection, start, end);
        });

        [filterStartDate, filterEndDate].forEach(input => {
            input.addEventListener('change', () => {
                const start = filterStartDate.value ? new Date(filterStartDate.value) : null;
                const end = filterEndDate.value ? new Date(filterEndDate.value) : null;
                
                if (start && end && start <= end) {
                    start.setHours(0, 0, 0, 0);
                    end.setHours(23, 59, 59, 999);
                    applyFilter('custom', start, end);
                }
            });
        });

        // --- HUTANG ---
        document.getElementById('btn-add-hutang').addEventListener('click', () => openHutangModal());

        function openHutangModal(hutangToEdit = null) {
            const form = document.getElementById('hutang-form');
            form.reset();
            const modalTitle = document.getElementById('hutang-modal-title');
            const editIdInput = document.getElementById('hutang-edit-id');

            if (hutangToEdit) {
                modalTitle.textContent = 'Ubah Hutang';
                editIdInput.value = hutangToEdit.id;
                form.querySelector('#hutang-tanggal').value = hutangToEdit.tanggal;
                form.querySelector('#hutang-nama').value = hutangToEdit.nama;
                form.querySelector('#hutang-nominal').value = hutangToEdit.nominal;
                form.querySelector('#hutang-catatan').value = hutangToEdit.catatan;
            } else {
                modalTitle.textContent = 'Tambah Hutang';
                editIdInput.value = '';
                form.querySelector('#hutang-tanggal').valueAsDate = new Date();
            }
            hutangModal.classList.add('active');
        }

        document.getElementById('hutang-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const editId = parseFloat(form.querySelector('#hutang-edit-id').value);
            const catatan = form.querySelector('#hutang-catatan').value.trim();
            const nominal = parseFloat(form.querySelector('#hutang-nominal').value) || 0;
            
            if(!catatan){
                form.querySelector('#hutang-catatan').classList.add('ring-2', 'ring-red-500');
                return;
            } else {
                 form.querySelector('#hutang-catatan').classList.remove('ring-2', 'ring-red-500');
            }
            
            const akunKas = appData.akun.items.find(a => a.name === 'Cash');
            const akunHutang = appData.akun.items.find(a => a.name === 'Hutang');

            if (editId) {
                const index = appData.hutang.items.findIndex(p => p.id === editId);
                if (index !== -1) {
                    const oldHutang = appData.hutang.items[index];
                    const nominalDifference = nominal - oldHutang.nominal;

                    // Jika hutang belum lunas, sesuaikan Cash dan Hutang dengan selisih nominal
                    if (oldHutang.status === 'Belum Lunas') {
                        if (akunKas) akunKas.balance -= nominalDifference;
                        if (akunHutang) akunHutang.balance += nominalDifference;
                    }

                    // Perbarui data hutang
                    appData.hutang.items[index].tanggal = form.querySelector('#hutang-tanggal').value;
                    appData.hutang.items[index].nama = form.querySelector('#hutang-nama').value.trim();
                    appData.hutang.items[index].nominal = nominal;
                    appData.hutang.items[index].catatan = catatan;
                }
            } else {
                const hutangData = {
                    id: (Date.now() + Math.random()),
                    tanggal: form.querySelector('#hutang-tanggal').value,
                    nama: form.querySelector('#hutang-nama').value.trim(),
                    nominal: nominal,
                    catatan: catatan,
                    status: 'Belum Lunas'
                };
                // Saat hutang baru dibuat:
                // 1. Kurangi saldo Cash
                if (akunKas) {
                    akunKas.balance -= nominal;
                }
                // 2. Tambahkan ke akun Hutang
                if (akunHutang) {
                    akunHutang.balance += nominal;
                }
                appData.hutang.items.push(hutangData);
            }

            saveData();
            renderAll();
            closeModal();
        });

        function renderHutangLists() {
            const belumLunasContainer = document.getElementById('hutang-list-container');
            const lunasContainer = document.getElementById('hutang-lunas-list-container');
            belumLunasContainer.innerHTML = '';
            lunasContainer.innerHTML = '';

            const hutangBelumLunas = appData.hutang.items.filter(item => item.status === 'Belum Lunas');
            const hutangLunas = appData.hutang.items.filter(item => item.status === 'Lunas');

            if (hutangBelumLunas.length === 0) {
                 belumLunasContainer.innerHTML = `<div class="text-center py-10 px-4"><p class="text-gray-500">Tidak ada hutang aktif.</p></div>`;
            } else {
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-left';
                table.innerHTML = `
                    <thead class="bg-gray-50 text-xs text-gray-600 uppercase sticky top-0">
                        <tr>
                            <th class="p-3">Tanggal</th>
                            <th class="p-3">Nama</th>
                            <th class="p-3">Catatan</th>
                            <th class="p-3 text-right">Nominal</th>
                            <th class="p-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${hutangBelumLunas.map(item => `
                            <tr class="border-b">
                                <td class="p-3 whitespace-nowrap">${new Date(item.tanggal).toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric'})}</td>
                                <td class="p-3 font-semibold text-gray-800">${item.nama}</td>
                                <td class="p-3 text-gray-600">${item.catatan}</td>
                                <td class="p-3 text-right font-semibold">${formatCurrency(item.nominal)}</td>
                                <td class="p-3">
                                    <div class="flex items-center justify-center space-x-1">
                                        <button class="btn-lunas bg-green-100 text-green-700 font-bold py-1 px-2 rounded-lg text-xs" data-id="${item.id}" title="Tandai Lunas">Lunas</button>
                                        <button class="btn-edit-hutang text-amber-500 hover:text-amber-600 p-1" data-id="${item.id}" title="Ubah"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></button>
                                        <button class="btn-delete-hutang text-rose-500 hover:text-rose-600 p-1" data-id="${item.id}" title="Hapus"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>`;
                belumLunasContainer.appendChild(table);
            }
            
            if (hutangLunas.length === 0) {
                 lunasContainer.innerHTML = `<div class="text-center py-10 px-4"><p class="text-gray-500">Belum ada riwayat hutang lunas.</p></div>`;
            } else {
                 const table = document.createElement('table');
                table.className = 'w-full text-sm text-left';
                table.innerHTML = `
                    <thead class="bg-gray-50 text-xs text-gray-600 uppercase sticky top-0">
                        <tr>
                            <th class="p-3">Tanggal</th>
                            <th class="p-3">Nama</th>
                            <th class="p-3">Catatan</th>
                            <th class="p-3 text-right">Nominal</th>
                            <th class="p-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${hutangLunas.map(item => `
                            <tr class="border-b bg-green-50/50">
                                <td class="p-3 whitespace-nowrap">${new Date(item.tanggal).toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric'})}</td>
                                <td class="p-3 font-semibold text-gray-800">${item.nama}</td>
                                <td class="p-3 text-gray-600">${item.catatan}</td>
                                <td class="p-3 text-right font-semibold">${formatCurrency(item.nominal)}</td>
                                <td class="p-3 text-center">
                                     <button class="btn-batal-lunas text-gray-500 hover:text-gray-700 p-1" data-id="${item.id}" title="Batalkan Status Lunas">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3"></path></svg>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>`;
                lunasContainer.appendChild(table);
            }
        }

        document.getElementById('hutang').addEventListener('click', (e) => {
            const editBtn = e.target.closest('.btn-edit-hutang');
            const deleteBtn = e.target.closest('.btn-delete-hutang');
            const lunasBtn = e.target.closest('.btn-lunas');
            const batalLunasBtn = e.target.closest('.btn-batal-lunas');

            const findHutang = (id) => appData.hutang.items.find(p => p.id === parseFloat(id));
            const akunKas = appData.akun.items.find(a => a.name === 'Cash');
            const akunHutang = appData.akun.items.find(a => a.name === 'Hutang');

            if (lunasBtn) {
                const hutang = findHutang(lunasBtn.dataset.id);
                if (hutang) {
                    hutang.status = 'Lunas';
                    // Saat hutang lunas:
                    // 1. Kurangi saldo Hutang
                    if (akunHutang) akunHutang.balance -= hutang.nominal;
                    // 2. Tambahkan ke akun Cash (uang kembali)
                    if (akunKas) akunKas.balance += hutang.nominal;
                    saveData();
                    renderAll();
                }
            }

            if(batalLunasBtn) {
                 const hutang = findHutang(batalLunasBtn.dataset.id);
                if (hutang) {
                    hutang.status = 'Belum Lunas';
                    // Saat pelunasan dibatalkan:
                    // 1. Tambahkan kembali ke saldo Hutang
                    if (akunHutang) akunHutang.balance += hutang.nominal;
                    // 2. Ambil kembali uang dari Cash
                    if (akunKas) akunKas.balance -= hutang.nominal;
                    saveData();
                    renderAll();
                }
            }

            if (editBtn) {
                const hutang = findHutang(editBtn.dataset.id);
                if (hutang) openHutangModal(hutang);
            }

            if (deleteBtn) {
                const hutangId = parseFloat(deleteBtn.dataset.id);
                const index = appData.hutang.items.findIndex(p => p.id === hutangId);
                if (index !== -1) {
                    const hutangToDelete = appData.hutang.items[index];
                    openDeleteModal(`data hutang untuk "${hutangToDelete.nama}"`, () => {
                        // Jika hutang yang dihapus belum lunas, kembalikan transaksi
                        if (hutangToDelete.status === 'Belum Lunas') {
                            // 1. Kembalikan nominal ke Cash
                            if (akunKas) akunKas.balance += hutangToDelete.nominal;
                            // 2. Kurangi nominal dari akun Hutang
                            if (akunHutang) akunHutang.balance -= hutangToDelete.nominal;
                        }
                        // Jika sudah lunas, tidak ada perubahan saldo saat dihapus
                        appData.hutang.items.splice(index, 1);
                        saveData();
                        renderAll();
                    });
                }
            }
        });

        const toggleLunasBtn = document.getElementById('toggle-lunas-history');
        const lunasWrapper = document.getElementById('hutang-lunas-wrapper');

        toggleLunasBtn.addEventListener('click', () => {
            lunasWrapper.classList.toggle('hidden');
            if (lunasWrapper.classList.contains('hidden')) {
                toggleLunasBtn.textContent = 'Tampilkan';
            } else {
                toggleLunasBtn.textContent = 'Sembunyikan';
            }
        });


        // --- NAVIGATION & INITIALIZATION ---
        const pages = document.querySelectorAll('.page');
        const headerTitle = document.getElementById('header-title');
        const headerIcon = document.getElementById('header-icon');
        const sidebar = document.getElementById('account-sidebar');
        const sidebarBackdrop = document.getElementById('account-sidebar-backdrop');
        const sidebarToggle = document.getElementById('account-sidebar-toggle');
        const subNavItems = document.querySelectorAll('.sub-nav-item');
        const subPages = document.querySelectorAll('.sub-page');

        function showPage(pageId) {
            const icons = {
                dasbor: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>`,
                kasir: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4z"></path></svg>`,
                transaksi: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
                laporan: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>`,
                produk: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`,
                hutang: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>`,
                pengaturan: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`
            };

            pages.forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            const pageElement = document.getElementById(pageId);
            if (pageElement) pageElement.classList.add('active');
            
            document.querySelectorAll(`.nav-item[data-page="${pageId}"]`).forEach(item => {
                item.classList.add('active');
            });

            const bottomNavItem = document.querySelector(`nav .nav-item[data-page="${pageId}"] .nav-text`);
            if (bottomNavItem) {
                 headerTitle.textContent = bottomNavItem.textContent;
            } else {
                 headerTitle.textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);
            }

            if (headerIcon) {
                headerIcon.innerHTML = icons[pageId] || '';
            }
        }

        document.body.addEventListener('click', e => {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                e.preventDefault();
                const pageId = navItem.dataset.page;
                showPage(pageId);
                if (pageId === 'pengaturan') showSubPage('pengaturan-main');
                 if (window.innerWidth < 1024) { // Selalu tutup sidebar di mode portrait/mobile
                    closeSidebar();
                }
            }
        });

        function openSidebar() { 
            sidebar.classList.remove('-translate-x-full'); 
            sidebarBackdrop.classList.remove('hidden'); 
        }
        function closeSidebar() { 
            sidebar.classList.add('-translate-x-full'); 
            sidebarBackdrop.classList.add('hidden'); 
        }
        function showSubPage(subPageId) {
            subPages.forEach(sp => sp.classList.remove('active'));
            document.getElementById(subPageId)?.classList.add('active');
        }

        sidebarToggle.addEventListener('click', openSidebar);
        sidebarBackdrop.addEventListener('click', closeSidebar);
        
        // --- Swipe Gesture for Sidebar ---
        let touchStartX = 0;
        let touchEndX = 0;

        function handleGesture() {
            if (touchEndX === 0) return; // Mencegah trigger saat tap
            const swipeDistance = touchEndX - touchStartX;
            const isSidebarOpen = !sidebar.classList.contains('-translate-x-full');

            // Geser Kanan untuk Buka (hanya jika dimulai dari tepi kiri)
            if (swipeDistance > 75 && !isSidebarOpen && touchStartX < 50) {
                openSidebar();
            }

            // Geser Kiri untuk Tutup
            if (swipeDistance < -75 && isSidebarOpen) {
                closeSidebar();
            }
            
            touchStartX = 0;
            touchEndX = 0;
        }

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchmove', e => {
            touchEndX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchend', handleGesture);


        subNavItems.forEach(item => item.addEventListener('click', e => { e.preventDefault(); showSubPage(item.dataset.subpage); }));
        document.querySelectorAll('.back-to-settings').forEach(btn => btn.addEventListener('click', e => { e.preventDefault(); showSubPage('pengaturan-main'); }));


        // Initialize app
        loadData();
        setInitialFilter();
        renderAll();
        showPage('dasbor');
        document.getElementById('kasir-produk-tanggal').valueAsDate = new Date();
        document.getElementById('kasir-jasa-tanggal').valueAsDate = new Date();
        document.getElementById('kasir-aplikasi-tanggal').valueAsDate = new Date();

        // --- Splash Screen Logic ---
        const splashScreen = document.getElementById('splash-screen');
        // Wait a bit to ensure everything is rendered, then start fade out
        setTimeout(() => {
            splashScreen.classList.add('opacity-0');
            // After fade out animation is complete, hide it completely so it's not interactable
            setTimeout(() => {
                splashScreen.style.display = 'none';
            }, 500); // This duration must match the CSS transition duration (duration-500)
        }, 1500); // Show splash screen for 1.5 seconds
    });
    </script>
</body>
</html>
