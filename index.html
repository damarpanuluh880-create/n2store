<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nusadua - Konter Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/damarpanuluh880-create/n2store@refs/heads/main/style.css">
      <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Warna dasar UI, diambil dari analisis gambar
                        'gopay-teal': '#00a2b7', // Warna teal khas untuk ikon/tulisan GoPay
                        'gopay-green': '#009933', // Warna hijau untuk saldo masuk/koin
                        'bg-light': '#f0f2f5', // Warna latar belakang sangat terang
                        'bg-card': '#ffffff', // Warna latar belakang kartu
                    },
                }
            }
        }
    </script>
  
      <style>
        body {
            background-color: #eeeef3;
        }
                .card-light {
            background-color: #ffffff; /* Kartu putih */
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* Bayangan lembut */
        }
        .header-gradient-1 {
            background: linear-gradient(to right, #ef4444, #f97316); /* Merah-Oranye */
        }
        .header-gradient-2 {
            background: linear-gradient(to right, #6366f1, #a855f7); /* Ungu-Biru */
        }
        .icon-bg {
            background-color: #e2e8f0; /* Abu-abu terang untuk latar belakang ikon */
        }
        .glass-panel2 {=
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .warna-kartu {background-color: #f9fafc;}
        /* Custom gradient text utility */
        .text-glow2 {
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .card-mono {
            background-color: #ffffff; /* Kartu putih */
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(100, 149, 237, 0.15); /* Bayangan biru lembut */
            border-left: 5px solid #3b82f6; /* Garis pemisah biru */
        }
        .header-mono {
            background-color: #e0f2fe; /* Biru sangat muda */
            color: #1d4ed8; /* Biru tua untuk teks */
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
                /* Gaya untuk kartu di dalam kartu monokrom */
        .inner-card-mono {
            background-color: #f1f5f9; /* Abu-abu kebiruan lembut */
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 1rem;
            border-left: 3px solid #60a5fa; /* Garis tipis biru */
        }
                .inner-card-pro {
            background-color: #f9fafb; /* Abu-abu sangat-sangat lembut */
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 1.25rem;
            border: 1px solid #e5e7eb; /* Garis solid tipis */
        }
        .detail-value-pro {
            font-weight: 700;
            color: #1f2937; /* Kontras tinggi untuk angka */
        }
        .accent-text-blue {
            color: #1d4ed8; /* Blue 700 */
        }
    </style>
</head>
<body class="h-dynamic w-full overflow-hidden flex text-sm md:text-base">

    <!-- Sidebar Modern Dark Theme -->
    <aside class="w-24 h-full bg-[#0f172a] flex flex-col items-center py-8 z-20 border-r border-slate-800 hidden lg:flex transition-all duration-300 shadow-2xl relative overflow-hidden">
        <!-- Decoration Ambient Light -->
        <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-indigo-500/10 to-transparent pointer-events-none"></div>

        <div class="mb-10 text-3xl relative z-10">
             <i class="fa-solid fa-cube text-transparent bg-clip-text bg-gradient-to-br from-indigo-400 to-cyan-400 filter drop-shadow-lg animate-pulse"></i>
        </div>
        
        <nav class="flex-1 flex flex-col gap-4 w-full px-4 relative z-10">
            <!-- Dashboard -->
            <button onclick="switchPage('dashboard')" id="nav-dashboard" class="nav-link active group relative h-12 w-12 mx-auto rounded-2xl flex items-center justify-center transition-all duration-300 hover:bg-slate-800" title="Dashboard">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl opacity-0 group-[.active]:opacity-100 transition-opacity duration-300 shadow-lg shadow-indigo-500/25"></div>
                <i class="fa-solid fa-chart-pie relative z-10 text-slate-500 group-hover:text-indigo-400 group-[.active]:text-white text-lg transition-colors duration-300"></i>
            </button>
            
            <!-- Transactions -->
            <button onclick="switchPage('transactions')" id="nav-transactions" class="nav-link group relative h-12 w-12 mx-auto rounded-2xl flex items-center justify-center transition-all duration-300 hover:bg-slate-800" title="Transaksi Manual">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl opacity-0 group-[.active]:opacity-100 transition-opacity duration-300 shadow-lg shadow-indigo-500/25"></div>
                <i class="fa-solid fa-wallet relative z-10 text-slate-500 group-hover:text-indigo-400 group-[.active]:text-white text-lg transition-colors duration-300"></i>
            </button>

            <!-- POS -->
            <button onclick="switchPage('pos')" id="nav-pos" class="nav-link group relative h-12 w-12 mx-auto rounded-2xl flex items-center justify-center transition-all duration-300 hover:bg-slate-800" title="Kasir">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl opacity-0 group-[.active]:opacity-100 transition-opacity duration-300 shadow-lg shadow-indigo-500/25"></div>
                <i class="fa-solid fa-cash-register relative z-10 text-slate-500 group-hover:text-indigo-400 group-[.active]:text-white text-lg transition-colors duration-300"></i>
            </button>

             <!-- Debt -->
            <button onclick="switchPage('debt')" id="nav-debt" class="nav-link group relative h-12 w-12 mx-auto rounded-2xl flex items-center justify-center transition-all duration-300 hover:bg-slate-800" title="Buku Hutang">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl opacity-0 group-[.active]:opacity-100 transition-opacity duration-300 shadow-lg shadow-indigo-500/25"></div>
                <i class="fa-solid fa-address-book relative z-10 text-slate-500 group-hover:text-indigo-400 group-[.active]:text-white text-lg transition-colors duration-300"></i>
            </button>

            <!-- Products -->
            <button onclick="switchPage('products')" id="nav-products" class="nav-link group relative h-12 w-12 mx-auto rounded-2xl flex items-center justify-center transition-all duration-300 hover:bg-slate-800" title="Produk">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl opacity-0 group-[.active]:opacity-100 transition-opacity duration-300 shadow-lg shadow-indigo-500/25"></div>
                <i class="fa-solid fa-box-open relative z-10 text-slate-500 group-hover:text-indigo-400 group-[.active]:text-white text-lg transition-colors duration-300"></i>
            </button>

            <!-- Reports -->
            <button onclick="switchPage('reports')" id="nav-reports" class="nav-link group relative h-12 w-12 mx-auto rounded-2xl flex items-center justify-center transition-all duration-300 hover:bg-slate-800" title="Laporan">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl opacity-0 group-[.active]:opacity-100 transition-opacity duration-300 shadow-lg shadow-indigo-500/25"></div>
                <i class="fa-solid fa-file-invoice relative z-10 text-slate-500 group-hover:text-indigo-400 group-[.active]:text-white text-lg transition-colors duration-300"></i>
            </button>
            
            <!-- Settings -->
            <button onclick="switchPage('settings')" id="nav-settings" class="nav-link group relative h-12 w-12 mx-auto rounded-2xl flex items-center justify-center transition-all duration-300 hover:bg-slate-800" title="Pengaturan">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl opacity-0 group-[.active]:opacity-100 transition-opacity duration-300 shadow-lg shadow-indigo-500/25"></div>
                <i class="fa-solid fa-gear relative z-10 text-slate-500 group-hover:text-indigo-400 group-[.active]:text-white text-lg transition-colors duration-300"></i>
            </button>
        </nav>
        
        <div class="mt-auto relative z-10">
            <button onclick="toggleAccountsDrawer()" class="h-12 w-12 mx-auto rounded-full overflow-hidden border-2 border-slate-700 hover:border-indigo-400 hover:scale-110 transition shadow-lg shadow-black/20 group">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full bg-slate-800 opacity-90 group-hover:opacity-100 transition">
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-hidden relative">
        
        <!-- === DASHBOARD VIEW (DARK MODE BACKGROUND) === -->
        <div id="dashboard-view" class="h-full w-full overflow-y-auto p-2 md:p-6 lg:p-8 transition-opacity duration-300 pb-40 lg:pb-8">
            <!-- Mobile Header -->
            <header class="lg:hidden flex justify-between items-center mb-4">
                <div class="flex items-center gap-3"><i class="fa-solid fa-cube text-indigo-500 text-xl"></i><h1 class="font-bold text-lg text-slate-700">Nusadua</h1></div>
                <!-- Settings Button moved here next to Profile -->
                <div class="flex items-center gap-3">
                    <button onclick="switchPage('settings')" class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 transition">
                        <i class="fa-solid fa-gear text-xs"></i>
                    </button>
                    <button onclick="toggleAccountsDrawer()" class="hover:opacity-80 transition">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-8 h-8 rounded-full border border-slate-600">
                    </button>
                </div>
            </header>

            <!-- Header & Actions -->
            <div class="flex flex-row justify-between items-center mb-4 gap-2 md:gap-4">
                <div class="min-w-0 flex-1">
                    <h1 class="text-lg md:text-3xl font-bold text-slate-700 tracking-tight leading-tight truncate md:overflow-visible">Halo, <span class="text-gradient bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">Galih & Nussa</span></h1>
                    <p id="header-date-display" class="font-semibold text-slate-700 text-[10px] md:text-sm mt-0.5 md:mt-1 truncate">Ringkasan Konter Hari Ini</p>
                </div>
                <div class="flex gap-2 md:gap-2 shrink-0">
                    <button onclick="openNotesModal()" class="bg-amber-700 border border-amber-500/50 text-white hover:bg-amber-500 hover:text-white px-2.5 py-1.5 rounded-lg text-[8px] md:text-sm transition flex items-center shadow-lg shadow-amber-900/20"><i class="fa-regular fa-note-sticky mr-1"></i> <span class="hidden md:inline">Catatan</span><span class="md:hidden">Note</span></button>
                    <button onclick="switchPage('reports')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-2.5 py-1.5 rounded-lg text-[8px] md:text-sm shadow-md shadow-indigo-500/30 transition flex items-center gap-1.5 md:gap-2"><i class="fa-solid fa-download mr-1"></i> Report</button>
                    <button onclick="openTransactionModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-2.5 py-1.5 rounded-lg text-[8px] md:text-sm shadow-md shadow-indigo-500/30 transition flex items-center gap-1.5 md:gap-2"><i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Transaksi Baru</span><span class="md:hidden">Baru</span></button>
                </div>
            </div>

            <!-- MAIN LAYOUT GRID (FORCED COLUMNS) -->
            <!-- Layout Custom: 35% Kiri, 65% Kanan (Sesuai Request) -->
            <div class="grid grid-cols-[35%_65%] gap-2 md:gap-6 mb-2 md:mb-6 pt-7">
                
                <!-- KOLOM KIRI (Lebar 35%) -->
                <div class="flex flex-col gap-3 md:gap-6">
                    <!-- Slider Kartu -->
                    <div>
                        <div class="flex justify-between items-end mb-2 px-1">
                            <div><p class="text-[9px] md:text-[13px] font-semibold text-slate-700">Total Saldo <span id="total-accounts-count" class="hidden md:inline ">(0)</span></p><h3 class="text-sm md:text-2xl font-bold text-slate-700" id="total-assets-value">Rp 0</h3></div>
                            <!-- BADGE -->
                            <div id="total-assets-badge" class="text-[9px] md:text-xs font-medium px-1.5 py-0.5 md:px-2 md:py-1 rounded-full border flex items-center gap-1 bg-slate-700/50 border-slate-600 text-white">
                                0% <i class="fa-solid fa-minus"></i>
                            </div>
                        </div>
                        <!-- SLIDER CONTAINER -->
                        <div id="dashboard-accounts-slider" class="flex overflow-x-auto gap-2 md:gap-4 snap-x snap-mandatory hide-scroll pb-2 md:pb-4 cursor-grab select-none">
                            <!-- Kartu dirender JS -->
                        </div>
                        <!-- INDIKATOR DOTS -->
                        <div id="slider-dots" class="flex justify-center gap-1 mt-0 h-1 md:h-2"></div>
                    </div>

                    <!-- WIDGET: Ringkasan Keuangan -->
                    <div class="space-y-2 md:space-y-4">
                      
                        <h3 class="bg-gradient-to-r from-orange-700 to-rose-500 font-bold text-white text-[10px] md:text-xs p-3 uppercase tracking-wide mb-1 md:mb-4 hidden md:block">Ringkasan Keuangan</h3>
                        
                        <div class="card-light card-mono p-3 md:p-5 shadow-lg">
                            <div class="flex justify-between items-center">
                                <div class="min-w-0"><p class="text-[9px] md:text-sm text-slate-600 font-medium mb-0.5 md:mb-1 truncate">Total Tunai</p><h2 class="text-sm md:text-xl font-bold text-slate-900 mb-0.5 md:mb-1 truncate" id="sum-total-tunai">Rp 0</h2><p class="text-[8px] md:text-[10px] text-slate-500 hidden md:block">Modal + Tabungan + Laba + Cash</p></div>
                                <div class="relative h-10 w-10 flex items-center justify-center rounded-2xl bg-indigo-500/10 border border-indigo-500/20 shadow-[0_0_15px_rgba(99,102,241,0.3)] group-hover:scale-110 transition-transform duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                    </div>
                            </div>
                        </div>
                                              <!-- Kartu Tabungan (Full Width - Below Fee) -->
                        <div class="card-light p-3 md:p-5 shadow-lg card-mono">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-[9px] md:text-sm text-slate-600 font-medium mb-0.5 md:mb-1">Tabungan</p>
                                    <h3 class="text-sm md:text-xl font-bold text-orange-600 truncate" id="sum-tabungan">Rp 0</h3>
                                  <p class="text-[8px] md:text-[11px] text-slate-500 hidden md:block">Saldo Akun Tabungan</p>
                                </div>
                                <div class="relative h-12 w-12 flex items-center justify-center rounded-2xl bg-orange-500/10 border border-orange-500/20 shadow-[0_0_15px_rgba(249,115,22,0.3)] group-hover:scale-110 transition-transform duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                            </div>
                        </div>
                      <h3 class="bg-gradient-to-r from-blue-600 to-rose-900 font-bold text-white text-[10px] md:text-xs p-3 uppercase tracking-wide mb-1 md:mb-4 hidden md:block">Ringkasan BRI Nussa</h3>
                        <div class="card-light card-mono p-3 md:p-5 shadow-lg">
                            <div class="flex justify-between items-center">
                                <div class="min-w-0"><p class="text-[9px] md:text-sm text-slate-500 font-medium mb-0.5 md:mb-1 truncate">BRI Nussa</p><h2 class="text-sm md:text-xl font-bold text-blue-900 mb-0.5 md:mb-1 truncate" id="sum-bri-nussa">Rp 0</h2><p class="text-[8px] md:text-[11px] text-slate-400 hidden md:block">Saldo Real - Fee BRI Link</p></div>
                                <div class="relative h-12 w-12 flex items-center justify-center rounded-2xl bg-blue-500/10 border border-blue-500/20 shadow-[0_0_15px_rgba(59,130,246,0.3)] group-hover:scale-110 transition-transform duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                            </div>
                        </div>
                        
                        <!-- UPDATED: FEE & TABUNGAN (STACKED & FULL WIDTH) -->
                        <!-- Kartu Fee BRI (Full Width) -->
                        <div class="card-light card-mono p-3 md:p-5 shadow-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-[9px] md:text-sm text-slate-500 font-medium mb-0.5 md:mb-1">Fee BRI Link</p>
                                    <h3 class="text-sm md:text-xl font-bold text-purple-600 truncate" id="sum-fee-bri">Rp 0</h3>
                                  <p class="text-[8px] md:text-[11px] text-slate-500 hidden md:block">Saldo Fee BRI Link</p>
                                </div>
                                <div class="relative h-12 w-12 flex items-center justify-center rounded-2xl bg-purple-500/10 border border-purple-500/20 shadow-[0_0_20px_rgba(168,85,247,0.5)] group-hover:scale-110 transition-transform duration-300">
                        <!-- ICON BARU: Simbol Dolar ($) -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                            </div>
                        </div>



                        <!-- WIDGET PIUTANG (FIXED HEIGHT 400px) -->
                        <div class="card-light p-3 md:p-4 rounded-xl shadow-lg relative overflow-hidden h-[400px] flex flex-col">
                             <div class="flex justify-between items-center mb-2 md:mb-3 relative z-10 shrink-0">
                                <h3 class="font-bold text-[10px] md:text-lg text-slate-700">Daftar Piutang</h3>
                                <button onclick="switchPage('debt')" class="bg-slate-800 hover:bg-slate-700 border border-purple-500/20 pr-2 pl-2 rounded-2xl text-[5px] md:text-[10px] text-white font-semibold">Lihat Semua</button>
                            </div>
                            <div id="dashboard-debt-preview" class="space-y-2 relative z-10 overflow-y-auto custom-scrollbar flex-1 pr-1"></div> 
                        </div>

                        <!-- WIDGET TERLARIS (FIXED HEIGHT 400px) -->
                        <div class="card-light p-3 md:p-4 rounded-xl shadow-lg relative overflow-hidden h-[400px] flex flex-col">
                            <div class="flex justify-between items-center mb-2 md:mb-3 relative z-10 shrink-0">
                                <h3 class="font-bold text-[10px] md:text-lg text-slate-700">Produk Terlaris</h3>
                            </div>
                            <div id="dashboard-top-products" class="space-y-2 relative z-10 overflow-y-auto custom-scrollbar flex-1 pr-1"></div> 
                        </div>
                    </div>
                </div>

                <!-- KOLOM KANAN (Lebar 65%) -->
                <div class="w-full min-w-0 flex flex-col gap-3 md:gap-6 pr-5">
                    
                    <!-- PANEL ANALISA PENJUALAN (FIXED HEIGHT 750px) -->
                    <div class="card-light p-3 md:p-6 rounded-xl md:rounded-2xl h-[750px] flex flex-col text-white shadow-md relative overflow-hidden shrink-0">


                        <div class="flex justify-between items-start mb-3 md:mb-6 relative z-10 shrink-0">
                            <div><h3 class="font-bold text-lg md:text-xl text-slate-600">Analisa Penjualan</h3><p class="text-[9px] md:text-xs text-slate-500 hidden md:block">Performa Penjualan Produk, Jasa & Aplikasi</p></div>
                            <select id="analytics-filter" onchange="updateSalesAnalysis(this.value)" class="bg-slate-700/50 border border-slate-600 rounded-lg px-2 py-1 md:px-3 md:py-1.5 text-[9px] md:text-xs text-slate-300 focus:outline-none focus:border-indigo-500 cursor-pointer transition hover:bg-slate-600/50">
                                <option value="today" selected>Hari Ini</option><option value="week">Minggu</option><option value="month">Bulan</option><option value="all">Semua</option>
                            </select>
                        </div>

                        <!-- Grid Analisa dipaksa 2 kolom dengan Rasio 40:60 -->
                        <div class="grid grid-cols-5 gap-3 md:gap-6 mb-3 md:mb-6 relative z-10 shrink-0">
                            <!-- Sisi Kiri: Penjualan Produk (40% -> col-span-2) -->
                            <div class="col-span-2 space-y-2 md:space-y-4">
                                <div class="flex items-center gap-1 md:gap-2 mb-1 md:mb-2"><i class="fa-solid fa-store text-indigo-400 text-[10px] md:text-base"></i><span class="text-[9px] md:text-xs font-bold text-indigo-400 tracking-wide">PRODUK</span></div>
                                <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-900 mb-0.5 md:mb-1">Produk Terjual</p><h4 class="text-xs md:text-lg font-bold text-slate-700 truncate pb-3" id="ana-prod-sold">0 Pcs</h4></div>
                              <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-900 mb-0.5 md:mb-1">Jasa Terjual</p><h4 class="text-xs md:text-lg font-bold text-slate-700 truncate pb-3" id="ana-service-count">0</h4></div>
                                <div class="border-b border-slate-300"><p class="text-[8px] md:text-[11px] text-slate-600 mb-0.5 md:mb-1">Modal Terpakai</p><h4 class="text-xs md:text-lg font-bold text-slate-500 truncate pb-3" id="ana-modal-used">Rp 0</h4></div>
                                <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-600 uppercase mb-0.5 md:mb-1 font-bold">Saldo Modal</p><h4 class="text-xs md:text-lg font-bold text-indigo-300 truncate pb-3" id="ana-asset-value">Rp 0</h4></div>
                                <!-- NEW CARD: Pengeluaran Rumah -->
                                <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-600 uppercase mb-0.5 md:mb-1 font-bold">Peng. Rumah</p><h4 class="text-xs md:text-lg font-bold text-rose-400 truncate pb-3" id="ana-home-expense">Rp 0</h4></div>
                            </div>
                            
                            <!-- Sisi Kanan: Laba Penjualan (60% -> col-span-3) -->
                            <div class="col-span-3 space-y-2 md:space-y-4">
                                <div class="flex items-center gap-1 md:gap-2 mb-1 md:mb-2"><i class="fa-solid fa-sack-dollar text-emerald-400 text-[10px] md:text-base"></i><span class="text-[9px] md:text-xs font-bold text-emerald-400 tracking-wide">LABA</span></div>
                                <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-600 mb-0.5 md:mb-1">Laba Produk</p><h4 class="text-xs md:text-lg font-bold text-emerald-400 truncate pb-3" id="ana-profit-prod">Rp 0</h4></div>
                                
                                    <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-600 mb-0.5 md:mb-1">Laba Jasa</p><h4 class="text-xs md:text-lg font-bold text-emerald-400 truncate pb-3" id="ana-profit-service">Rp 0</h4></div>
                                    <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-600 mb-0.5 md:mb-1">Laba App</p><h4 class="text-xs md:text-lg font-bold text-emerald-400 truncate pb-3" id="ana-profit-app">Rp 0</h4></div>
  
                                    <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-600 mb-0.5 md:mb-1">Total Fee</p><h4 class="text-xs md:text-lg font-bold text-emerald-400 truncate pb-3" id="ana-profit-fee">Rp 0</h4></div>
                                
                                <div class="border-b border-slate-300"><p class="text-[8px] md:text-[12px] text-slate-600 mb-0.5 md:mb-1 font-bold uppercase">Total Laba</p><h4 class="text-xs md:text-lg font-bold text-emerald-400 truncate pb-3" id="ana-total-profit">Rp 0</h4></div>
                            </div>
                        </div>

                        <!-- Chart Area (FIXED HEIGHT 350px) -->
                        <div class="w-full relative z-10 mt-2 md:mt-4 h-[350px]">
                            <canvas id="profitLineChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- TRX MANUAL (AUTO FILL HEIGHT / FLEX-1) -->
                    <div class="card-light p-3 md:p-6 rounded-xl md:rounded-2xl flex-1 flex flex-col text-white shadow-xl relative overflow-hidden">
                        <div class="flex justify-between items-center mb-3 md:mb-6 relative z-10 shrink-0">
                            <h3 class="font-bold text-sm md:text-xl text-slate-600">Riwayat Transaksi</h3>
                            <button onclick="switchPage('transactions')" class="bg-slate-800 hover:bg-slate-700 border border-purple-500/20 pr-2 pl-2 rounded-2xl text-[5px] md:text-[10px] text-white font-semibold">Lihat Semua</button>
                        </div>
                        <!-- List container fills the card height -->
                        <div id="dashboard-trx-list" class="space-y-1 md:space-y-2 relative z-10 flex-1 overflow-y-auto custom-scrollbar pr-1"></div> 
                    </div>

                </div>
            </div>

            <!-- NEW BOTTOM SECTION: GRAFIK & POS TERKINI (50/50) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-6 mb-20">
                <!-- WIDGET: GRAFIK -->
                <div class="card-light p-3 md:p-5 rounded-xl md:rounded-2xl shadow-xl flex flex-col gap-2 md:gap-4 relative overflow-hidden">
                    
                    <div class="flex justify-between items-center relative z-10">
                        <h3 class="font-bold text-xs md:text-lg text-slate-700 justify items-center">Laba vs Pengeluaran</h3>
                    </div>
                    <div class="h-64 md:h-72 w-full relative z-10">
                        <canvas id="profitExpenseChart"></canvas>
                    </div>
                    <div class="grid grid-cols-2 gap-2 md:gap-4 border-t border-slate-700 pt-2 md:pt-4 relative z-10">
                        <div class="text-center border-r border-slate-700 pr-1 md:pr-2">
                            <div class="flex items-center justify-center gap-1 md:gap-2 mb-0.5 md:mb-1 text-emerald-400">
                                <i class="fa-solid fa-sack-dollar text-[9px] md:text-xs"></i>
                                <p class="text-[8px] md:text-[10px] uppercase tracking-wide font-bold">Laba</p>
                            </div>
                            <h3 class="text-xs md:text-lg font-bold text-white truncate" id="widget-total-laba">Rp 0</h3>
                        </div>
                        <div class="text-center pl-1 md:pl-2">
                            <div class="flex items-center justify-center gap-1 md:gap-2 mb-0.5 md:mb-1 text-rose-400">
                                <i class="fa-solid fa-house-chimney text-[9px] md:text-xs"></i>
                                <p class="text-[8px] md:text-[10px] uppercase tracking-wide font-bold">Rumah</p>
                            </div>
                            <h3 class="text-xs md:text-lg font-bold text-white truncate" id="widget-total-rumah">Rp 0</h3>
                        </div>
                    </div>
                </div>

                <!-- WIDGET: Penjualan Terkini (POS) -->
                <div class="card-light p-3 md:p-5 rounded-xl md:rounded-2xl shadow-xl relative overflow-hidden h-full">
                    <div class="flex justify-between items-center mb-2 md:mb-4 relative z-10">
                        <h3 class="font-bold text-xs md:text-lg text-slate-700">Riwayat Penjualan</h3>
                        <button onclick="openPOSHistoryModal()" class="bg-slate-800 hover:bg-slate-700 border border-purple-500/20 pr-2 pl-2 rounded-2xl text-[5px] md:text-[10px] text-white font-semibold">Lihat Semua</button>
                    </div>
                    <div id="dashboard-pos-list" class="space-y-1 md:space-y-2 relative z-10 max-h-[350px] overflow-y-auto custom-scrollbar pr-1"></div>
                </div>
            </div>

        </div>

        <!-- === TRANSACTIONS VIEW === -->
        <div id="transactions-view" class="h-full w-full hidden opacity-0 transition-opacity duration-300 overflow-hidden relative">
            <div class="h-full w-full flex flex-col p-4 md:p-6 pb-40 lg:pb-8">
                <!-- Header -->
                <div class="flex justify-between items-center mb-4">
                    <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Riwayat <span class="text-gradient">Manual</span></h2><p class="text-xs text-slate-500">Transaksi Pemasukan, Pengeluaran & Transfer (Non-Kasir/Non-Hutang)</p></div>
                    <button onclick="openTransactionModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 flex items-center gap-2 transition transform hover:scale-105"><i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Input Transaksi</span></button>
                </div>
                <!-- Filters -->
                <div class="flex flex-col gap-3 mb-4">
                    <div class="flex gap-2 overflow-x-auto hide-scroll pb-1">
                        <button onclick="setTrxTimeFilter('all')" id="tf-time-all" class="px-4 py-1.5 rounded-full bg-indigo-600 text-white text-xs font-medium transition shadow-lg border border-indigo-500">Semua Waktu</button>
                        <button onclick="setTrxTimeFilter('today')" id="tf-time-today" class="px-4 py-1.5 rounded-full glass-panel hover:bg-white text-slate-600 text-xs font-medium transition">Hari Ini</button>
                        <button onclick="setTrxTimeFilter('week')" id="tf-time-week" class="px-4 py-1.5 rounded-full glass-panel hover:bg-white text-slate-600 text-xs font-medium transition">Minggu Ini</button>
                        <button onclick="setTrxTimeFilter('month')" id="tf-time-month" class="px-4 py-1.5 rounded-full glass-panel hover:bg-white text-slate-600 text-xs font-medium transition">Bulan Ini</button>
                    </div>
                </div>
                <!-- List -->
                <div class="flex-1 overflow-y-auto custom-scrollbar pb-20" id="transactions-list-full"></div>
            </div>
        </div>

        <!-- === POS VIEW (DARK THEME) === -->
        <div id="pos-view" class="h-full w-full hidden opacity-0 transition-opacity duration-300 overflow-hidden relative bg-slate-900">
            <div class="h-full w-full flex flex-col relative z-10 p-4 md:p-6 pb-24 md:pb-6">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-white"><span class="md:text-4xl text-gradient bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">Kasir</span></h2>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="openPOSHistoryModal()" class="bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700 px-3 py-2 rounded-lg text-xs font-bold shadow-sm flex items-center gap-2 transition">
                            <i class="fa-solid fa-clock-rotate-left"></i> <span class="hidden md:inline">Riwayat</span>
                        </button>
                        <button onclick="openManualSalesModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg shadow-indigo-500/30 flex items-center gap-2 transition">
                            <i class="fa-solid fa-pen-to-square"></i> <span class="hidden md:inline">Transaksi</span>
                        </button>
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                            <input type="text" id="pos-search" onkeyup="filterPOSCatalog()" placeholder="Cari..." class="bg-slate-800 border border-slate-700 text-white placeholder-slate-500 rounded-full pl-9 pr-4 py-2 text-xs md:text-sm focus:outline-none focus:border-indigo-500 transition w-32 md:w-48">
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar pb-40">
                    <div id="section-bestseller">
                        <div class="flex items-center gap-2 mb-3 mt-1"><i class="fa-solid fa-fire text-orange-500"></i><h3 class="text-slate-300 font-bold text-base md:text-lg">15 Produk Terlaris</h3></div>
                        <div id="pos-bestseller-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 md:gap-3 mb-8"></div>
                    </div>
                    <div id="section-separator" class="border-t border-slate-700 my-6"></div>
                    <div id="section-all">
                        <div class="flex items-center gap-2 mb-3"><i class="fa-solid fa-layer-group text-slate-400"></i><h3 class="text-slate-400 font-bold text-sm md:text-base">Daftar Produk Lengkap</h3></div>
                        <div id="pos-category-filter" class="flex gap-2 mb-4 overflow-x-auto pb-1 hide-scroll shrink-0"></div>
                        <div id="pos-all-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
                    </div>
                </div>
            </div>
        </div>

         <!-- === DEBT VIEW (FIXED STRUCTURE) === -->
         <div id="debt-view" class="h-full w-full hidden opacity-0 transition-opacity duration-300 overflow-hidden relative">
            <div class="h-full w-full flex flex-col p-4 md:p-6 pb-40 lg:pb-8">
                <div class="flex justify-between items-center mb-6">
                    <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Buku <span class="text-gradient">Kasbon</span></h2><p class="text-xs text-slate-500">Kelola piutang pelanggan</p></div>
                    <div class="flex items-center gap-2">
                        <button onclick="openDebtHistoryModal()" class="glass-panel hover:bg-white text-slate-600 px-3 py-2 rounded-lg text-xs font-bold shadow-sm flex items-center gap-2 transition"><i class="fa-solid fa-clock-rotate-left"></i> <span class="hidden md:inline">Riwayat Hutang</span></button>
                        <button onclick="openDebtModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm shadow-lg shadow-indigo-200 flex items-center gap-2 transition"><i class="fa-solid fa-plus"></i> Hutang Baru</button>
                    </div>
                </div>
                <!-- Container Daftar Hutang yang Sebelumnya Hilang -->
                <div id="debt-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto custom-scrollbar pb-20"></div>
            </div>
        </div>

        <!-- === REPORTS VIEW (UPDATED) === -->
        <div id="reports-view" class="h-full w-full hidden opacity-0 transition-opacity duration-300 overflow-hidden relative">
            <div class="h-full w-full flex flex-col p-4 md:p-6 pb-40 lg:pb-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">Laporan <span class="text-gradient">Eksekutif</span></h2>
                        <p class="text-xs text-slate-500">Ringkasan kesehatan bisnis secara global</p>
                    </div>
                    <button onclick="renderReports()" class="bg-white border border-slate-200 text-indigo-600 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2">
                        <i class="fa-solid fa-rotate-right"></i> Refresh
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scrollbar pb-20">
                    <div id="report-content" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                        <!-- Konten Laporan akan di-render di sini oleh JS -->
                    </div>
                    
                    <!-- Footer Laporan -->
                    <div class="mt-8 text-center border-t border-slate-200 pt-6 pb-6">
                        <p class="text-xs text-slate-400">Laporan ini dibuat otomatis berdasarkan data real-time.</p>
                        <p class="text-[10px] text-slate-300 font-mono mt-1">NexFin Auto-Generated Report</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- === PRODUCTS VIEW === -->
        <div id="products-view" class="h-full w-full hidden opacity-0 transition-opacity duration-300 overflow-hidden relative">
             <div class="h-full w-full flex flex-col p-4 md:p-6 pb-24 md:pb-6">
                <div class="flex justify-between items-center mb-6">
                    <div><h2 class="text-xl md:text-2xl font-bold text-slate-800">Manajemen <span class="text-gradient">Produk</span></h2></div>
                    <button onclick="openProductModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm shadow-lg shadow-indigo-200 flex items-center gap-2 transition"><i class="fa-solid fa-plus"></i> Tambah</button>
                </div>
                <div class="flex-1 overflow-y-auto pb-20 custom-scrollbar">
                    <div class="glass-panel rounded-xl overflow-hidden bg-white">
                        <table class="w-full text-left text-sm text-slate-600">
                            <thead class="text-xs uppercase bg-slate-50 text-slate-500">
                                <tr><th class="px-4 py-3">Produk</th><th class="px-4 py-3">Modal</th><th class="px-4 py-3">Jual</th><th class="px-4 py-3 text-right">Aksi</th></tr>
                            </thead>
                            <tbody id="products-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- === SETTINGS VIEW (DARK THEME) === -->
        <div id="settings-view" class="h-full w-full hidden opacity-0 transition-opacity duration-300 overflow-hidden relative">
            <div class="h-full w-full flex flex-col p-4 md:p-6 pb-40 lg:pb-8">
                <h2 class="text-xl md:text-2xl font-bold text-white mb-6">Pengaturan <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">Data Master</span></h2>
                <div class="glass-panel rounded-2xl flex-1 flex flex-col overflow-hidden bg-slate-800 border border-slate-700 shadow-xl">
                    <div class="flex border-b border-slate-700 overflow-x-auto hide-scroll">
                        <button onclick="switchSettingTab('accounts')" id="tab-btn-accounts" class="setting-tab active flex-1 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-700 transition whitespace-nowrap px-4 border-b-2 border-transparent">Akun / Bank</button>
                        <button onclick="switchSettingTab('trxcats')" id="tab-btn-trxcats" class="setting-tab flex-1 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-700 transition whitespace-nowrap px-4 border-b-2 border-transparent">Kategori Transaksi</button>
                        <button onclick="switchSettingTab('prodcats')" id="tab-btn-prodcats" class="setting-tab flex-1 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-700 transition whitespace-nowrap px-4 border-b-2 border-transparent">Kategori Produk</button>
                        <!-- NEW TAB BUTTON -->
                        <button onclick="switchSettingTab('backup')" id="tab-btn-backup" class="setting-tab flex-1 py-4 text-sm font-medium text-rose-400 hover:text-rose-300 hover:bg-slate-700 transition whitespace-nowrap px-4 border-b-2 border-transparent">Backup Data</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
                        <!-- Existing Tabs -->
                        <div id="tab-accounts" class="space-y-4">
                            <div class="flex justify-between items-center mb-4"><p class="text-sm text-slate-700">Daftar akun bank.</p><button onclick="openSettingModal('account')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition"><i class="fa-solid fa-plus mr-1"></i> Tambah Akun</button></div>
                            <div id="settings-accounts-list" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        </div>
                        <div id="tab-trxcats" class="hidden space-y-4">
                            <div class="flex justify-between items-center mb-4"><p class="text-xs text-slate-400">Label transaksi.</p><button onclick="openSettingModal('trxcat')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition"><i class="fa-solid fa-plus mr-1"></i> Tambah Kategori</button></div>
                            <div id="settings-trxcats-list" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
                        </div>
                        <div id="tab-prodcats" class="hidden space-y-4">
                            <div class="flex justify-between items-center mb-4"><p class="text-xs text-slate-400">Kelompok produk.</p><button onclick="openSettingModal('prodcat')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition"><i class="fa-solid fa-plus mr-1"></i> Tambah Kategori</button></div>
                            <div id="settings-prodcats-list" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
                        </div>
                        
                        <!-- NEW BACKUP TAB CONTENT (DARK MODE) -->
                        <div id="tab-backup" class="hidden space-y-6">
                            <div class="p-4 bg-white-900/20 rounded-xl border border-indigo-500/30">
                                <h4 class="font-bold text-indigo-400 mb-2">Export Data (Backup)</h4>
                                <p class="text-xs text-slate-400 mb-4">Unduh seluruh data aplikasi (Produk, Transaksi, Akun, Hutang) ke dalam format file JSON. Simpan file ini di tempat aman.</p>
                                <button onclick="handleExportData()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-bold shadow-md transition flex items-center gap-2">
                                    <i class="fa-solid fa-download"></i> Download Backup (.json)
                                </button>
                            </div>
                            
                            <div class="p-4 bg-slate-700/30 rounded-xl border border-slate-600">
                                <h4 class="font-bold text-slate-300 mb-2">Import Data (Restore)</h4>
                                <p class="text-xs text-slate-400 mb-4">Kembalikan data dari file backup JSON. <span class="text-rose-400 font-bold">Peringatan: Data saat ini akan ditimpa.</span></p>
                                <input type="file" id="import-file-input" accept=".json" class="hidden" onchange="handleImportFile(event)">
                                <button onclick="triggerImport()" class="px-4 py-2 bg-slate-700 border border-slate-500 hover:bg-slate-600 text-slate-200 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2">
                                    <i class="fa-solid fa-upload"></i> Pilih File Backup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- === TOAST CONTAINER === -->
    <div id="toast-container" class="toast-container"></div>

    <!-- === CUSTOM CONFIRM MODAL === -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform scale-95 transition-transform duration-200">
            <div class="text-center mb-6">
                <div class="w-12 h-12 rounded-full bg-rose-100 text-rose-500 flex items-center justify-center mx-auto mb-3 text-xl">
                    <i class="fa-solid fa-trash-can"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="modal-confirm-title">Konfirmasi Hapus</h3>
                <p class="text-sm text-slate-500 px-2" id="modal-confirm-msg">Apakah anda yakin ingin menghapus data ini?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-2.5 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition text-sm">Batal</button>
                <button onclick="handleConfirmYes()" class="flex-1 py-2.5 rounded-xl font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-lg shadow-rose-200 transition text-sm">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <!-- === RESTORED DEBT MODAL (FIXED ERROR) === -->
    <div id="debt-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[75] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 transform scale-95 transition-all duration-300 bg-white shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800" id="debt-modal-title">Catat Hutang</h3>
                <button onclick="closeDebtModal()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <form id="debt-form" onsubmit="handleDebtSubmit(event)">
                <input type="hidden" id="debt-action" value="add">
                <input type="hidden" id="debt-person-id">
                <div class="space-y-4">
                    <!-- NEW: INPUT TANGGAL -->
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Tanggal</label>
                        <input type="date" id="debt-date" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200">
                    </div>

                    <div id="field-debt-name">
                        <label class="text-xs text-slate-500 block mb-1">Nama Peminjam</label>
                        <input type="text" id="debt-name" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200" placeholder="Nama Pelanggan">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Jumlah (Rp)</label>
                        <input type="number" id="debt-amount" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200" placeholder="0">
                    </div>
                    <div id="field-debt-account" class="hidden">
                        <label class="text-xs text-slate-500 block mb-1">Uang Masuk Ke (Pembayaran)</label>
                        <select id="debt-pay-account" class="w-full glass-input px-3 py-2 rounded-lg text-sm bg-white text-slate-700 border border-slate-200"></select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Catatan</label>
                        <input type="text" id="debt-note" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200" placeholder="Keterangan singkat">
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 transition mt-6" id="debt-submit-btn">Simpan</button>
            </form>
        </div>
    </div>

    <!-- === NEW MODALS (LIGHT THEME) === -->
    <div id="pos-history-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-2xl rounded-2xl flex flex-col max-h-[90vh] bg-white shadow-2xl">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                <div><h3 class="font-bold text-xl text-slate-800">Riwayat Penjualan Kasir</h3><p class="text-xs text-slate-500">Daftar transaksi produk fisik & digital</p></div>
                <button onclick="closePOSHistoryModal()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pb-40 custom-scrollbar bg-slate-50" id="pos-history-list"></div>
        </div>
    </div>

    <div id="debt-history-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-xl rounded-2xl flex flex-col max-h-[90vh] bg-white shadow-2xl">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                <div><h3 class="font-bold text-xl text-slate-800">Riwayat Mutasi Hutang</h3><p class="text-xs text-slate-500">Pencatatan & Pelunasan Kasbon</p></div>
                <button onclick="closeDebtHistoryModal()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pb-40 custom-scrollbar bg-slate-50" id="debt-history-list"></div>
        </div>
    </div>
    
    <!-- NEW: TRANSACTION DETAIL MODAL (Light Theme for Readability) -->
    <div id="trx-detail-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 transform scale-95 transition-all duration-300 bg-white shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-bold text-slate-800">Detail Transaksi</h3>
                <button onclick="closeTrxDetailModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div id="trx-detail-content" class="mb-6">
                <!-- Content injected by JS -->
            </div>
            
            <div class="flex gap-3">
                <button onclick="deleteCurrentTrx()" class="flex-1 py-2.5 border border-rose-200 text-rose-500 hover:bg-rose-50 rounded-xl font-bold text-sm transition"><i class="fa-solid fa-trash-can mr-2"></i>Hapus</button>
                <button id="btn-detail-edit" class="flex-1 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 transition"><i class="fa-solid fa-pen-to-square mr-2"></i>Edit</button>
            </div>
        </div>
    </div>

    <!-- NEW: NOTES MODAL -->
    <div id="notes-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 transform scale-95 transition-all duration-300 bg-white shadow-2xl flex flex-col max-h-[80vh]">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 shrink-0">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Catatan Harian</h3>
                    <p class="text-xs text-slate-500">Hal penting, to-do list, atau pengingat.</p>
                </div>
                <button onclick="closeNotesModal()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <!-- Input Area -->
            <div class="mb-4 shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="note-input" class="flex-1 glass-input px-4 py-3 rounded-xl text-sm text-slate-800 bg-slate-50 border-slate-200 focus:border-amber-400 focus:bg-white transition" placeholder="Tulis catatan di sini..." onkeypress="if(event.key==='Enter') handleAddNote()">
                    <button onclick="handleAddNote()" class="bg-amber-500 hover:bg-amber-600 text-white w-12 rounded-xl font-bold shadow-lg shadow-amber-200 transition flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Notes List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar pr-1 -mr-2" id="notes-list-container">
                <!-- Notes will be rendered here -->
            </div>
        </div>
    </div>

    <!-- === RESTORED & FIXED: TRANSACTION MODAL === -->
    <div id="transaction-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[85] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 transform scale-95 transition-all duration-300 bg-white shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800" id="trx-modal-title">Input Transaksi</h3>
                <button onclick="closeTransactionModal()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <form id="transaction-form" onsubmit="event.preventDefault(); handleTransactionSubmit();" class="space-y-4">
                <input type="hidden" id="trx-edit-id">
                <input type="hidden" id="trx-type" value="in">

                <!-- Type Selector Buttons -->
                <div class="grid grid-cols-4 gap-2 bg-slate-100 p-1 rounded-xl">
                    <button type="button" onclick="setTrxType('in')" id="btn-in" class="trx-btn py-2 rounded-lg text-xs font-bold transition bg-emerald-100 text-emerald-600">Masuk</button>
                    <button type="button" onclick="setTrxType('out')" id="btn-out" class="trx-btn py-2 rounded-lg text-xs font-bold transition text-slate-400 hover:bg-white">Keluar</button>
                    <button type="button" onclick="setTrxType('tf')" id="btn-tf" class="trx-btn py-2 rounded-lg text-xs font-bold transition text-slate-400 hover:bg-white">Transfer</button>
                    <button type="button" onclick="setTrxType('trx')" id="btn-trx" class="trx-btn py-2 rounded-lg text-xs font-bold transition text-slate-400 hover:bg-white">Trx</button>
                </div>

                <!-- Date & Amount -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Tanggal</label>
                        <input type="date" id="trx-date" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Jumlah (Rp)</label>
                        <input type="number" id="trx-amount" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200 focus:border-indigo-500" placeholder="0" required>
                    </div>
                </div>

                <!-- Account Selection -->
                <div>
                    <label id="label-account" class="text-xs text-slate-500 block mb-1">Masuk Ke</label>
                    <div class="relative">
                        <select id="trx-account-select" class="w-full glass-input px-3 py-2 rounded-lg text-sm bg-white text-slate-700 border border-slate-200 appearance-none"></select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                    </div>
                </div>

                <!-- Destination (Hidden by default) -->
                <div id="field-dest" class="hidden">
                    <label class="text-xs text-slate-500 block mb-1">Ke Rekening</label>
                    <div class="relative">
                        <select id="trx-dest-select" class="w-full glass-input px-3 py-2 rounded-lg text-sm bg-white text-slate-700 border border-slate-200 appearance-none"></select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                    </div>
                </div>
                
                <!-- Fee (Hidden by default) -->
                 <div id="field-fee" class="hidden">
                    <label class="text-xs text-slate-500 block mb-1">Biaya Admin (Fee)</label>
                    <input type="number" id="trx-fee" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200" placeholder="0">
                </div>

                <!-- Category -->
                <div>
                    <label class="text-xs text-slate-500 block mb-1">Kategori</label>
                    <div class="relative">
                        <select id="trx-category-select" class="w-full glass-input px-3 py-2 rounded-lg text-sm bg-white text-slate-700 border border-slate-200 appearance-none"></select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="text-xs text-slate-500 block mb-1">Catatan</label>
                    <textarea id="trx-notes" rows="2" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200" placeholder="Keterangan transaksi..."></textarea>
                </div>

                <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 transition">Simpan Transaksi</button>
            </form>
        </div>
    </div>

    <!-- MOBILE NAVIGATION BAR (NEW) -->
    <!-- Navigasi ini hanya muncul di layar kecil (lg:hidden) dan menempel di bawah -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#0f172a] border-t border-slate-800 flex justify-around items-center py-3 px-2 z-50 lg:hidden safe-area-bottom shadow-[0_-4px_10px_rgba(0,0,0,0.3)]">
        <button onclick="switchPage('dashboard')" id="mob-nav-dashboard" class="flex flex-col items-center gap-1 text-indigo-400 transition group w-12">
            <i class="fa-solid fa-chart-pie text-lg"></i>
            <span class="text-[9px] font-medium">Home</span>
        </button>
        
        <button onclick="switchPage('transactions')" id="mob-nav-transactions" class="flex flex-col items-center gap-1 text-slate-500 hover:text-indigo-400 transition group w-12">
            <i class="fa-solid fa-wallet text-lg"></i>
            <span class="text-[9px] font-medium">Trx</span>
        </button>
        
        <!-- POS Button (Center FAB) -->
        <div class="relative -top-6">
            <button onclick="switchPage('pos')" id="mob-nav-pos" class="w-14 h-14 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 text-white flex items-center justify-center shadow-lg shadow-indigo-500/50 transform transition active:scale-95 border-4 border-[#0f172a]">
                <i class="fa-solid fa-cash-register text-xl"></i>
            </button>
        </div>
        
        <button onclick="switchPage('debt')" id="mob-nav-debt" class="flex flex-col items-center gap-1 text-slate-500 hover:text-indigo-400 transition group w-12">
            <i class="fa-solid fa-book-skull text-lg"></i>
            <span class="text-[9px] font-medium">Hutang</span>
        </button>
        
        <button onclick="switchPage('products')" id="mob-nav-products" class="flex flex-col items-center gap-1 text-slate-500 hover:text-indigo-400 transition group w-12">
            <i class="fa-solid fa-box-open text-lg"></i>
            <span class="text-[9px] font-medium">Produk</span>
        </button>
    </nav>

    <div id="manual-sales-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[75] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 transform scale-95 transition-all duration-300 bg-white shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">Input Penjualan Manual</h3>
                <button onclick="closeManualSalesModal()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="flex border-b border-slate-200 mb-4">
                <button onclick="switchManualSalesTab('jasa')" id="tab-ms-jasa" class="manual-tab active flex-1 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 rounded-t-lg transition">Penjualan Jasa</button>
                <button onclick="switchManualSalesTab('aplikasi')" id="tab-ms-aplikasi" class="manual-tab flex-1 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 rounded-t-lg transition">Penjualan Aplikasi</button>
            </div>
            
            <!-- FORM JASA (UPDATED: REMOVED DESTINATION DROPDOWN) -->
            <form id="ms-form-jasa" onsubmit="handleManualServiceSubmit(event)" class="space-y-4">
                <div>
                    <label class="text-xs text-slate-500 block mb-1">Tanggal</label>
                    <input type="date" id="ms-jasa-date" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700">
                </div>
                <div>
                    <label class="text-xs text-slate-500 block mb-1">Nama Jasa</label>
                    <input type="text" id="ms-jasa-name" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700" placeholder="Contoh: Service LCD" required>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Harga Modal (Sparepart)</label>
                        <input type="number" id="ms-jasa-modal" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700" placeholder="0">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Harga Jual</label>
                        <input type="number" id="ms-jasa-price" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700" required>
                    </div>
                </div>
                
                <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 transition">Simpan Jasa</button>
            </form>

            <form id="ms-form-aplikasi" onsubmit="handleManualAppSubmit(event)" class="space-y-4 hidden">
                <div>
                    <label class="text-xs text-slate-500 block mb-1">Tanggal</label>
                    <input type="date" id="ms-app-date" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Dari Akun (Stok)</label>
                        <select id="ms-app-source" class="w-full glass-input px-3 py-2 rounded-lg text-sm bg-white text-slate-700"></select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Ke Akun (Terima)</label>
                        <select id="ms-app-dest" class="w-full glass-input px-3 py-2 rounded-lg text-sm bg-white text-slate-700"></select>
                    </div>
                </div>
                
                <!-- UPDATED: NAMA TRANSAKSI MENJADI DROPDOWN -->
                <div>
                    <label class="text-xs text-slate-500 block mb-1">Nama Transaksi / Aplikasi</label>
                    <select id="ms-app-name" class="w-full glass-input px-3 py-2 rounded-lg text-sm bg-white text-slate-700">
                        <option value="Order Kuota">Order Kuota</option>
                        <option value="Dana">Dana</option>
                        <option value="Save Plus">Save Plus</option>
                        <option value="Digipos">Digipos</option>
                        <option value="Buku Warung">Buku Warung</option>
                        <option value="I-Simple">I-Simple</option>
                        <option value="BRI Galih">BRI Galih</option>
                        <option value="BRI Nussa">BRI Nussa</option>
                        <option value="Go-Pay">Go-Pay</option>
                        <option value="Shopee Pay">Shopee Pay</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Harga Modal</label>
                        <input type="number" id="ms-app-modal" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700" required>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Harga Jual</label>
                        <input type="number" id="ms-app-price" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-slate-700" required>
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 transition">Simpan Transaksi</button>
            </form>
        </div>
    </div>

    <div id="accounts-overlay" onclick="toggleAccountsDrawer()" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[65] hidden transition-opacity duration-300"></div><div id="accounts-drawer" class="fixed top-0 right-0 h-full w-80 md:w-96 glass-drawer-right z-[70] transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col bg-white"><div class="p-5 border-b border-slate-200 flex justify-between items-center bg-white"><h3 class="font-bold text-xl text-slate-800">Daftar Akun</h3><button onclick="toggleAccountsDrawer()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button></div><div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar" id="drawer-accounts-list"></div><div class="p-5 border-t border-slate-200 bg-slate-50"><div class="flex justify-between mb-2 text-sm font-bold text-slate-700"><span>Total Aset</span><span class="text-emerald-600" id="drawer-total-assets">Rp 0</span></div></div></div>
    <button id="fab-cart-trigger" onclick="toggleFloatingCart()" class="fixed bottom-20 lg:bottom-8 right-4 lg:right-8 z-40 w-14 h-14 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg shadow-indigo-300 flex items-center justify-center transition transform hover:scale-110 hover:rotate-3 active:scale-95 hidden"><i class="fa-solid fa-cart-shopping text-xl"></i><span id="fab-badge" class="absolute -top-1 -right-1 w-6 h-6 bg-rose-500 rounded-full text-[10px] font-bold flex items-center justify-center border-2 border-white hidden">0</span></button>
    <div id="cart-overlay" onclick="toggleFloatingCart()" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[55] hidden transition-opacity duration-300"></div><div id="cart-drawer" class="fixed top-0 left-0 h-full w-80 md:w-96 glass-drawer z-[60] transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col bg-white"><div class="p-5 border-b border-slate-200 flex justify-between items-center bg-white"><h3 class="font-bold text-xl text-slate-800">Keranjang</h3><button onclick="toggleFloatingCart()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button></div><div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar" id="cart-items-container"></div><div class="p-5 border-t border-slate-200 bg-slate-50"><div class="flex justify-between mb-2 text-xs text-slate-500"><span>Subtotal</span><span id="cart-subtotal" class="font-mono">Rp 0</span></div><div class="flex justify-between mb-2 text-xs text-slate-500"><span>Total Modal</span><span id="cart-modal-total" class="font-mono">Rp 0</span></div><div class="flex justify-between mb-4 text-lg font-bold text-slate-800"><span>Total</span><span class="text-xl text-indigo-600" id="cart-total">Rp 0</span></div><button onclick="handleCheckout()" class="w-full py-3.5 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl text-white font-bold shadow-lg shadow-indigo-200 transition">Bayar & Simpan</button></div></div>

    <!-- PRODUCT MODAL (UPDATED: LIGHT THEME) -->
    <div id="product-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <!-- Changed: bg-slate-800 -> bg-white, border-slate-700 -> shadow-2xl -->
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 transform scale-95 transition-all duration-300 bg-white shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <!-- Changed: text-white -> text-slate-800 -->
                <h3 class="text-xl font-bold text-slate-800" id="modal-title">Tambah Produk</h3>
                <button onclick="closeProductModal()" class="text-slate-400 hover:text-rose-500"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <form id="product-form" onsubmit="handleProductSubmit(event)" class="space-y-4">
                <input type="hidden" id="prod-id">
                <div>
                    <!-- Changed: text-slate-400 -> text-slate-500 -->
                    <label class="text-xs text-slate-500 block mb-1">Nama Produk</label>
                    <!-- Changed: Inputs to Light Theme Style (bg-white, text-slate-700, border-slate-200) -->
                    <input type="text" id="prod-name" class="w-full glass-input px-4 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Harga Jual (Rp)</label>
                        <input type="number" id="prod-price" class="w-full glass-input px-4 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition" required>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 block mb-1">Modal (Rp)</label>
                        <input type="number" id="prod-capital" class="w-full glass-input px-4 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition" required>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-500 block mb-1">Kategori</label>
                    <select id="prod-cat" class="w-full glass-input px-4 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition"></select>
                </div>
                <div>
                    <label class="text-xs text-slate-500 block mb-1">Icon (FontAwesome)</label>
                    <input type="text" id="prod-icon" class="w-full glass-input px-4 py-2 rounded-lg text-sm text-slate-700 bg-white border border-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition" placeholder="fa-solid fa-box">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <!-- Changed: Button styles for Light Theme -->
                    <button type="button" onclick="closeProductModal()" class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 text-sm transition font-medium">Batal</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm shadow-lg shadow-indigo-200 transition font-bold">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SETTING MODAL (DARK THEME) -->
    <div id="setting-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 transform scale-95 transition-all duration-300 bg-slate-800 border border-slate-700 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4" id="setting-modal-title">Tambah Data</h3>
            <form id="setting-form" onsubmit="handleSettingSubmit(event)">
                <input type="hidden" id="setting-type">
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">Nama</label>
                        <input type="text" id="setting-name" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-white bg-slate-900 border-slate-700 focus:border-indigo-500" required>
                    </div>
                    <div id="setting-extra-fields"></div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeSettingModal()" class="px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 text-xs transition">Batal</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-xs shadow-lg shadow-indigo-500/30 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let cart = []; 
        let expenseChartInstance = null;
        let salesDoughnutInstance = null; 
        let profitLineChartInstance = null; 
        let profitExpenseChartInstance = null; // NEW CHART INSTANCE
        let dbNotes = [
            { id: 1, text: 'Beli kertas thermal', date: new Date().toISOString() },
            { id: 2, text: 'Cek stok perdana Axis', date: new Date().toISOString() }
        ]; // Init Dummy Notes
        
        // UPDATED: Mengubah Tipe Akun Modal, Laba, Hutang, Tabungan menjadi Aktif (Tunai/Bank)
        let dbAccounts = [
            { id: 1, name: 'BRI Galih', balance: 1000000, type: 'Bank', color: 'blue' }, 
            { id: 2, name: 'BRI Nussa', balance: 1000000, type: 'Bank', color: 'indigo' }, 
            { id: 3, name: 'BNI Nussa', balance: 1000000, type: 'Bank', color: 'orange' }, 
            { id: 4, name: 'Dana Galih', balance: 1000000, type: 'E-Wallet', color: 'blue' }, 
            { id: 5, name: 'Dana Nussa', balance: 1000000, type: 'E-Wallet', color: 'blue' }, 
            { id: 6, name: 'Cash', balance: 1000000, type: 'Tunai', color: 'emerald' }, 
            // Modal: Internal -> Tunai
            { id: 7, name: 'Modal', balance: 1000000, type: 'Tunai', color: 'slate' }, 
            { id: 8, name: 'Order Kuota', balance: 1000000, type: 'App', color: 'rose' }, 
            { id: 9, name: 'Digipos', balance: 1000000, type: 'App', color: 'rose' }, 
            { id: 10, name: 'SavePlus', balance: 1000000, type: 'Bank', color: 'indigo' }, 
            { id: 11, name: 'Go-pay', balance: 1000000, type: 'E-Wallet', color: 'emerald' }, 
            { id: 12, name: 'Shopee Pay', balance: 1000000, type: 'E-Wallet', color: 'orange' }, 
            { id: 13, name: 'i-Simle', balance: 1000000, type: 'App', color: 'yellow' }, 
            { id: 14, name: 'Buku Warung', balance: 1000000, type: 'App', color: 'slate' }, 
            // Laba Bersih: Internal -> Tunai
            { id: 15, name: 'Laba Bersih', balance: 1000000, type: 'Tunai', color: 'emerald' }, 
            // Hutang: Expense -> Tunai
            { id: 16, name: 'Hutang', balance: 1000000, type: 'Tunai', color: 'emerald' }, 
            { id: 17, name: 'Fee BRI Link', balance: 1000000, type: 'Bank', color: 'indigo' }, 
            // Tabungan: Internal -> Bank
            { id: 18, name: 'Tabungan', balance: 1000000, type: 'Bank', color: 'orange' }, 
            { id: 19, name: 'Bank Jateng', balance: 1000000, type: 'Bank', color: 'orange' }
        ];

        let dbTrxCategories = ['Penjualan', 'Kulakan Pulsa', 'Kulak Konter', 'Listrik Toko', 'Gaji Karyawan', 'Pengeluaran Rumah', 'Makan', 'Transport', 'Tarik Tunai', 'Setor Tunai', 'Transfer', 'E-Wallet', 'Fee BRI Link', 'Laba Bersih', 'Lainnya'];
        let dbProductCategories = ['Pulsa', 'Data', 'PLN', 'ATK', 'Jasa', 'Keuangan', 'Aksesoris'];
        let dbProducts = [];
        let dbTransactions = []; 
        let currentPOSCategory = 'Semua';
        let currentTrxTimeFilter = 'all';
        let currentTrxTypeFilter = 'all';
        let currentTrxSourceFilter = 'all';
        let currentDashboardPeriod = 'today'; // Added: Global variable for dashboard period filter
        let dbDebtors = [];
        let currentViewingTrxId = null; 

        // --- NEW: CUSTOM ALERT & CONFIRM LOGIC ---
        let confirmCallback = null;

        function showConfirm(title, msg, callback) {
            document.getElementById('modal-confirm-title').innerText = title;
            document.getElementById('modal-confirm-msg').innerText = msg;
            confirmCallback = callback;
            
            const modal = document.getElementById('custom-confirm-modal');
            modal.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function handleConfirmYes() {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        }

        function closeConfirmModal() {
            const modal = document.getElementById('custom-confirm-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                confirmCallback = null;
            }, 200);
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fa-solid fa-circle-check text-emerald-400"></i><span>${msg}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function initDummyData() {
            const core = [{ name: 'Pulsa 10k', price: 12000, capital: 10500, category: 'Pulsa', icon: 'fa-solid fa-mobile-screen', color: 'emerald', sales: 0, stock: 50 }, { name: 'Pulsa 20k', price: 22000, capital: 20500, category: 'Pulsa', icon: 'fa-solid fa-mobile-screen', color: 'emerald', sales: 0, stock: 40 }, { name: 'Token PLN 20k', price: 23000, capital: 20500, category: 'PLN', icon: 'fa-solid fa-bolt', color: 'yellow', sales: 0, stock: 100 }, { name: 'Data Tsel 3GB', price: 25000, capital: 22000, category: 'Data', icon: 'fa-solid fa-signal', color: 'rose', sales: 0, stock: 25 }, { name: 'Transfer Bank', price: 10000, capital: 0, category: 'Keuangan', icon: 'fa-solid fa-money-bill-1-wave', color: 'blue', sales: 0, stock: 999 }, { name: 'Print HVS Hitam', price: 500, capital: 200, category: 'Jasa', icon: 'fa-solid fa-print', color: 'slate', sales: 0, stock: 500 }];
            core.forEach((p, i) => dbProducts.push({ id: i + 1, ...p }));
        }
        initDummyData();

        function formatRupiah(number) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(number); }
        
        // UPDATED: Mengubah formatRupiahSimple agar TIDAK MENYINGKAT angka sama sekali.
        // Sekarang fungsi ini langsung memanggil formatRupiah() biasa.
        function formatRupiahSimple(number) { 
            return formatRupiah(number); 
        }
        
        function formatDateHeader(dateString) { const date = new Date(dateString); const today = new Date(); const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1); const d = date.getDate(); const m = date.toLocaleString('id-ID', { month: 'long' }); const y = date.getFullYear(); const dateStr = date.toDateString(); const todayStr = today.toDateString(); const yesterdayStr = yesterday.toDateString(); if (dateStr === todayStr) return "Hari Ini"; if (dateStr === yesterdayStr) return "Kemarin"; return `${d} ${m} ${y}`; }
        function formatDateShort(dateString) { const date = new Date(dateString); return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }); }
        function isDateInPeriod(dateString, period) { const date = new Date(dateString); const today = new Date(); const d = new Date(date.getFullYear(), date.getMonth(), date.getDate()); const t = new Date(today.getFullYear(), today.getMonth(), today.getDate()); if (period === 'all') return true; if (period === 'today') return d.getTime() === t.getTime(); if (period === 'yesterday') { const y = new Date(t); y.setDate(t.getDate() - 1); return d.getTime() === y.getTime(); } if (period === 'week') { const day = t.getDay() || 7; if (day !== 1) t.setHours(-24 * (day - 1)); const endOfWeek = new Date(t); endOfWeek.setDate(t.getDate() + 6); return d >= t && d <= endOfWeek; } if (period === 'month') return d.getMonth() === t.getMonth() && d.getFullYear() === t.getFullYear(); return true; }

        // --- NEW: FUNCTION TO RENDER DATE HEADER ---
        function renderDateHeader() {
            const el = document.getElementById('header-date-display');
            if(el) {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateStr = now.toLocaleDateString('id-ID', options);
                el.innerText = `Ringkasan Konter Hari Ini, ${dateStr}`;
            }
        }

        function revertStock(note) {
            if (!note) return 0;
            const items = note.split(', '); let totalRevertedCapital = 0;
            items.forEach(itemStr => { const match = itemStr.match(/^(.*)\s\((\d+)\)$/); if (match) { const name = match[1]; const qty = parseInt(match[2]); const product = dbProducts.find(p => p.name === name); if (product) { product.stock = (product.stock || 0) + qty; totalRevertedCapital += (product.capital * qty); } } });
            return totalRevertedCapital;
        }

        function revertBalance(t) {
            const amount = parseInt(t.amount) || 0; 
            
            // --- LOGIKA KHUSUS MANUAL (JASA & APLIKASI) SESUAI REQUEST BARU ---
            if (t.source === 'manual') {
                // 1. Revert Jasa
                if (t.category === 'Jasa' || t.category.includes('Jasa')) {
                    const m = t.note ? t.note.match(/Modal:?\s*(\d+)/i) : null; 
                    const modal = m ? parseInt(m[1]) : 0;
                    const profit = amount - modal;

                    // Kurangi kembali Modal (dari akun Modal)
                    const modalIndex = dbAccounts.findIndex(a => a.name === 'Modal');
                    if(modalIndex !== -1) dbAccounts[modalIndex].balance = parseInt(dbAccounts[modalIndex].balance) - modal;

                    // Kurangi kembali Laba
                    const labaIndex = dbAccounts.findIndex(a => a.name === 'Laba Bersih'); 
                    if(labaIndex !== -1) dbAccounts[labaIndex].balance = parseInt(dbAccounts[labaIndex].balance) - profit;

                    // REVERT KE DESTINATION (KASIR/TUNAI)
                    const destIndex = dbAccounts.findIndex(a => a.name === t.account);
                    if(destIndex !== -1) dbAccounts[destIndex].balance = parseInt(dbAccounts[destIndex].balance) - amount;

                    return; 
                }
                // 2. Revert Aplikasi
                else if (t.category === 'Penjualan Aplikasi' || t.category.includes('Aplikasi')) {
                    const m = t.note ? t.note.match(/Modal\s*(\d+)/i) : null; 
                    const modal = m ? parseInt(m[1]) : 0;
                    const profit = amount - modal;

                    // Kembalikan Saldo Sumber (Source)
                    const sourceIndex = dbAccounts.findIndex(a => a.name === t.account); // Di App, account = source
                    if(sourceIndex !== -1) dbAccounts[sourceIndex].balance = parseInt(dbAccounts[sourceIndex].balance) + modal;

                    // Kurangi Saldo Tujuan (Dest)
                    const destIndex = dbAccounts.findIndex(a => a.name === t.destination);
                    if(destIndex !== -1) dbAccounts[destIndex].balance = parseInt(dbAccounts[destIndex].balance) - amount;

                    // Kurangi Laba
                    const labaIndex = dbAccounts.findIndex(a => a.name === 'Laba Bersih'); 
                    if(labaIndex !== -1) dbAccounts[labaIndex].balance = parseInt(dbAccounts[labaIndex].balance) - profit;

                    return;
                }
            }

            // --- LOGIKA STANDAR (POS, TRANSFER, EXPENSE, DLL) ---
            const accIndex = dbAccounts.findIndex(a => a.name === t.account);
            
            if (t.source === 'pos') {
                const totalCapital = revertStock(t.note); 
                const profit = amount - totalCapital;
                const modalIndex = dbAccounts.findIndex(a => a.name === 'Modal');
                if (modalIndex !== -1) dbAccounts[modalIndex].balance = parseInt(dbAccounts[modalIndex].balance) - totalCapital;
                const labaIndex = dbAccounts.findIndex(a => a.name === 'Laba Bersih'); 
                if (labaIndex !== -1) dbAccounts[labaIndex].balance = parseInt(dbAccounts[labaIndex].balance) - profit;
                // Note: POS juga tidak menambah Cash (berdasarkan logika checkout sebelumnya yang masuk ke Laba & Modal), jadi tidak perlu revert Cash.
                return; 
            }
            
            if (accIndex !== -1) {
                if (t.type === 'in') dbAccounts[accIndex].balance = parseInt(dbAccounts[accIndex].balance) - amount;
                else if (t.type === 'out' || t.type === 'tf' || t.type === 'trx') dbAccounts[accIndex].balance = parseInt(dbAccounts[accIndex].balance) + amount;
            }
            
            if (t.type === 'tf' && t.destination) { const destIndex = dbAccounts.findIndex(a => a.name === t.destination); if(destIndex !== -1) dbAccounts[destIndex].balance = parseInt(dbAccounts[destIndex].balance) - amount; }
            
            if (t.type === 'trx' && t.fee > 0 && t.source !== 'manual') { const l = dbAccounts.findIndex(a => a.name === 'Laba Bersih'); if(l !== -1) dbAccounts[l].balance = parseInt(dbAccounts[l].balance) - parseInt(t.fee); }
            
            if (t.source === 'debt' && t.debtorId) {
                const debtor = dbDebtors.find(d => d.id === t.debtorId);
                if (debtor) {
                    if (t.type === 'out') { 
                        debtor.balance -= t.amount;
                    } else if (t.type === 'in') { 
                        debtor.balance += t.amount;
                    }
                }
            }
        }

        function openTrxDetail(id) {
            const t = dbTransactions.find(x => x.id == id);
            if(!t) return;
            
            currentViewingTrxId = id;
            const modal = document.getElementById('trx-detail-modal');
            const content = document.getElementById('trx-detail-content');
            const btnEdit = document.getElementById('btn-detail-edit');
            
            let typeLabel = '', typeColor = 'text-slate-700';
            if(t.type === 'in') { typeLabel = 'Pemasukan'; typeColor = 'text-emerald-600'; }
            else if(t.type === 'out') { typeLabel = 'Pengeluaran'; typeColor = 'text-rose-600'; }
            else if(t.type === 'tf') { typeLabel = 'Transfer'; typeColor = 'text-blue-600'; }
            else if(t.type === 'trx') { typeLabel = 'Transaksi'; typeColor = 'text-orange-600'; }
            
            let detailsHtml = `
                <div class="text-center mb-6">
                    <p class="text-sm text-slate-500 mb-1">${formatDateHeader(t.date)}</p>
                    <h2 class="text-3xl font-bold ${typeColor}">${formatRupiah(t.amount)}</h2>
                    <p class="text-xs font-bold uppercase tracking-wider mt-2 px-3 py-1 bg-slate-100 rounded-full inline-block">${typeLabel}</p>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between py-2 border-b border-slate-100">
                        <span class="text-slate-500">Kategori</span>
                        <span class="font-bold text-slate-700 text-right">${t.category}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-slate-100">
                        <span class="text-slate-500">Akun</span>
                        <span class="font-bold text-slate-700 text-right">${t.account}</span>
                    </div>
            `;
            
            if(t.destination) {
                detailsHtml += `
                    <div class="flex justify-between py-2 border-b border-slate-100">
                        <span class="text-slate-500">Tujuan</span>
                        <span class="font-bold text-slate-700 text-right">${t.destination}</span>
                    </div>
                `;
            }
            
            detailsHtml += `
                    <div class="py-2">
                        <span class="text-slate-500 block mb-1">Catatan</span>
                        <p class="font-medium text-slate-700 bg-slate-50 p-3 rounded-lg">${t.note || '-'}</p>
                    </div>
                </div>
            `;
            
            if (t.source === 'pos') {
                detailsHtml += `<div class="mt-2 p-3 bg-orange-50 text-orange-700 text-xs rounded-lg"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Menghapus data ini akan mengembalikan stok produk.</div>`;
            }
            
            if (t.source === 'debt') {
                detailsHtml += `<div class="mt-2 p-3 bg-rose-50 text-rose-700 text-xs rounded-lg"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Menghapus data ini akan menyesuaikan saldo hutang pelanggan.</div>`;
            }

            content.innerHTML = detailsHtml;
            
            if (t.source === 'manual') {
                btnEdit.style.display = 'block';
                btnEdit.onclick = () => { closeTrxDetailModal(); editTransaction(id); };
            } else {
                btnEdit.style.display = 'none'; 
            }

            modal.classList.remove('hidden');
        }

        function closeTrxDetailModal() {
            document.getElementById('trx-detail-modal').classList.add('hidden');
            currentViewingTrxId = null;
        }

        function deleteCurrentTrx() {
            if(!currentViewingTrxId) return;
            const t = dbTransactions.find(x => x.id == currentViewingTrxId);
            
            let confirmMsg = "Apakah anda yakin ingin menghapus data ini?";
            if(t && t.source === 'pos') confirmMsg = "Stok produk akan dikembalikan. Yakin hapus?";
            
            showConfirm('Konfirmasi Hapus', confirmMsg, () => {
                if(t) revertBalance(t);
                dbTransactions = dbTransactions.filter(x => x.id != currentViewingTrxId);
                closeTrxDetailModal();
                
                renderDashboardAccounts(); 
                renderTransactionHistory(); 
                renderManagementTable(); 
                renderDebtList();
                renderAccountsDrawer();
                renderDashboardStats(); 
                
                showToast("Transaksi berhasil dihapus");
            });
        }

        function editTransaction(id) { const t = dbTransactions.find(x => x.id == id); if(!t) return; if (t.source === 'pos') { showToast('Transaksi POS tidak dapat diedit'); return; } document.getElementById('trx-modal-title').innerText = "Edit Transaksi"; document.getElementById('trx-edit-id').value = t.id; document.getElementById('trx-amount').value = t.amount; document.getElementById('trx-date').value = t.date; document.getElementById('trx-notes').value = t.note; setTrxType(t.type); document.getElementById('trx-account-select').value = t.account; document.getElementById('trx-category-select').value = t.category; if(t.type === 'tf' || t.type === 'trx') document.getElementById('trx-dest-select').value = t.destination; if(t.type === 'trx') document.getElementById('trx-fee').value = t.fee; openTransactionModal(true); }

        function handleTransactionSubmit() { 
            const editId = document.getElementById('trx-edit-id').value; 
            const type = document.getElementById('trx-type').value; 
            const amount = parseInt(document.getElementById('trx-amount').value) || 0; 
            const date = document.getElementById('trx-date').value; 
            const accountName = document.getElementById('trx-account-select').value; 
            const category = document.getElementById('trx-category-select').value; 
            const note = document.getElementById('trx-notes').value; 
            let destination = null, fee = 0; 
            if(amount <= 0) return showToast("Jumlah harus > 0"); 
            if (type === 'tf' || type === 'trx') destination = document.getElementById('trx-dest-select').value; 
            if (type === 'trx') fee = parseInt(document.getElementById('trx-fee').value) || 0; 
            if(editId) { 
                const oldTrx = dbTransactions.find(t => t.id == editId); 
                if(oldTrx) { revertBalance(oldTrx); dbTransactions = dbTransactions.filter(t => t.id != editId); } 
            } 
            const newId = editId ? parseInt(editId) : Date.now(); 
            dbTransactions.push({ id: newId, type, amount, fee, date, account: accountName, destination, category, note, source: 'manual' }); 
            const accIndex = dbAccounts.findIndex(a => a.name === accountName); 
            if(accIndex !== -1) { 
                if(type === 'in') dbAccounts[accIndex].balance = parseInt(dbAccounts[accIndex].balance) + amount; 
                else if(type === 'out') dbAccounts[accIndex].balance = parseInt(dbAccounts[accIndex].balance) - amount; 
                else if(type === 'tf') { 
                    dbAccounts[accIndex].balance = parseInt(dbAccounts[accIndex].balance) - amount; 
                    const destIndex = dbAccounts.findIndex(a => a.name === destination); 
                    if(destIndex !== -1) dbAccounts[destIndex].balance = parseInt(dbAccounts[destIndex].balance) + amount; 
                } else if(type === 'trx') { 
                    dbAccounts[accIndex].balance = parseInt(dbAccounts[accIndex].balance) - amount; 
                    if(fee > 0) { const labaIndex = dbAccounts.findIndex(a => a.name === 'Laba Bersih'); if(labaIndex !== -1) dbAccounts[labaIndex].balance = parseInt(dbAccounts[labaIndex].balance) + fee; } 
                } 
            } 
            renderDashboardAccounts(); 
            renderTransactionHistory(); 
            closeTransactionModal(); 
            renderDashboardStats();
            showToast('Transaksi berhasil disimpan');
        }

        function handleCheckout() { 
            if(cart.length === 0) return; 
            
            const todayDate = new Date().toISOString().split('T')[0];
            const baseId = Date.now(); // Base ID untuk loop

            // Loop setiap item di keranjang dan proses 1 per 1 (Transaksi & Saldo)
            cart.forEach((item, index) => {
                const prod = dbProducts.find(p => p.name === item.name); 
                let itemModal = 0;
                
                // 1. Update Stok Produk
                if (prod) { 
                    itemModal = (prod.capital * item.qty);
                    prod.stock = (prod.stock || 0) - item.qty; 
                    prod.sales = (prod.sales || 0) + item.qty; // Update sales count
                } 

                const itemTotal = item.price * item.qty;
                const itemProfit = itemTotal - itemModal;

                // 2. Catat Transaksi (1 per 1)
                dbTransactions.push({ 
                    id: baseId + index, // Unik ID: waktu + index urutan
                    type: 'in', 
                    amount: itemTotal, 
                    fee: 0, 
                    date: todayDate, 
                    account: 'Kasir', 
                    category: 'Penjualan', 
                    note: `${item.name} (${item.qty})`, // Catatan spesifik per item
                    source: 'pos' 
                }); 

                // 3. Update Saldo Akun (Langsung per item)
                // Masukkan Modal kembali ke akun 'Modal'
                const modalIndex = dbAccounts.findIndex(a => a.name === 'Modal');
                if(modalIndex !== -1) {
                    dbAccounts[modalIndex].balance = parseInt(dbAccounts[modalIndex].balance) + itemModal;
                }

                // Masukkan Profit ke akun 'Laba Bersih'
                const labaIndex = dbAccounts.findIndex(a => a.name === 'Laba Bersih'); 
                if(labaIndex !== -1) {
                    dbAccounts[labaIndex].balance = parseInt(dbAccounts[labaIndex].balance) + itemProfit;
                }
            }); 
            
            // Bersihkan Keranjang & Refresh UI
            cart = []; 
            updateCartUI(); 
            toggleFloatingCart(); 
            renderDashboardAccounts(); 
            renderTransactionHistory(); 
            renderManagementTable(); 
            renderDashboardStats();
            showToast('Transaksi Berhasil Disimpan!'); 
        }

        function renderSpecificTransactionList(containerId, sourceFilter, limit = 0) {
            const el = document.getElementById(containerId); if(!el) return; el.innerHTML = '';
            let filtered = dbTransactions.filter(t => { 
                if (sourceFilter === 'all') return true; 
                return t.source === sourceFilter; 
            });
            if (sourceFilter === 'manual' || containerId === 'dashboard-trx-list') { 
                if (currentTrxTimeFilter !== 'all') filtered = filtered.filter(t => isDateInPeriod(t.date, currentTrxTimeFilter)); 
            }
            const sorted = [...filtered].sort((a,b) => { 
                const dateA = new Date(a.date); 
                const dateB = new Date(b.date); 
                return dateB - dateA || b.id - a.id; 
            });
            const finalData = limit > 0 ? sorted.slice(0, limit) : sorted;
            if(finalData.length === 0) { 
                el.innerHTML = '<div class="flex flex-col items-center justify-center py-10 opacity-50"><i class="fa-solid fa-receipt text-4xl mb-2 text-slate-300"></i><p class="text-xs text-slate-400">Belum ada transaksi</p></div>'; 
                return; 
            }
            const groupedData = {};
            const uniqueDates = [];
            finalData.forEach(t => {
                if (!groupedData[t.date]) {
                    groupedData[t.date] = [];
                    uniqueDates.push(t.date);
                }
                groupedData[t.date].push(t);
            });
            uniqueDates.forEach(dateKey => {
                const displayDate = formatDateHeader(dateKey);
                el.innerHTML += `<div class="gopay-date-header">${displayDate}</div>`;
                let groupHtml = `<div class="gopay-card">`;
                groupedData[dateKey].forEach(t => {
                    let icon='fa-arrow-down', iconBg='bg-cyan-100', iconColor='text-cyan-600';
                    let amountColor='text-emerald-600', sign='+', amountClass='';
                    if(t.type === 'out') { 
                        icon='fa-arrow-up'; iconBg='bg-cyan-100'; iconColor='text-cyan-600'; sign='-'; amountColor='text-slate-800'; 
                    } else if(t.type === 'tf') { 
                        icon='fa-arrow-right'; iconBg='bg-cyan-100'; iconColor='text-cyan-600'; sign='-'; amountColor='text-slate-800';
                    } else if(t.type === 'trx') { 
                        icon='fa-arrow-up'; iconBg='bg-cyan-100'; iconColor='text-cyan-600'; sign='-'; amountColor='text-slate-800';
                    } else if (t.source === 'pos') { 
                        icon = 'fa-bag-shopping'; iconBg='bg-emerald-100'; iconColor='text-emerald-600'; sign='+'; amountColor='text-emerald-600';
                    } else if (t.source === 'debt') { 
                        icon = 'fa-book'; iconBg='bg-rose-100'; iconColor='text-rose-600';
                        if(t.type === 'out') { sign='-'; amountColor='text-slate-800'; } else { sign='+'; amountColor='text-emerald-600'; }
                    } else {
                        icon='fa-arrow-down'; iconBg='bg-emerald-100'; iconColor='text-emerald-600'; sign='+'; amountColor='text-emerald-600';
                    }
                    let title = "";
                    if (t.type === 'tf' || t.type === 'trx') {
                        title = `${t.account} <i class="fa-solid fa-arrow-right text-[10px] mx-1 text-slate-400"></i> ${t.destination || '?'}`;
                    } else {
                        title = t.account;
                    }
                    let details = [];
                    if(t.category) details.push(t.category);
                    if(t.note) details.push(t.note);
                    if(t.type === 'trx' && t.fee > 0) details.push(`Fee: ${formatRupiahSimple(t.fee)}`);
                    let subTitle = details.join('  ');
                    
                    groupHtml += `
                    <div class="gopay-item group" onclick="openTrxDetail(${t.id})">
                        <div class="flex items-center gap-4 w-full overflow-hidden">
                            <div class="w-10 h-10 rounded-full ${iconBg} ${iconColor} flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid ${icon} text-lg"></i>
                            </div>
                            <div class="flex-1 min-w-0 flex flex-col justify-center">
                                <h4 class="text-sm font-bold text-slate-800 leading-tight mb-1 truncate">${title}</h4>
                                <p class="text-xs text-slate-500 truncate font-medium">${subTitle}</p>
                            </div>
                            <div class="text-right flex-shrink-0 flex flex-col justify-center items-end h-full">
                                <div class="text-sm font-bold ${amountColor}">${sign}${formatRupiah(t.amount)}</div>
                            </div>
                        </div>
                    </div>`;
                });
                groupHtml += `</div>`; 
                el.innerHTML += groupHtml;
            });
        }

        function renderTransactionHistory() {
            renderSpecificTransactionList('transactions-list-full', 'manual');
            renderSpecificTransactionList('pos-history-list', 'pos');
            renderSpecificTransactionList('debt-history-list', 'debt');
        }

        function openPOSHistoryModal() { document.getElementById('pos-history-modal').classList.remove('hidden'); renderSpecificTransactionList('pos-history-list', 'pos'); }
        function closePOSHistoryModal() { document.getElementById('pos-history-modal').classList.add('hidden'); }
        function openDebtHistoryModal() { document.getElementById('debt-history-modal').classList.remove('hidden'); renderSpecificTransactionList('debt-history-list', 'debt'); }
        function closeDebtHistoryModal() { document.getElementById('debt-history-modal').classList.add('hidden'); }
        function renderPOSCatalog(query = '') { 
            const containerBest = document.getElementById('pos-bestseller-grid'); 
            const containerAll = document.getElementById('pos-all-grid'); 
            const sectionBest = document.getElementById('section-bestseller'); 
            const sectionSeparator = document.getElementById('section-separator'); 
            
            let filtered = dbProducts; 
            if (query) filtered = dbProducts.filter(p => p.name.toLowerCase().includes(query)); 
            if (currentPOSCategory !== 'Semua') filtered = filtered.filter(p => p.category === currentPOSCategory); 
            
            if (query) { 
                if(sectionBest) sectionBest.style.display = 'none'; 
                if(sectionSeparator) sectionSeparator.style.display = 'none'; 
                const titleEl = document.querySelector('#section-all h3');
                if(titleEl) titleEl.innerText = 'Hasil Pencarian'; 
            } else { 
                if(sectionBest) sectionBest.style.display = 'block'; 
                if(sectionSeparator) sectionSeparator.style.display = 'block'; 
                const titleEl = document.querySelector('#section-all h3');
                if(titleEl) titleEl.innerText = currentPOSCategory === 'Semua' ? 'Daftar Produk Lengkap' : `Kategori: ${currentPOSCategory}`; 
            } 
            
            const globalTop15 = [...dbProducts].sort((a, b) => b.sales - a.sales).slice(0, 15); 
            const allSorted = [...filtered].sort((a, b) => a.name.localeCompare(b.name)); 
            
            if (containerBest) {
                containerBest.innerHTML = ''; 
                if(!query) { 
                    globalTop15.forEach(p => { 
                        // KARTU BESTSELLER GELAP
                        containerBest.innerHTML += `
                        <div class="bg-slate-800 border border-slate-700 p-2 rounded-xl group hover:border-${p.color}-500/50 transition cursor-pointer relative overflow-hidden flex flex-col h-full transform hover:-translate-y-1 hover:shadow-lg hover:shadow-${p.color}-500/10" onclick="addToCart('${p.name}', ${p.price})">
                            <div class="absolute inset-0 bg-gradient-to-t from-${p.color}-900/20 to-transparent opacity-0 group-hover:opacity-100 transition duration-300"></div>
                            <div class="h-12 md:h-16 rounded-lg bg-slate-900/50 border border-slate-700/50 mb-2 flex items-center justify-center relative z-10 group-hover:border-${p.color}-500/30 transition">
                                <i class="${p.icon} text-xl md:text-3xl text-${p.color}-500 group-hover:scale-110 transition drop-shadow-lg"></i>
                            </div>
                            <div class="relative z-10 mt-auto">
                                <h4 class="font-bold text-slate-200 text-[10px] md:text-xs mb-0.5 leading-tight line-clamp-1 group-hover:text-white">${p.name}</h4>
                                <div class="flex justify-between items-end mt-1">
                                    <span class="text-${p.color}-400 font-bold text-[10px]">${formatRupiahSimple(p.price)}</span>
                                    <button class="w-5 h-5 rounded-full bg-${p.color}-600 flex items-center justify-center text-white hover:bg-${p.color}-500 shadow-md transition">
                                        <i class="fa-solid fa-plus text-[8px]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>`; 
                    }); 
                } 
            }
            
            if (containerAll) {
                containerAll.innerHTML = ''; 
                if(allSorted.length === 0) {
                    containerAll.innerHTML = `<div class="col-span-full text-center text-slate-500 py-8"><i class="fa-solid fa-box-open text-4xl mb-2 opacity-30"></i><p class="text-xs">Tidak ada produk</p></div>`; 
                } else { 
                    allSorted.forEach(p => { 
                        // KARTU LIST PRODUK GELAP
                        containerAll.innerHTML += `
                        <div class="flex items-center justify-between bg-slate-800 border border-slate-700 hover:border-indigo-500/50 hover:bg-slate-750 hover:shadow-lg hover:shadow-indigo-500/10 rounded-lg p-2 cursor-pointer transition group" onclick="addToCart('${p.name}', ${p.price})">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <div class="w-7 h-7 rounded bg-slate-900 border border-slate-700 flex-shrink-0 flex items-center justify-center text-${p.color}-500 group-hover:text-${p.color}-400 group-hover:border-${p.color}-500/30 transition">
                                    <i class="${p.icon} text-[10px]"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[11px] md:text-xs font-bold text-slate-300 truncate leading-tight group-hover:text-white transition">${p.name}</p>
                                    <p class="text-[9px] text-slate-500 truncate">${p.category}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-1.5 pl-1">
                                <span class="text-[10px] md:text-xs font-bold text-indigo-400 whitespace-nowrap">${formatRupiahSimple(p.price)}</span>
                                <div class="w-5 h-5 rounded bg-slate-700 text-slate-400 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition shadow-sm">
                                    <i class="fa-solid fa-plus text-[8px]"></i>
                                </div>
                            </div>
                        </div>`; 
                    }); 
                } 
            } 
        }
        function filterPOSCatalog() { const query = document.getElementById('pos-search').value.toLowerCase(); renderPOSCatalog(query); }
        function renderManagementTable() { 
            const tbody = document.getElementById('products-table-body'); 
            if(tbody) {
                tbody.innerHTML = ''; 
                dbProducts.forEach(p => { 
                    tbody.innerHTML += `<tr class="group hover:bg-slate-50 transition"><td class="px-4 py-3"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-${p.color}-50 flex items-center justify-center text-${p.color}-600"><i class="${p.icon}"></i></div><div><p class="font-bold text-slate-700">${p.name}</p><p class="text-[10px] text-slate-500">${p.category}</p></div></div></td><td class="px-4 py-3 font-mono text-slate-500">${formatRupiah(p.capital)}</td><td class="px-4 py-3 font-mono text-slate-700">${formatRupiah(p.price)}</td><td class="px-4 py-3 text-right"><button onclick="editProduct(${p.id})" class="text-indigo-500 hover:text-indigo-700 mr-2"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="deleteProduct(${p.id})" class="text-rose-400 hover:text-rose-600"><i class="fa-solid fa-trash"></i></button></td></tr>`; 
                }); 
            }
        }
        
        function renderSettingsLists() { 
            const accList = document.getElementById('settings-accounts-list'); 
            if (accList) {
                accList.innerHTML = ''; 
                dbAccounts.forEach(a => { 
                    // UPDATED DARK THEME CARD & FULL NOMINAL FORMAT
                    accList.innerHTML += `
                    <div class="glass-card p-3 rounded-xl flex justify-between items-center bg-slate-700/50 border border-slate-600">
                        <div>
                            <p class="text-sm font-bold text-slate-200">${a.name}</p>
                            <p class="text-xs text-slate-400">${formatRupiah(a.balance)}</p>
                        </div>
                        <button onclick="deleteSettingItem('account', ${a.id})" class="text-rose-400 hover:text-rose-300 transition">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>`; 
                }); 
            }
            const trxList = document.getElementById('settings-trxcats-list'); 
            if (trxList) {
                trxList.innerHTML = ''; 
                dbTrxCategories.forEach(c => { 
                    const safeC = c.replace(/'/g, "\\'");
                    // UPDATED DARK THEME CARD
                    trxList.innerHTML += `
                    <div class="glass-card p-3 rounded-xl flex justify-between items-center bg-slate-700/50 border border-slate-600">
                        <span class="text-sm text-slate-200">${c}</span>
                        <button onclick="deleteSettingItem('trxcat', '${safeC}')" class="text-rose-400 hover:text-rose-300 text-xs transition">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>`; 
                }); 
            }
            const prodList = document.getElementById('settings-prodcats-list'); 
            if (prodList) {
                prodList.innerHTML = ''; 
                dbProductCategories.forEach(c => { 
                    const safeC = c.replace(/'/g, "\\'");
                    // UPDATED DARK THEME CARD
                    prodList.innerHTML += `
                    <div class="glass-card p-3 rounded-xl flex justify-between items-center bg-slate-700/50 border border-slate-600">
                        <span class="text-sm text-slate-200">${c}</span>
                        <button onclick="deleteSettingItem('prodcat', '${safeC}')" class="text-rose-400 hover:text-rose-300 text-xs transition">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>`; 
                }); 
            }
        }

        function deleteSettingItem(type, id) { 
            showConfirm('Hapus Data', 'Yakin ingin menghapus item ini?', () => {
                if(type === 'account') dbAccounts = dbAccounts.filter(a => a.id !== id); 
                else if(type === 'trxcat') dbTrxCategories = dbTrxCategories.filter(c => c !== id); 
                else if(type === 'prodcat') dbProductCategories = dbProductCategories.filter(c => c !== id); 
                renderDashboardAccounts(); 
                renderDropdowns(); 
                renderSettingsLists(); 
                renderPOSCategories();
                showToast('Data berhasil dihapus');
            });
        }
        function toggleAccountsDrawer() { const drawer = document.getElementById('accounts-drawer'); const overlay = document.getElementById('accounts-overlay'); if (drawer.classList.contains('translate-x-full')) { drawer.classList.remove('translate-x-full'); overlay.classList.remove('hidden'); renderAccountsDrawer(); } else { drawer.classList.add('translate-x-full'); overlay.classList.add('hidden'); } }
        
        function renderAccountsDrawer() { 
            const container = document.getElementById('drawer-accounts-list'); 
            const totalEl = document.getElementById('drawer-total-assets'); 
            if(!container) return; 
            container.innerHTML = ''; 
            
            let totalRealAssets = 0; 
            
            // Urutkan: Aset Riil dulu, baru Internal/Lainnya
            const sortedAccounts = [...dbAccounts].sort((a, b) => {
                const isRealA = (a.type !== 'Internal' && a.type !== 'Expense');
                const isRealB = (b.type !== 'Internal' && b.type !== 'Expense');
                return isRealB - isRealA; // True (1) comes first
            });

            sortedAccounts.forEach(acc => { 
                // Cek tipe akun untuk perhitungan Total Aset (Hanya aset riil yang dijumlah)
                // Karena tipe akun sudah diubah jadi Tunai/Bank, mereka sekarang dianggap Real Asset
                const isRealAsset = (acc.type !== 'Internal' && acc.type !== 'Expense');
                
                if(isRealAsset) { 
                    totalRealAssets += parseInt(acc.balance); 
                }

                // Tentukan Icon & Style berdasarkan Tipe
                let icon = 'fa-wallet'; 
                let opacityClass = 'opacity-100';
                let iconBg = `bg-${acc.color}-100 text-${acc.color}-600`;
                
                if (acc.type === 'Bank') icon = 'fa-building-columns'; 
                else if (acc.type === 'E-Wallet') icon = 'fa-mobile-screen'; 
                // UPDATED: Tambahkan nama akun khusus agar mendapat icon uang
                else if (['Cash', 'Tunai', 'Kas', 'Modal', 'Laba Bersih', 'Hutang'].includes(acc.name)) icon = 'fa-money-bill-wave'; 
                else if (acc.type === 'App') { icon = 'fa-layer-group'; iconBg = 'bg-slate-100 text-slate-600'; }
                else if (acc.type === 'Internal') { icon = 'fa-lock'; opacityClass = 'opacity-70 grayscale'; iconBg = 'bg-slate-200 text-slate-500'; } // Internal agak diredupkan
                else if (acc.type === 'Expense') { icon = 'fa-arrow-trend-down'; opacityClass = 'opacity-70'; }

                // UPDATED: TAMPILAN LEBIH RAPAT (PADDING DIKURANGI 50% & PROPORSIONAL)
                // py-1.5 (6px) menggantikan p-3 (12px), w-8 h-8 menggantikan w-10 h-10, text-xs
                container.innerHTML += `
                <div class="flex items-center justify-between py-1.5 px-3 rounded-lg bg-slate-50 hover:bg-slate-100 transition border border-slate-200 ${opacityClass}">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full ${iconBg} flex items-center justify-center">
                            <i class="fa-solid ${icon} text-xs"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-700 leading-tight">${acc.name}</p>
                            <p class="text-[9px] text-slate-500 flex items-center gap-1 leading-tight mt-0.5">
                                ${acc.type} ${!isRealAsset ? '<span class="px-1 py-0 rounded bg-slate-200 text-[8px] font-bold text-slate-500">Non</span>' : ''}
                            </p>
                        </div>
                    </div>
                    <span class="text-xs font-bold ${!isRealAsset ? 'text-slate-400' : 'text-slate-800'}">${formatRupiah(acc.balance)}</span>
                </div>`; 
            }); 
            
            if(totalEl) totalEl.innerText = formatRupiah(totalRealAssets); 
        }
        
        function closeAllMenus(event) { 
            // No more dropdowns
        }

        // Helper untuk cek akun real (bukan virtual/internal)
        function isRealAccount(name) {
            const acc = dbAccounts.find(a => a.name === name);
            // Akun Real adalah yang BUKAN tipe Internal atau Expense
            return acc && acc.type !== 'Internal' && acc.type !== 'Expense';
        }

        // --- SLIDER INTERACTION LOGIC (DRAG TO SCROLL) ---
        let isDown = false;
        let startX;
        let scrollLeft;

        function initSliderInteraction() {
            const slider = document.getElementById('dashboard-accounts-slider');
            if(!slider) return;

            // Mouse Events untuk Dragging
            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                slider.classList.add('cursor-grabbing');
                slider.classList.remove('cursor-grab', 'snap-x', 'snap-mandatory'); // Matikan snap saat drag agar smooth
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('cursor-grabbing');
                slider.classList.add('cursor-grab', 'snap-x', 'snap-mandatory');
            });
            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('cursor-grabbing');
                slider.classList.add('cursor-grab', 'snap-x', 'snap-mandatory');
            });
            slider.addEventListener('mousemove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; // Kecepatan scroll
                slider.scrollLeft = scrollLeft - walk;
            });

            // Update Dots saat scroll (baik drag maupun swipe/touch)
            slider.addEventListener('scroll', () => {
                const cardWidth = slider.offsetWidth; // Lebar 1 kartu (karena w-full/min-w-full)
                // Hitung index (dengan toleransi sedikit)
                const index = Math.round(slider.scrollLeft / cardWidth);
                updateSliderDotsUI(index);
            });
        }

        function updateSliderDotsUI(activeIndex) {
            const dotsContainer = document.getElementById('slider-dots');
            if(!dotsContainer) return;
            const dots = dotsContainer.children;
            
            for(let i=0; i<dots.length; i++) {
                if(i === activeIndex) {
                    dots[i].className = "w-6 h-1.5 rounded-full bg-indigo-500 transition-all duration-300"; // Aktif: Lebar & Berwarna
                } else {
                    dots[i].className = "w-1.5 h-1.5 rounded-full bg-slate-700 transition-all duration-300"; // Inaktif: Kecil & Gelap
                }
            }
        }

        function renderDashboardAccounts() { 
            const container = document.getElementById('dashboard-accounts-slider'); 
            const totalAssetsEl = document.getElementById('total-assets-value'); 
            const totalCountEl = document.getElementById('total-accounts-count'); 
            const badgeEl = document.getElementById('total-assets-badge');
            const dotsContainer = document.getElementById('slider-dots');

            if(!container) return;
            container.innerHTML = ''; 
            if(dotsContainer) dotsContainer.innerHTML = ''; // Reset dots
            
            let total = 0; 
            
            // DAFTAR AKUN UTAMA UNTUK SLIDER
            const sliderAccounts = ['BRI Galih', 'BRI Nussa', 'BNI Nussa'];
            let renderedCardCount = 0;

            // 1. Render Kartu & Hitung Total
            dbAccounts.forEach(acc => { 
                // Hitung Total Aset Global
                if(acc.type !== 'Internal' && acc.type !== 'Expense') { 
                    total += parseInt(acc.balance); 
                }

                // Render Hanya Akun Pilihan
                if(sliderAccounts.includes(acc.name)) {
                    renderedCardCount++;
                    let bgClass = 'from-slate-700 to-slate-900'; 
                    if(acc.color === 'blue') bgClass = 'from-blue-500 via-blue-600 to-indigo-600'; 
                    else if(acc.color === 'indigo') bgClass = 'from-indigo-500 via-purple-600 to-fuchsia-600'; 
                    else if(acc.color === 'yellow') bgClass = 'from-yellow-400 via-yellow-500 to-orange-500'; 
                    else if(acc.color === 'orange') bgClass = 'from-orange-400 via-orange-500 to-red-500'; 
                    else if(acc.color === 'emerald') bgClass = 'from-emerald-400 to-emerald-600'; 
                    else if(acc.color === 'rose') bgClass = 'from-rose-400 to-rose-600'; 
                    else if(acc.color === 'cyan') bgClass = 'from-cyan-400 to-cyan-600'; 
                    
                    let icon = 'fa-wallet'; 
                    if (acc.type === 'Bank') icon = 'fa-building-columns'; 
                    else if (acc.type === 'E-Wallet') icon = 'fa-mobile-screen'; 
                    else if (acc.name === 'Cash' || acc.name === 'Tunai' || acc.name === 'Kas') icon = 'fa-money-bill-wave'; 
                    
                    // Gunakan h-auto aspect-[1.6/1] untuk responsivitas di kolom sempit
                    container.innerHTML += `
                    <div class="min-w-full w-full flex-shrink-0 snap-center relative h-auto aspect-[1.6/1] md:h-56 rounded-xl md:rounded-3xl p-3 md:p-6 shadow-xl shadow-${acc.color}-900/20 overflow-hidden border border-white/10 select-none">
                        <div class="absolute inset-0 bg-gradient-to-br ${bgClass}"></div>
                        <div class="absolute -right-6 -bottom-6 md:-right-10 md:-bottom-10 text-white/10 text-6xl md:text-9xl">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div class="relative h-full flex flex-col justify-between z-10 text-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-[8px] md:text-xs font-medium opacity-80 uppercase tracking-wider mb-0.5 md:mb-1">${acc.type}</p>
                                    <!-- UPDATED: Menggunakan formatRupiah() agar angka tampil utuh/penuh -->
                                    <h2 class="text-sm md:text-3xl font-bold tracking-tight">${formatRupiah(acc.balance)}</h2>
                                </div>
                                <div class="w-6 h-6 md:w-10 md:h-10 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm">
                                    <i class="fa-solid ${icon} text-[10px] md:text-lg"></i>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-end">
                                    <p class="font-medium text-[10px] md:text-lg truncate max-w-[80px] md:max-w-none">${acc.name}</p>
                                    <i class="fa-solid fa-wifi text-xs md:text-xl opacity-70 rotate-90"></i>
                                </div>
                                <p class="font-mono text-[8px] md:text-sm opacity-60 mt-0.5 md:mt-1 tracking-widest hidden md:block">**** ${Math.floor(1000 + Math.random() * 9000)}</p>
                            </div>
                        </div>
                    </div>`; 
                }
            });

            // 2. Render Dots
            if(dotsContainer && renderedCardCount > 0) {
                for(let i=0; i<renderedCardCount; i++) {
                    // Default dot (inactive)
                    const dotClass = (i === 0) 
                        ? "w-6 h-1.5 rounded-full bg-indigo-500 transition-all duration-300" 
                        : "w-1.5 h-1.5 rounded-full bg-slate-700 transition-all duration-300";
                    dotsContainer.innerHTML += `<div class="${dotClass}"></div>`;
                }
            }

            // Update Total Assets UI
            if(totalAssetsEl) totalAssetsEl.innerText = formatRupiah(total); 
            if(totalCountEl) totalCountEl.innerText = `(${dbAccounts.length} Akun)`; 

            // 3. Logic Badge Persentase (Sama seperti sebelumnya)
            const today = new Date().toISOString().split('T')[0];
            let netChangeToday = 0;
            dbTransactions.forEach(t => {
                if (t.date === today) {
                    if (t.type === 'in' && isRealAccount(t.account)) {
                        if (t.category !== 'Jasa' && t.source !== 'pos') netChangeToday += t.amount;
                    }
                    if (t.type === 'out' && isRealAccount(t.account)) netChangeToday -= t.amount;
                }
            });
            const yesterdayTotal = total - netChangeToday;
            let percent = 0;
            let isPositive = true;
            if (yesterdayTotal !== 0) percent = ((total - yesterdayTotal) / yesterdayTotal) * 100;
            else if (total > 0) percent = 100;
            isPositive = percent >= 0;
            
            if (badgeEl) {
                const absPercent = Math.abs(percent).toFixed(1);
                if (percent === 0) {
                     badgeEl.className = "text-xs font-medium px-2 py-1 rounded-full border flex items-center gap-1 transition-all bg-slate-700/50 border-slate-600 text-slate-400";
                     badgeEl.innerHTML = `0% <i class="fa-solid fa-minus"></i>`;
                } else if (isPositive) {
                    badgeEl.className = "text-xs font-medium px-2 py-1 rounded-full border flex items-center gap-1 transition-all bg-emerald-500/20 border-emerald-500/30 text-emerald-400";
                    badgeEl.innerHTML = `+${absPercent}% <i class="fa-solid fa-arrow-trend-up"></i>`;
                } else {
                    badgeEl.className = "text-xs font-medium px-2 py-1 rounded-full border flex items-center gap-1 transition-all bg-rose-500/20 border-rose-500/30 text-rose-400";
                    badgeEl.innerHTML = `-${absPercent}% <i class="fa-solid fa-arrow-trend-down"></i>`;
                }
            }

            // 4. Initialize Interaction (Drag to Scroll)
            initSliderInteraction();
        }

        // --- NEW: FUNCTION TO HANDLE ANALYTICS FILTER ---
        function updateSalesAnalysis(period) {
            currentDashboardPeriod = period;
            renderDashboardStats();
        }

        // --- DASHBOARD STATS & ANALYTICS CALCULATION ---
        function renderDashboardStats() {
            // 1. Summary Widget (Left Column) - NEW LOGIC FOR RINGKASAN KEUANGAN
            const getBal = (n) => { const a = dbAccounts.find(x => x.name === n); return a ? parseInt(a.balance) : 0; };
            
            const valTabungan = getBal('Tabungan');
            const valModal = getBal('Modal');
            const valCash = getBal('Cash') || getBal('Tunai'); // Handle different names
            const valLaba = getBal('Laba Bersih');
            
            const valBriNussa = getBal('BRI Nussa');
            const valFeeBri = getBal('Fee BRI Link');

            // Card 1: Total Uang Tunai
            const totalTunai = valTabungan + valModal + valCash + valLaba;
            const elTotalTunai = document.getElementById('sum-total-tunai');
            if(elTotalTunai) elTotalTunai.innerText = formatRupiah(totalTunai);

            // Card 2: BRI Nussa (Tanpa Fee)
            const briNussaNet = valBriNussa - valFeeBri;
            const elBriNet = document.getElementById('sum-bri-nussa');
            if(elBriNet) elBriNet.innerText = formatRupiah(briNussaNet);

            // Card 3: Saldo Fee
            const elFee = document.getElementById('sum-fee-bri');
            if(elFee) elFee.innerText = formatRupiahSimple(valFeeBri);

            // Card 4: Tabungan
            const elTab = document.getElementById('sum-tabungan');
            if(elTab) elTab.innerText = formatRupiahSimple(valTabungan);
            
            // --- NEW WIDGET CALCULATION: LABA & PENGELUARAN RUMAH ---
            const elWidgetLaba = document.getElementById('widget-total-laba');
            if(elWidgetLaba) elWidgetLaba.innerText = formatRupiahSimple(valLaba); // Saldo Akun Laba Bersih

            // Hitung Pengeluaran Rumah (Bulan Ini)
            const dateObj = new Date();
            const thisMonth = dateObj.getMonth();
            const thisYear = dateObj.getFullYear();
            
            const expenseRumah = dbTransactions.filter(t => {
                const d = new Date(t.date);
                return t.category === 'Pengeluaran Rumah' && t.type === 'out' && 
                       d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            }).reduce((a,b) => a + b.amount, 0);
            
            const elWidgetRumah = document.getElementById('widget-total-rumah');
            if(elWidgetRumah) elWidgetRumah.innerText = formatRupiahSimple(expenseRumah);

            // Render Chart Baru Laba vs Pengeluaran
            renderProfitExpenseChart();

            // 2. Analytics Widget (Right Column) - Data Calculations
            // a. Penjualan Produk (POS Source)
            let totalSoldQty = 0;
            let totalModalUsed = 0;
            let profitProduct = 0; // KHUSUS: Laba Produk Saja (Harga Jual - Modal)
            let salesToday = 0; 
            
            // b. Laba Lainnya (Manual Source)
            let profitService = 0; // Kategori 'Jasa'
            let profitApp = 0;     // Kategori 'Aplikasi'
            let profitFee = 0;     // Fee from 'trx' type
            let serviceCount = 0;
            let homeExpense = 0;   // Variable baru untuk Pengeluaran Rumah

            const today = new Date().toISOString().split('T')[0];
            
            // FILTER TRANSACTIONS BASED ON SELECTED PERIOD (currentDashboardPeriod)
            
            dbTransactions.forEach(t => {
                // Check date for 'Penjualan Terkini' (today only)
                if (t.date === today && t.type === 'in' && t.source === 'pos') {
                     salesToday += t.amount;
                }

                // Check if transaction is within the selected period for Analytics
                if(isDateInPeriod(t.date, currentDashboardPeriod)) {

                    // Hitung Pengeluaran Rumah (Filter)
                    if (t.category === 'Pengeluaran Rumah' && t.type === 'out') {
                        homeExpense += t.amount;
                    }

                    if (t.source === 'pos') {
                        // === LOGIKA LABA PRODUK (POS) ===
                        let trxModal = 0;
                        const items = t.note.split(', ');
                        
                        items.forEach(itemStr => {
                            const match = itemStr.match(/^(.*)\s\((\d+)\)$/);
                            if (match) {
                                const qty = parseInt(match[2]);
                                totalSoldQty += qty;
                                
                                // Cari modal berdasarkan data produk di database
                                const pName = match[1];
                                const prod = dbProducts.find(p => p.name === pName);
                                if(prod) {
                                    trxModal += (prod.capital * qty);
                                }
                            }
                        });

                        totalModalUsed += trxModal; // Akumulasi total modal global
                        
                        // Profit Produk = Total Transaksi - Total Modal Transaksi
                        profitProduct += (t.amount - trxModal); 
                        
                    } else if (t.source === 'manual') {
                        // === LOGIKA LABA MANUAL (NON-PRODUK) ===
                        if (t.category === 'Jasa' || t.category.includes('Jasa')) {
                            const m = t.note ? t.note.match(/Modal:?\s*(\d+)/i) : null; 
                            const modal = m ? parseInt(m[1]) : 0;
                            profitService += (t.amount - modal);
                            serviceCount++;
                        } else if (t.category === 'Penjualan Aplikasi' || t.category.includes('Aplikasi')) {
                            const m = t.note ? t.note.match(/Modal\s*(\d+)/i) : null; 
                            const modal = m ? parseInt(m[1]) : 0;
                            profitApp += (t.amount - modal);
                        }
                        
                        if (t.fee > 0) {
                            profitFee += t.fee;
                        }
                    }
                }
            });
            
            // c. Total Aset Produk (Stok * Modal) -> Saldo Akun "Modal"
            const totalAssetValue = valModal; 

            // Update UI Elements
            const elSalesToday = document.getElementById('sum-sales-today');
            if(elSalesToday) elSalesToday.innerText = formatRupiah(salesToday);

            const elSold = document.getElementById('ana-prod-sold'); if(elSold) elSold.innerText = totalSoldQty + " Pcs";
            const elModalUsed = document.getElementById('ana-modal-used'); if(elModalUsed) elModalUsed.innerText = formatRupiahSimple(totalModalUsed);
            
            // Saldo Modal
            const elAssetVal = document.getElementById('ana-asset-value'); if(elAssetVal) elAssetVal.innerText = formatRupiahSimple(totalAssetValue);
            
            // Pengeluaran Rumah
            const elHomeExp = document.getElementById('ana-home-expense'); if(elHomeExp) elHomeExp.innerText = formatRupiahSimple(homeExpense);

            // LABA PRODUK (Murni dari perhitungan POS)
            const elProfProd = document.getElementById('ana-profit-prod'); if(elProfProd) elProfProd.innerText = formatRupiahSimple(profitProduct);
            
            // Laba Lainnya
            const elProfServ = document.getElementById('ana-profit-service'); if(elProfServ) elProfServ.innerText = formatRupiahSimple(profitService);
            const elProfApp = document.getElementById('ana-profit-app'); if(elProfApp) elProfApp.innerText = formatRupiahSimple(profitApp);
            const elServCount = document.getElementById('ana-service-count'); if(elServCount) elServCount.innerText = serviceCount;
            const elProfFee = document.getElementById('ana-profit-fee'); if(elProfFee) elProfFee.innerText = formatRupiahSimple(profitFee);
            
            // Total Laba Gabungan
            const totalProfit = profitProduct + profitService + profitApp + profitFee;
            const elTotalProf = document.getElementById('ana-total-profit'); if(elTotalProf) elTotalProf.innerText = formatRupiah(totalProfit);

            // Render Line Chart
            renderProfitLineChart(profitProduct, profitService, profitApp, profitFee);
            
            // Render Lists
            renderSpecificTransactionList('dashboard-trx-list', 'manual', 10); 
            renderSpecificTransactionList('dashboard-pos-list', 'pos', 10);
            
            // Render Widgets Lain (Top Products & Debt)
            renderTopProductsWidget();
            renderDebtPreviewWidget();
        }

        // Helper function for Top Products Widget
        function renderTopProductsWidget() {
            const topProductsContainer = document.getElementById('dashboard-top-products');
            if(topProductsContainer) {
                topProductsContainer.innerHTML = '';
                const topProducts = [...dbProducts].sort((a, b) => (b.sales || 0) - (a.sales || 0)).slice(0, 5);
                const hasSales = topProducts.some(p => p.sales > 0);

                if(!hasSales) {
                     topProductsContainer.innerHTML = '<div class="text-center text-slate-500 py-6 text-xs italic opacity-50">Belum ada data penjualan produk</div>';
                } else {
                    topProducts.forEach((p, index) => {
                        if(p.sales === 0) return;
                        let rankStyle = 'bg-slate-700 text-slate-400';
                        let iconRank = `<span class="font-bold">#${index + 1}</span>`;
                        
                        if(index === 0) {
                            rankStyle = 'bg-gradient-to-br from-yellow-400 to-orange-500 text-white shadow-lg shadow-orange-500/30';
                            iconRank = '<i class="fa-solid fa-crown text-xs"></i>';
                        } else if(index === 1) { rankStyle = 'bg-slate-300 text-slate-600'; } 
                        else if(index === 2) { rankStyle = 'bg-orange-700 text-orange-200'; }

                        topProductsContainer.innerHTML += `
                        <div class="flex items-center gap-2 w-full border-b border-slate-300/50 pb-3 text-wrap break-words">
                            <div class="w-8 h-8 rounded-lg ${rankStyle} flex items-center justify-center flex-shrink-0 transition transform group-hover:scale-110">
                                ${iconRank}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-xs font-bold text-slate-700 truncate text-wrap break-words">${p.name}</h4>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-slate-700">${p.sales}</p>
                                
                            </div>
                        </div>`;
                    });
                }
            }
        }

        // Helper function for Debt Preview Widget
        function renderDebtPreviewWidget() {
            const debtPreviewContainer = document.getElementById('dashboard-debt-preview');
            if(debtPreviewContainer) {
                debtPreviewContainer.innerHTML = '';
                const activeDebtors = dbDebtors.filter(d => d.balance > 0);
                const totalDebt = activeDebtors.reduce((acc, curr) => acc + curr.balance, 0);

                debtPreviewContainer.innerHTML += `
                    <div class="bg-gradient-to-r from-rose-900/50 to-slate-800/50 border border-rose-500/30 p-3 rounded-xl mb-3 flex items-center justify-between shadow-lg relative overflow-hidden group shrink-0">
                        <div class="absolute inset-0 bg-rose-500/5 group-hover:bg-rose-500/10 transition"></div>
                        <div class="relative z-10">
                            <p class="text-[12px] text-white font-semibold mb-0.5">Total Piutang</p>
                            <h4 class="text-lg font-bold text-white tracking-tight">${formatRupiah(totalDebt)}</h4>
                        </div>
                        <div class="relative z-10 w-8 h-8 rounded-full bg-white text-red-600 flex items-center justify-center border border-rose-500/30">
                            <i class="fa-solid fa-hand-holding-dollar text-sm"></i>
                        </div>
                    </div>
                `;

                const sortedDebtors = [...activeDebtors].sort((a, b) => b.balance - a.balance).slice(0, 50);

                if(sortedDebtors.length === 0) {
                     debtPreviewContainer.innerHTML += '<div class="text-center text-slate-500 py-4 text-xs italic opacity-50">Tidak ada data piutang aktif</div>';
                } else {
                    sortedDebtors.forEach(d => {
                        debtPreviewContainer.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded-xl bg-gradient-to-bl from-blue-900 to-slate-900 text-white group cursor-pointer" onclick="switchPage('debt')">
                            <div class="flex items-center gap-2.5 overflow-hidden">
                                <div class="w-8 h-8 rounded-full bg-blue-700 text-white flex items-center justify-center flex-shrink-0 group-hover:bg-indigo-600 group-hover:text-white transition">
                                    <i class="fa-solid fa-user text-[10px]"></i>
                                </div>
                                <div class="min-w-0">
                                    <h4 class="text-sm font-bold text-white truncate">${d.name}</h4>
                                    
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0 pl-1">
                                <p class="text-xs font-bold text-white">${formatRupiahSimple(d.balance)}</p>
                            </div>
                        </div>`;
                    });
                }
            }
        }

        function renderProfitExpenseChart() {
            const ctx = document.getElementById('profitExpenseChart');
            if(!ctx) return;

            // Prepare Data for last 6 months
            const labels = [];
            const dataProfit = [];
            const dataExpense = [];
            
            const today = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthName = d.toLocaleString('id-ID', { month: 'short' });
                labels.push(monthName);
                
                const month = d.getMonth();
                const year = d.getFullYear();

                // Filter transactions for this month
                const monthTrx = dbTransactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === month && tDate.getFullYear() === year;
                });

                // Calculate Expense (Pengeluaran Rumah)
                const exp = monthTrx
                    .filter(t => t.type === 'out' && t.category === 'Pengeluaran Rumah')
                    .reduce((a, b) => a + b.amount, 0);
                
                // Calculate Profit (Approximate based on data available)
                let prof = 0;
                monthTrx.forEach(t => {
                    if (t.source === 'pos') {
                        // Hitung modal pos
                        let modal = 0;
                        const items = t.note.split(', ');
                        items.forEach(item => {
                           const m = item.match(/^(.*)\s\((\d+)\)$/);
                           if(m) {
                               const p = dbProducts.find(prod => prod.name === m[1]);
                               if(p) modal += (p.capital * parseInt(m[2]));
                           }
                        });
                        prof += (t.amount - modal);
                    } else if (t.source === 'manual') {
                         if (t.category === 'Jasa' || t.category === 'Penjualan Aplikasi') {
                             const m = t.note ? t.note.match(/Modal:?\s*(\d+)/i) : null; 
                             const modal = m ? parseInt(m[1]) : 0;
                             prof += (t.amount - modal);
                         }
                         if (t.fee > 0) prof += t.fee;
                    }
                });

                dataExpense.push(exp);
                dataProfit.push(prof);
            }

            if (profitExpenseChartInstance) {
                profitExpenseChartInstance.destroy();
            }

            profitExpenseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Laba',
                            data: dataProfit,
                            backgroundColor: '#34d399', // Emerald
                            borderRadius: 4,
                            barPercentage: 0.6
                        },
                        {
                            label: 'Peng. Rumah',
                            data: dataExpense,
                            backgroundColor: '#fb7185', // Rose
                            borderRadius: 4,
                            barPercentage: 0.6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top', 
                            labels: { color: '#94a3b8', font: { size: 9 }, boxWidth: 8 } 
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatRupiahSimple(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            display: false, 
                            beginAtZero: true 
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#64748b', font: { size: 9 } }
                        }
                    }
                }
            });
        }

        function renderProfitLineChart(pProd, pServ, pApp, pFee) {
            const ctx = document.getElementById('profitLineChart');
            if(!ctx) return;

            if (profitLineChartInstance) {
                profitLineChartInstance.destroy();
            }

            // Data points for the chart (simply visualization of the components)
            const labels = ['Produk', 'Jasa', 'Aplikasi', 'Fee'];
            const data = [pProd, pServ, pApp, pFee];

            // Gradient Stroke
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(52, 211, 153, 1)'); // Emerald
            gradient.addColorStop(1, 'rgba(99, 102, 241, 1)'); // Indigo

            profitLineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Profit',
                        data: data,
                        borderColor: '#34d399', // Emerald-400
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#34d399',
                        pointRadius: 6,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            display: false, 
                            beginAtZero: true 
                        },
                        x: { 
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderDropdowns() { 
            const trxAcc = document.getElementById('trx-account-select'); 
            const trxDest = document.getElementById('trx-dest-select'); 
            // REMOVED: msJasaDest dropdown reference
            const msAppSource = document.getElementById('ms-app-source'); 
            const msAppDest = document.getElementById('ms-app-dest'); 
            const debtPay = document.getElementById('debt-pay-account'); 
            
            let opts = dbAccounts.map(a => `<option value="${a.name}">${a.name}</option>`).join(''); 
            
            if(trxAcc) trxAcc.innerHTML = opts + '<option value="Tunai">Tunai</option>'; 
            if(trxDest) trxDest.innerHTML = opts; 
            // if(msJasaDest) msJasaDest.innerHTML = opts; // REMOVED
            if(msAppSource) msAppSource.innerHTML = opts; 
            if(msAppDest) msAppDest.innerHTML = opts; 
            if(debtPay) debtPay.innerHTML = opts; 
            
            const trxCat = document.getElementById('trx-category-select'); 
            if(trxCat) trxCat.innerHTML = dbTrxCategories.map(c => `<option value="${c}">${c}</option>`).join(''); 
            
            const prodCat = document.getElementById('prod-cat'); 
            if(prodCat) prodCat.innerHTML = dbProductCategories.map(c => `<option value="${c}">${c}</option>`).join(''); 
        }

        function renderPOSCategories() { 
            const container = document.getElementById('pos-category-filter'); 
            if(!container) return; 
            
            // Menggunakan style Dark Mode (bg-slate-800, text-slate-400)
            let html = `<button onclick="setPOSCategory('Semua')" class="px-3 py-1.5 rounded-full text-[10px] font-medium whitespace-nowrap transition ${currentPOSCategory === 'Semua' ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30' : 'bg-slate-800 border border-slate-700 text-slate-400 hover:bg-slate-700 hover:text-white'}">Semua</button>`; 
            
            dbProductCategories.forEach(cat => { 
                html += `<button onclick="setPOSCategory('${cat}')" class="px-3 py-1.5 rounded-full text-[10px] font-medium whitespace-nowrap transition ${currentPOSCategory === cat ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30' : 'bg-slate-800 border border-slate-700 text-slate-400 hover:bg-slate-700 hover:text-white'}">${cat}</button>`; 
            }); 
            container.innerHTML = html; 
        }

        function setPOSCategory(cat) { 
            currentPOSCategory = cat; 
            renderPOSCategories(); 
            renderPOSCatalog(); 
        }

        function openProductModal(isEdit=false) { 
            document.getElementById('product-modal').classList.remove('hidden'); 
            if(!isEdit) { 
                document.getElementById('product-form').reset(); 
                document.getElementById('prod-id').value = ''; 
                document.getElementById('modal-title').innerText = 'Tambah Produk'; 
            } 
        }
        function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); }
        
        function editProduct(id) { 
            const p = dbProducts.find(prod => prod.id == id); 
            if(!p) return; 
            document.getElementById('prod-id').value = p.id; 
            document.getElementById('prod-name').value = p.name; 
            document.getElementById('prod-price').value = p.price; 
            document.getElementById('prod-capital').value = p.capital; 
            document.getElementById('prod-cat').value = p.category; 
            document.getElementById('prod-icon').value = p.icon; 
            
            const title = document.getElementById('modal-title');
            if(title) title.innerText = 'Edit Produk';
            
            openProductModal(true); 
        }

        function handleProductSubmit(e) { 
            e.preventDefault(); 
            const id = document.getElementById('prod-id').value; 
            const name = document.getElementById('prod-name').value; 
            const price = parseInt(document.getElementById('prod-price').value); 
            const capital = parseInt(document.getElementById('prod-capital').value) || 0; 
            const cat = document.getElementById('prod-cat').value; 
            const icon = document.getElementById('prod-icon').value || 'fa-solid fa-box'; 
            if(id) { 
                const idx = dbProducts.findIndex(p => p.id == id); 
                if(idx !== -1) { 
                    dbProducts[idx] = { ...dbProducts[idx], name, price, capital, category: cat, icon }; 
                } 
            } else { 
                const newId = dbProducts.length > 0 ? Math.max(...dbProducts.map(p => p.id)) + 1 : 1; 
                const colors = ['indigo', 'pink', 'cyan', 'emerald', 'orange', 'purple']; 
                const randomColor = colors[Math.floor(Math.random() * colors.length)]; 
                dbProducts.push({ id: newId, name, price, capital, category: cat, icon, color: randomColor, sales: 0 }); 
            } 
            renderPOSCatalog(); 
            renderManagementTable(); 
            closeProductModal(); 
            showToast('Produk berhasil disimpan');
        }

        function deleteProduct(id) { 
            showConfirm('Hapus Produk', 'Produk akan dihapus permanen.', () => {
                dbProducts = dbProducts.filter(p=>p.id!==id); 
                renderPOSCatalog(); 
                renderManagementTable(); 
                showToast('Produk dihapus');
            });
        }
        
        function switchSettingTab(tab) { 
            // Hide all tabs
            ['accounts','trxcats','prodcats','backup'].forEach(t => {
                const el = document.getElementById('tab-'+t);
                if(el) el.classList.add('hidden');
                
                const btn = document.getElementById('tab-btn-'+t);
                if(btn) {
                    btn.classList.remove('active', 'border-indigo-500', 'text-white', 'bg-slate-700/50');
                    btn.classList.add('border-transparent', 'text-slate-400'); // Inactive state
                }
            }); 
            
            // Show selected
            const targetEl = document.getElementById('tab-'+tab);
            if(targetEl) targetEl.classList.remove('hidden');
            
            const targetBtn = document.getElementById('tab-btn-'+tab);
            if(targetBtn) {
                targetBtn.classList.add('active', 'border-indigo-500', 'text-white', 'bg-slate-700/50');
                targetBtn.classList.remove('border-transparent', 'text-slate-400');
            }
        }
        
        function openSettingModal(type) { 
            document.getElementById('setting-modal').classList.remove('hidden'); 
            document.getElementById('setting-type').value = type; 
            const extras = document.getElementById('setting-extra-fields'); 
            extras.innerHTML = ''; 
            
            // DARK THEME INPUTS IN JS STRING
            if(type === 'account') extras.innerHTML = `
                <div>
                    <label class="text-xs text-slate-400 block mb-1">Saldo Awal</label>
                    <input type="number" id="setting-balance" class="w-full glass-input px-3 py-2 rounded-lg text-sm text-white bg-slate-900 border-slate-700 focus:border-indigo-500" placeholder="0">
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1">Warna Kartu</label>
                    <select id="setting-color" class="w-full glass-input px-3 py-2 rounded-lg text-sm bg-slate-900 text-white border-slate-700 focus:border-indigo-500">
                        <option value="blue">Biru</option>
                        <option value="indigo">Ungu</option>
                        <option value="yellow">Kuning</option>
                        <option value="slate">Hitam</option>
                    </select>
                </div>`; 
        }
        
        function closeSettingModal() { document.getElementById('setting-modal').classList.add('hidden'); }
        
        function handleSettingSubmit(e) { 
            e.preventDefault(); 
            const type = document.getElementById('setting-type').value; 
            const name = document.getElementById('setting-name').value; 
            if(type === 'account') dbAccounts.push({ id: dbAccounts.length+1, name, balance: document.getElementById('setting-balance').value, type: 'Bank', color: document.getElementById('setting-color').value }); 
            else if(type === 'trxcat') dbTrxCategories.push(name); 
            else if(type === 'prodcat') dbProductCategories.push(name); 
            renderDashboardAccounts(); 
            renderDropdowns(); 
            renderSettingsLists(); 
            renderPOSCategories(); 
            closeSettingModal(); 
            showToast('Pengaturan disimpan');
        }

        // --- EXPORT & IMPORT FUNCTIONALITY ---
        function handleExportData() {
            const dataToExport = {
                accounts: dbAccounts,
                transactions: dbTransactions,
                products: dbProducts,
                trxCategories: dbTrxCategories,
                productCategories: dbProductCategories,
                debtors: dbDebtors,
                exportDate: new Date().toISOString(),
                version: "1.0"
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = 'NexFin_Backup_' + new Date().toISOString().slice(0,10) + '.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Data berhasil didownload!');
        }

        function triggerImport() {
            document.getElementById('import-file-input').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    showConfirm(
                        'Import Data', 
                        'PERINGATAN: Tindakan ini akan MENGHAPUS semua data saat ini dan menggantinya dengan data dari file backup. Lanjutkan?', 
                        () => {
                            // Validate critical data presence
                            if (importedData.accounts && importedData.transactions && importedData.products) {
                                dbAccounts = importedData.accounts;
                                dbTransactions = importedData.transactions;
                                dbProducts = importedData.products;
                                dbTrxCategories = importedData.trxCategories || dbTrxCategories;
                                dbProductCategories = importedData.productCategories || dbProductCategories;
                                dbDebtors = importedData.debtors || [];
                                
                                // Refresh ALL Views
                                renderDashboardAccounts(); 
                                renderDropdowns(); 
                                renderSettingsLists(); 
                                renderPOSCategories(); 
                                renderPOSCatalog(); 
                                renderManagementTable(); 
                                renderTransactionHistory();
                                renderDebtList();
                                renderAccountsDrawer();
                                renderDashboardStats();
                                
                                showToast('Data berhasil direstore!');
                            } else {
                                showToast('File backup tidak valid / rusak.');
                            }
                        }
                    );
                } catch (error) {
                    console.error(error);
                    showToast('Gagal membaca file backup.');
                }
            };
            reader.readAsText(file);
            // Reset input so same file can be selected again if needed
            event.target.value = '';
        }

        // --- NEW FUNCTION: PELUNASAN LANGSUNG KE CASH ---
        function handleDirectPayoff(id) {
            const debtor = dbDebtors.find(d => d.id === id);
            if (!debtor) return;

            showConfirm('Pelunasan Langsung', `Lunasi sisa hutang ${debtor.name} sebesar ${formatRupiah(debtor.balance)}? Dana akan masuk ke akun "Cash".`, () => {
                const amount = debtor.balance;

                // 1. Cari Akun Cash
                let cashIndex = dbAccounts.findIndex(a => a.name === 'Cash');
                // Fallback jika Cash tidak ada, cari tipe Tunai
                if (cashIndex === -1) {
                    cashIndex = dbAccounts.findIndex(a => a.type === 'Tunai' || a.name === 'Tunai');
                }

                if (cashIndex === -1) {
                    showToast("Akun Cash/Tunai tidak ditemukan!");
                    return;
                }

                // 2. Tambah Saldo Cash
                dbAccounts[cashIndex].balance = parseInt(dbAccounts[cashIndex].balance) + amount;

                // 3. Update Debitur (Lunas)
                debtor.balance = 0;
                debtor.note = 'Lunas (Direct)';

                // 4. Catat Transaksi
                dbTransactions.push({
                    id: Date.now(),
                    type: 'in',
                    amount: amount,
                    fee: 0,
                    date: new Date().toISOString().split('T')[0],
                    account: dbAccounts[cashIndex].name,
                    category: 'Pelunasan Hutang',
                    note: `Pelunasan Langsung: ${debtor.name}`,
                    source: 'debt',
                    debtorId: id
                });

                // 5. Refresh UI
                renderDebtList();
                renderDashboardAccounts();
                renderTransactionHistory();
                renderDashboardStats();
                showToast('Hutang berhasil dilunasi!');
            });
        }

        function renderDebtList() { 
            const container = document.getElementById('debt-list-container'); 
            if (container) { 
                container.innerHTML = ''; 
                // Filter hanya yang punya hutang (balance > 0) atau tampilkan semua jika perlu
                // Di sini saya tampilkan semua, tapi yang lunas (0) mungkin bisa difilter atau diberi style beda.
                // Untuk sekarang kita render semua sesuai data.
                
                if(dbDebtors.length === 0) { 
                    container.innerHTML = '<p class="col-span-full text-center text-slate-400 text-sm py-10">Belum ada data kasbon.</p>'; 
                } else { 
                    dbDebtors.forEach(d => { 
                        // Logic untuk menyembunyikan tombol jika sudah lunas
                        const isPaidOff = d.balance <= 0;
                        const actionButtons = isPaidOff 
                            ? `<div class="w-full py-2 bg-slate-100 text-slate-400 rounded-lg text-sm font-bold text-center border border-slate-200"><i class="fa-solid fa-check mr-1"></i> Lunas</div>`
                            : `<div class="flex gap-2">
                                <button onclick="handleDirectPayoff(${d.id})" class="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-xs font-bold shadow-md shadow-emerald-200 transition flex items-center justify-center gap-1" title="Lunasi ke akun Cash">
                                    <i class="fa-solid fa-check-double"></i> Lunas (Cash)
                                </button>
                                <button onclick="openDebtModal('pay', ${d.id})" class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-xs font-bold shadow-md shadow-indigo-200 transition flex items-center justify-center gap-1" title="Bayar sebagian / Pilih akun">
                                    <i class="fa-solid fa-hand-holding-dollar"></i> Cicil
                                </button>
                               </div>`;

                        // Format Tanggal (Jika ada, jika tidak pakai placeholder)
                        const dateStr = d.startDate ? formatDateHeader(d.startDate) : '-';

                        container.innerHTML += `
                        <div class="glass-card p-4 rounded-xl relative group hover:shadow-md transition bg-white border border-slate-200 flex flex-col justify-between h-full">
                            <div>
                                <div class="flex justify-between items-start mb-3">
                                    <div class="min-w-0 pr-2">
                                        <h4 class="font-bold text-slate-700 text-lg truncate" title="${d.name}">${d.name}</h4>
                                        <p class="text-xs text-slate-500 italic truncate">${d.note || '-'}</p>
                                        <!-- NEW: TANGGAL PIUTANG -->
                                        <p class="text-[10px] text-slate-400 mt-1 flex items-center gap-1">
                                            <i class="fa-regular fa-calendar"></i> ${dateStr}
                                        </p>
                                    </div>
                                    <div class="w-8 h-8 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center shrink-0">
                                        <i class="fa-solid fa-user-clock text-xs"></i>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <p class="text-[10px] text-slate-500 uppercase tracking-wide">Sisa Hutang</p>
                                    <h3 class="text-xl font-bold ${d.balance > 0 ? 'text-rose-600' : 'text-emerald-500'}">${formatRupiah(d.balance)}</h3>
                                </div>
                            </div>
                            <div class="mt-auto">
                                ${actionButtons}
                            </div>
                        </div>`; 
                    }); 
                } 
            } 
        }

        function openDebtModal(action = 'add', id = null) { 
            document.getElementById('debt-modal').classList.remove('hidden'); 
            const form = document.getElementById('debt-form'); 
            form.reset(); 
            document.getElementById('debt-action').value = action; 
            document.getElementById('debt-person-id').value = id || ''; 
            
            // NEW: Set Default Date to Today
            document.getElementById('debt-date').value = new Date().toISOString().split('T')[0];

            const accSelect = document.getElementById('debt-pay-account'); 
            if(accSelect) accSelect.innerHTML = dbAccounts.map(a => `<option value="${a.name}">${a.name}</option>`).join(''); 
            
            const title = document.getElementById('debt-modal-title'); 
            const nameField = document.getElementById('field-debt-name'); 
            const accField = document.getElementById('field-debt-account'); 
            const btn = document.getElementById('debt-submit-btn'); 
            
            if (action === 'pay') { 
                const person = dbDebtors.find(d => d.id === id); 
                if(title) title.innerText = `Bayar Hutang: ${person ? person.name : ''}`; 
                if(nameField) nameField.classList.add('hidden'); 
                if(accField) accField.classList.remove('hidden'); 
                if(btn) { 
                    btn.innerText = 'Terima Pembayaran'; 
                    btn.className = "w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-200 transition mt-6"; 
                } 
            } else { 
                if(title) title.innerText = 'Catat Hutang Baru'; 
                if(nameField) nameField.classList.remove('hidden'); 
                if(accField) accField.classList.add('hidden'); 
                if(btn) { 
                    btn.innerText = 'Simpan Hutang'; 
                    btn.className = "w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 transition mt-6"; 
                } 
            } 
        }
        
        function closeDebtModal() { document.getElementById('debt-modal').classList.add('hidden'); }
        
        function handleDebtSubmit(e) { 
            e.preventDefault(); 
            const action = document.getElementById('debt-action').value; 
            const amount = parseInt(document.getElementById('debt-amount').value) || 0; 
            const note = document.getElementById('debt-note').value; 
            // NEW: Get Date Value
            const date = document.getElementById('debt-date').value;
            
            if (amount <= 0) return showToast("Jumlah harus > 0"); 
            
            if (action === 'add') { 
                const name = document.getElementById('debt-name').value; 
                if (!name) return showToast("Nama wajib diisi"); 
                
                // 1. Tambah Data Debitur
                const newId = dbDebtors.length > 0 ? Math.max(...dbDebtors.map(d => d.id)) + 1 : 1; 
                // Simpan tanggal pembuatan hutang jika diperlukan di masa depan
                dbDebtors.push({ id: newId, name: name, balance: amount, note: note, startDate: date }); 
                
                // 2. KURANGI SALDO AKUN "Cash"
                // Prioritas cari akun bernama "Cash"
                let cashIndex = dbAccounts.findIndex(a => a.name === 'Cash');
                
                // Fallback: Jika "Cash" tidak ada, cari akun tipe "Tunai" pertama
                if (cashIndex === -1) {
                    cashIndex = dbAccounts.findIndex(a => a.type === 'Tunai' || a.name === 'Tunai');
                }

                if (cashIndex !== -1) {
                    dbAccounts[cashIndex].balance = parseInt(dbAccounts[cashIndex].balance) - amount;
                }

                // 3. Catat Transaksi Pengeluaran (Gunakan tanggal input)
                dbTransactions.push({ 
                    id: Date.now(), 
                    type: 'out', 
                    amount: amount, 
                    fee: 0, 
                    date: date, // UPDATED: Use user input date
                    account: dbAccounts[cashIndex] ? dbAccounts[cashIndex].name : 'Cash', 
                    category: 'Piutang', 
                    note: `Hutang Baru: ${name} (${note})`, 
                    source: 'debt',
                    debtorId: newId 
                }); 
                showToast('Hutang tercatat & Saldo Cash berkurang'); 
            } else { 
                const id = parseInt(document.getElementById('debt-person-id').value); 
                const idx = dbDebtors.findIndex(d => d.id === id); 
                const accName = document.getElementById('debt-pay-account').value; 
                
                if (idx !== -1) { 
                    if(amount > dbDebtors[idx].balance) return showToast("Pembayaran melebihi sisa hutang"); 
                    dbDebtors[idx].balance -= amount; 
                    if(dbDebtors[idx].balance === 0) { 
                        dbDebtors[idx].note = 'Lunas'; 
                        showToast('Hutang Lunas!');
                    } 
                    const accIdx = dbAccounts.findIndex(a => a.name === accName); 
                    if(accIdx !== -1) dbAccounts[accIdx].balance += amount; 
                    
                    // Catat Transaksi Pembayaran (Gunakan tanggal input)
                    dbTransactions.push({ 
                        id: Date.now(), 
                        type: 'in', 
                        amount: amount, 
                        fee: 0, 
                        date: date, // UPDATED: Use user input date
                        account: accName, 
                        category: 'Hutang', 
                        note: `Bayar Hutang: ${dbDebtors[idx] ? dbDebtors[idx].name : 'Pelanggan'} (${note})`, 
                        source: 'debt',
                        debtorId: id
                    }); 
                    showToast('Pembayaran diterima'); 
                } 
            } 
            closeDebtModal(); 
            renderDebtList(); 
            renderDashboardAccounts(); 
            renderTransactionHistory(); 
            renderDashboardStats();
        }

        function switchPage(pageId) { 
            // Daftar halaman
            const pages = ['dashboard', 'transactions', 'pos', 'products', 'settings', 'debt', 'reports'];

            pages.forEach(p => { 
                const el = document.getElementById(p + '-view'); 
                if(p === pageId) { 
                    if(el) { 
                        el.classList.remove('hidden'); 
                        setTimeout(()=>el.classList.remove('opacity-0'),10); 
                    } 
                } else { 
                    if(el) el.classList.add('hidden', 'opacity-0'); 
                } 
                
                // UPDATE DESKTOP SIDEBAR
                const nav = document.getElementById('nav-' + p); 
                if(nav) p === pageId ? nav.classList.add('active') : nav.classList.remove('active'); 

                // UPDATE MOBILE NAV (NEW LOGIC)
                const mobNav = document.getElementById('mob-nav-' + p);
                if(mobNav) {
                    // Logic khusus untuk tombol POS yang bentuknya bulat (FAB style)
                    if(p === 'pos') {
                       // Tombol POS tidak perlu ganti warna teks karena backgroundnya solid
                    } else {
                        if(p === pageId) {
                            mobNav.classList.add('text-indigo-400');
                            mobNav.classList.remove('text-slate-500');
                        } else {
                            mobNav.classList.remove('text-indigo-400');
                            mobNav.classList.add('text-slate-500');
                        }
                    }
                }
            }); 

            const fab = document.getElementById('fab-cart-trigger'); 
            if(fab) { 
                if(pageId === 'pos') { 
                    fab.classList.remove('hidden'); 
                    // Geser FAB ke atas sedikit agar tidak tertutup nav bottom
                    fab.style.marginBottom = "4rem"; 
                } else { 
                    fab.classList.add('hidden'); 
                    const drawer = document.getElementById('cart-drawer'); 
                    if (drawer && !drawer.classList.contains('-translate-x-full')) toggleFloatingCart(); 
                } 
            } 
            if(pageId === 'debt') renderDebtList(); 
            if(pageId === 'dashboard') renderDashboardStats(); // Ensure stats refresh
        } 
        
        function addToCart(name, price) { 
            const safeName = name.replace(/'/g, "\\'"); 
            const existingItem = cart.find(item => item.name === name); 
            if (existingItem) { 
                existingItem.qty++; 
            } else { 
                cart.push({ name: name, price: price, qty: 1 }); 
            } 
            updateCartUI(); 
            const fab = document.getElementById('fab-cart-trigger'); 
            if(fab) { 
                fab.classList.add('scale-110'); 
                setTimeout(() => fab.classList.remove('scale-110'), 200); 
            } 
        }
        
        function removeFromCart(name) { 
            cart = cart.filter(item => item.name !== name); 
            updateCartUI(); 
        }
        
        function updateCartUI() { 
            const container = document.getElementById('cart-items-container'); 
            const fabBadge = document.getElementById('fab-badge'); 
            if(cart.length===0) { 
                container.innerHTML = `<div id="empty-cart-msg" class="h-full flex flex-col items-center justify-center text-slate-400 opacity-50"><i class="fa-solid fa-basket-shopping text-5xl mb-4"></i><p class="text-sm">Kosong</p></div>`; 
                if(fabBadge) fabBadge.classList.add('hidden'); 
                document.getElementById('cart-total').innerText = formatRupiah(0); 
                document.getElementById('cart-modal-total').innerText = formatRupiah(0); 
            } else { 
                if(fabBadge) { 
                    fabBadge.classList.remove('hidden'); 
                    fabBadge.innerText = cart.reduce((a,b)=>a+b.qty,0); 
                } 
                let html = ''; 
                cart.forEach(item => { 
                    const safeName = item.name.replace(/'/g, "\\'"); 
                    html += `<div class="flex justify-between items-center bg-slate-50 border border-slate-200 p-3 rounded-lg mb-2"><div><p class="text-sm font-bold text-slate-700">${item.name}</p><p class="text-xs text-slate-500">x${item.qty}</p></div><div class="flex items-center gap-2"><span class="text-sm font-bold text-indigo-600">${formatRupiahSimple(item.price*item.qty)}</span><button onclick="removeFromCart('${safeName}')" class="text-rose-400 hover:text-rose-600"><i class="fa-solid fa-trash"></i></button></div></div>`; 
                }); 
                container.innerHTML = html; 
                const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0); 
                const totalModal = cart.reduce((acc, item) => { 
                    const p = dbProducts.find(prod => prod.name === item.name); 
                    return acc + ((p ? p.capital : 0) * item.qty); 
                }, 0); 
                document.getElementById('cart-total').innerText = formatRupiah(total); 
                document.getElementById('cart-modal-total').innerText = formatRupiah(totalModal); 
            } 
        }
        
        function toggleFloatingCart() { 
            const drawer = document.getElementById('cart-drawer'); 
            const overlay = document.getElementById('cart-overlay'); 
            if (drawer.classList.contains('-translate-x-full')) { 
                drawer.classList.remove('-translate-x-full'); 
                drawer.classList.add('translate-x-0'); 
                overlay.classList.remove('hidden'); 
            } else { 
                drawer.classList.add('-translate-x-full'); 
                drawer.classList.remove('translate-x-0'); 
                overlay.classList.add('hidden'); 
            } 
        }
        
        // UPDATED: setTrxType FIXED for Tailwind
        function setTrxType(type) { 
            // 1. Reset semua tombol ke state inaktif
            document.querySelectorAll('.trx-btn').forEach(btn => { 
                // Hapus warna aktif
                btn.classList.remove(
                    'bg-emerald-100', 'text-emerald-600', 
                    'bg-rose-100', 'text-rose-600', 
                    'bg-blue-100', 'text-blue-600', 
                    'bg-orange-100', 'text-orange-600'
                );
                // Tambahkan style inaktif
                btn.classList.add('text-slate-400', 'hover:bg-white'); 
            }); 
            
            // 2. Set tombol aktif
            const btn = document.getElementById('btn-'+type);
            btn.classList.remove('text-slate-400', 'hover:bg-white');
            
            if(type === 'in') btn.classList.add('bg-emerald-100', 'text-emerald-600');
            else if(type === 'out') btn.classList.add('bg-rose-100', 'text-rose-600');
            else if(type === 'tf') btn.classList.add('bg-blue-100', 'text-blue-600');
            else if(type === 'trx') btn.classList.add('bg-orange-100', 'text-orange-600');

            // 3. Update Logic Form
            document.getElementById('trx-type').value = type; 
            const lbl = document.getElementById('label-account'); 
            const dest = document.getElementById('field-dest'); 
            const fee = document.getElementById('field-fee'); 
            
            // Reset visibility
            dest.classList.add('hidden'); 
            fee.classList.add('hidden'); 
            
            if(type==='in') { 
                lbl.innerText='Masuk Ke'; 
            } else if(type==='out') { 
                lbl.innerText='Sumber Dana'; 
            } else if(type==='tf') { 
                lbl.innerText='Dari Rekening'; 
                dest.classList.remove('hidden'); 
            } else if(type==='trx') { 
                lbl.innerText='Dari Rekening'; 
                dest.classList.remove('hidden'); 
                fee.classList.remove('hidden'); 
            } 
        }
        
        function setTrxTimeFilter(val) { 
            currentTrxTimeFilter = val; 
            ['all', 'today', 'week', 'month'].forEach(t => { 
                const btn = document.getElementById('tf-time-' + t); 
                if(t === val) { 
                    btn.className = "px-4 py-1.5 rounded-full bg-indigo-600 text-white text-xs font-medium transition whitespace-nowrap shadow-lg shadow-indigo-200 border border-indigo-500"; 
                } else { 
                    btn.className = "px-4 py-1.5 rounded-full glass-panel bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 text-xs font-medium transition whitespace-nowrap"; 
                } 
            }); 
            renderTransactionHistory(); 
        }
        
        function openTransactionModal(isEdit = false) { 
            document.getElementById('transaction-modal').classList.remove('hidden'); 
            if(!isEdit) { 
                document.getElementById('transaction-form').reset(); 
                document.getElementById('trx-edit-id').value = ''; 
                document.getElementById('trx-modal-title').innerText = "Input Transaksi"; 
                document.getElementById('trx-date').value = new Date().toISOString().split('T')[0]; 
                setTimeout(() => document.getElementById('trx-amount').focus(), 100);
            } 
        }
        function closeTransactionModal() { document.getElementById('transaction-modal').classList.add('hidden'); }
        
        function openManualSalesModal() { 
            document.getElementById('manual-sales-modal').classList.remove('hidden'); 
            const today = new Date().toISOString().split('T')[0]; 
            document.getElementById('ms-jasa-date').value = today; 
            document.getElementById('ms-app-date').value = today; 
            switchManualSalesTab('jasa'); 
        }
        function closeManualSalesModal() { document.getElementById('manual-sales-modal').classList.add('hidden'); }
        
        function switchManualSalesTab(tab) { 
            const formJasa = document.getElementById('ms-form-jasa'); 
            const formApp = document.getElementById('ms-form-aplikasi'); 
            const btnJasa = document.getElementById('tab-ms-jasa'); 
            const btnApp = document.getElementById('tab-ms-aplikasi'); 
            if (tab === 'jasa') { 
                formJasa.classList.remove('hidden'); 
                formApp.classList.add('hidden'); 
                btnJasa.classList.add('active'); 
                btnApp.classList.remove('active'); 
            } else { 
                formJasa.classList.add('hidden'); 
                formApp.classList.remove('hidden'); 
                btnJasa.classList.remove('active'); 
                btnApp.classList.add('active'); 
            } 
        }
        
        function handleManualServiceSubmit(e) { 
            e.preventDefault(); 
            const date = document.getElementById('ms-jasa-date').value; 
            const name = document.getElementById('ms-jasa-name').value; 
            const modalPrice = parseInt(document.getElementById('ms-jasa-modal').value) || 0; 
            const sellPrice = parseInt(document.getElementById('ms-jasa-price').value) || 0; 
            // REMOVED: const destAccName = document.getElementById('ms-jasa-dest').value;
            
            if(sellPrice <= 0) return showToast("Harga jual harus > 0"); 
            
            // LOGIKA OTOMATIS JASA:
            // 1. Tambah ke Akun "Modal" (Hanya nilai modal)
            const modalAccIndex = dbAccounts.findIndex(a => a.name === 'Modal'); 
            if(modalAccIndex !== -1) dbAccounts[modalAccIndex].balance = parseInt(dbAccounts[modalAccIndex].balance) + modalPrice; 
            
            // 2. Tambah ke Akun "Laba Bersih" (Selisih)
            const profit = sellPrice - modalPrice; 
            const labaIndex = dbAccounts.findIndex(a => a.name === 'Laba Bersih'); 
            if(labaIndex !== -1) dbAccounts[labaIndex].balance = parseInt(dbAccounts[labaIndex].balance) + profit; 
            
            // 3. REMOVED: Tambah Ke Akun Penerima (Kasir/Tunai)
            // if(destAccIndex !== -1) dbAccounts[destAccIndex].balance = ...
            
            // Simpan Transaksi
            // Account diset ke "Jasa (Auto)" atau "System" karena nilainya dipecah ke Modal & Laba
            dbTransactions.push({ 
                id: Date.now(), 
                type: 'in', 
                amount: sellPrice, 
                fee: 0, 
                date: date, 
                account: 'Jasa', // Placeholder, karena tidak masuk ke akun aset spesifik
                category: 'Jasa', 
                note: `Jasa: ${name} (Modal: ${modalPrice})`, 
                source: 'manual' 
            }); 
            
            showToast('Penjualan Jasa Disimpan!'); 
            closeManualSalesModal(); 
            renderDashboardAccounts(); 
            renderTransactionHistory(); 
            document.getElementById('ms-form-jasa').reset(); 
            renderDashboardStats();
        }
        
        function handleManualAppSubmit(e) { 
            e.preventDefault(); 
            const date = document.getElementById('ms-app-date').value; 
            const name = document.getElementById('ms-app-name').value; 
            const sourceAccName = document.getElementById('ms-app-source').value; 
            const destAccName = document.getElementById('ms-app-dest').value; 
            const modalPrice = parseInt(document.getElementById('ms-app-modal').value) || 0; 
            const sellPrice = parseInt(document.getElementById('ms-app-price').value) || 0; 
            
            if(sellPrice <= 0) return showToast("Harga jual harus > 0"); 
            
            const sourceIndex = dbAccounts.findIndex(a => a.name === sourceAccName); 
            const destIndex = dbAccounts.findIndex(a => a.name === destAccName); 
            
            // LOGIKA BARU APLIKASI:
            // 1. Kurangi Saldo Sumber sebesar MODAL
            if(sourceIndex !== -1) dbAccounts[sourceIndex].balance = parseInt(dbAccounts[sourceIndex].balance) - modalPrice; 
            
            // 2. Tambah Saldo Tujuan sebesar HARGA JUAL (Bukan hanya modal)
            if(destIndex !== -1) dbAccounts[destIndex].balance = parseInt(dbAccounts[destIndex].balance) + sellPrice; 
            
            // 3. Tambah Laba Bersih (Selisih - untuk tracking profit)
            const profit = sellPrice - modalPrice; 
            const labaIndex = dbAccounts.findIndex(a => a.name === 'Laba Bersih'); 
            if(labaIndex !== -1) dbAccounts[labaIndex].balance = parseInt(dbAccounts[labaIndex].balance) + profit; 
            
            dbTransactions.push({ id: Date.now(), type: 'trx', amount: sellPrice, fee: 0, date: date, account: sourceAccName, destination: destAccName, category: 'Penjualan Aplikasi', note: `${name} (Modal ${modalPrice})`, source: 'manual' }); 
            showToast('Penjualan Aplikasi Disimpan!'); 
            closeManualSalesModal(); 
            renderDashboardAccounts(); 
            renderTransactionHistory(); 
            document.getElementById('ms-form-aplikasi').reset(); 
            renderDashboardStats();
        }

        // NEW: REPORT GENERATION LOGIC
        function renderReports() {
            const container = document.getElementById('report-content');
            if(!container) return;

            // --- 1. EXISTING CALCULATIONS (MODIFIED) ---
            // Global Finance
            let totalAssets = 0;
            let realCash = 0;
            dbAccounts.forEach(acc => {
                if (acc.type !== 'Internal' && acc.type !== 'Expense') {
                    totalAssets += parseInt(acc.balance);
                    realCash += parseInt(acc.balance);
                }
            });
            const labaBersihAcc = dbAccounts.find(a => a.name === 'Laba Bersih');
            const totalLaba = labaBersihAcc ? parseInt(labaBersihAcc.balance) : 0;
            
            // Debt
            const activeDebtors = dbDebtors.filter(d => d.balance > 0);
            const totalDebt = activeDebtors.reduce((acc, curr) => acc + curr.balance, 0);
            const debtCount = activeDebtors.length;

            // Today's Activity & Profit
            const today = new Date().toISOString().split('T')[0];
            let trxTodayCount = 0;
            let omzetPosToday = 0;
            let profitToday = 0; // New metric

            // --- 2. NEW CALCULATIONS ---
            
            // Date helpers for Monthly Stats
            const dateObj = new Date();
            const currentMonth = dateObj.getMonth();
            const currentYear = dateObj.getFullYear();
            
            let monthlyRevenue = 0;
            let monthlyExpense = 0;
            let monthlyTrxCount = 0;

            // Inventory Valuation (Aset Fisik)
            let inventoryValue = 0;
            let lowStockCount = 0;
            let totalStockItems = 0;
            
            dbProducts.forEach(p => {
                inventoryValue += (p.capital * p.stock);
                totalStockItems += p.stock;
                if(p.stock < 5) lowStockCount++;
            });

            // Transaction Loop
            dbTransactions.forEach(t => {
                const tDate = new Date(t.date);
                const isToday = t.date === today;
                const isThisMonth = tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;

                // Today Stats
                if (isToday) {
                    trxTodayCount++;
                    if (t.source === 'pos') {
                        omzetPosToday += t.amount;
                        // Calculate approximate profit for POS today
                        let modal = 0;
                        const items = t.note.split(', ');
                        items.forEach(item => {
                           const m = item.match(/^(.*)\s\((\d+)\)$/);
                           if(m) {
                               const p = dbProducts.find(prod => prod.name === m[1]);
                               if(p) modal += (p.capital * parseInt(m[2]));
                           }
                        });
                        profitToday += (t.amount - modal);
                    } else if (t.source === 'manual') {
                        if(t.type === 'in' || t.type === 'trx') {
                             if (t.category === 'Jasa' || t.category === 'Penjualan Aplikasi') {
                                 const m = t.note ? t.note.match(/Modal:?\s*(\d+)/i) : null; 
                                 const modal = m ? parseInt(m[1]) : 0;
                                 profitToday += (t.amount - modal);
                             }
                             if (t.fee > 0) profitToday += t.fee;
                        }
                    }
                }

                // Monthly Stats
                if (isThisMonth) {
                    if (t.type === 'in' || (t.type === 'trx')) { // Revenue
                        // Simple logic: all IN and TRX counts as turnover/activity value
                        monthlyRevenue += t.amount;
                    }
                    if (t.type === 'out') {
                        monthlyExpense += t.amount;
                    }
                    monthlyTrxCount++;
                }
            });

            // Top Products (Top 3)
            const sortedProducts = [...dbProducts].sort((a, b) => (b.sales || 0) - (a.sales || 0));
            const top3 = sortedProducts.slice(0, 3);

            // --- 3. HTML GENERATION (6 CARDS) ---

            // CARD 1: Keuangan Global
            const cardFinance = `
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-24 h-24 bg-emerald-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-emerald-100"></div>
                <div class="relative z-10">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4"><i class="fa-solid fa-wallet text-emerald-500"></i> Keuangan Global</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                            <span class="text-sm text-slate-500">Total Aset Likuid</span>
                            <span class="font-bold text-slate-800 text-lg">${formatRupiahSimple(realCash)}</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                            <span class="text-sm text-slate-500">Akumulasi Laba</span>
                            <span class="font-bold text-emerald-600">${formatRupiahSimple(totalLaba)}</span>
                        </div>
                        <div class="pt-2"><p class="text-xs text-slate-400 leading-relaxed">Total uang tunai di semua akun bank & e-wallet.</p></div>
                    </div>
                </div>
            </div>`;

            // CARD 2: Neraca Piutang
            const cardDebt = `
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-24 h-24 bg-rose-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-rose-100"></div>
                <div class="relative z-10">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4"><i class="fa-solid fa-book-skull text-rose-500"></i> Neraca Piutang</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                            <span class="text-sm text-slate-500">Total Tertunggak</span>
                            <span class="font-bold text-rose-600 text-lg">${formatRupiahSimple(totalDebt)}</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                            <span class="text-sm text-slate-500">Peminjam Aktif</span>
                            <span class="font-bold text-slate-800">${debtCount} Orang</span>
                        </div>
                        <div class="pt-2"><p class="text-xs text-slate-400 leading-relaxed">Dana usaha yang masih tertahan di pelanggan.</p></div>
                    </div>
                </div>
            </div>`;

            // CARD 3: Aktivitas Hari Ini (With Profit)
            const cardToday = `
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg relative overflow-hidden group text-white">
                <div class="absolute top-0 right-0 w-24 h-24 bg-white/5 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-white/10"></div>
                <div class="relative z-10">
                    <h3 class="font-bold text-white flex items-center gap-2 mb-4"><i class="fa-solid fa-calendar-day text-yellow-400"></i> Aktivitas Hari Ini</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                            <span class="text-sm text-slate-400">Omzet Kasir (POS)</span>
                            <span class="font-bold text-white text-lg">${formatRupiahSimple(omzetPosToday)}</span>
                        </div>
                         <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                            <span class="text-sm text-slate-400">Est. Laba Bersih</span>
                            <span class="font-bold text-emerald-400">${formatRupiahSimple(profitToday)}</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                            <span class="text-sm text-slate-400">Total Transaksi</span>
                            <span class="font-bold text-white">${trxTodayCount} Trx</span>
                        </div>
                    </div>
                </div>
            </div>`;

            // CARD 4: Performa Bulan Ini (Revenue vs Expense)
            const cardMonthly = `
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-blue-100"></div>
                <div class="relative z-10">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4"><i class="fa-solid fa-chart-line text-blue-500"></i> Performa Bulan Ini</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-slate-500">Omzet Masuk</span><span class="font-bold text-slate-700">${formatRupiahSimple(monthlyRevenue)}</span></div>
                            <div class="w-full bg-slate-100 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-slate-500">Pengeluaran</span><span class="font-bold text-rose-500">${formatRupiahSimple(monthlyExpense)}</span></div>
                            <div class="w-full bg-slate-100 rounded-full h-2"><div class="bg-rose-500 h-2 rounded-full" style="width: ${monthlyRevenue > 0 ? Math.min((monthlyExpense/monthlyRevenue)*100, 100) : 0}%"></div></div>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2">Perbandingan arus kas masuk (omzet) dan keluar bulan ini.</p>
                    </div>
                </div>
            </div>`;

            // CARD 5: Valuasi Inventaris
            const cardInventory = `
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-24 h-24 bg-orange-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-orange-100"></div>
                <div class="relative z-10">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4"><i class="fa-solid fa-boxes-stacked text-orange-500"></i> Valuasi Stok</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                            <span class="text-sm text-slate-500">Nilai Aset Fisik</span>
                            <span class="font-bold text-slate-800 text-lg">${formatRupiahSimple(inventoryValue)}</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                            <span class="text-sm text-slate-500">Total Item (Pcs)</span>
                            <span class="font-bold text-orange-600">${totalStockItems}</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                            <span class="text-sm text-slate-500">Stok Menipis</span>
                            <span class="font-bold text-rose-500">${lowStockCount} Item</span>
                        </div>
                        <div class="pt-2"><p class="text-xs text-slate-400 leading-relaxed">Modal yang saat ini mengendap dalam bentuk barang dagangan.</p></div>
                    </div>
                </div>
            </div>`;

            // CARD 6: Top 3 Products
            let productsHtml = '';
            if(top3.length > 0 && top3[0].sales > 0) {
                top3.forEach((p, idx) => {
                    if(p.sales > 0) {
                        productsHtml += `
                        <div class="flex justify-between items-center py-1 border-b border-slate-50 last:border-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-400 w-4">#${idx+1}</span>
                                <span class="text-sm font-medium text-slate-700 truncate max-w-[100px]">${p.name}</span>
                            </div>
                            <span class="text-xs font-bold text-indigo-600">${p.sales} Pcs</span>
                        </div>`;
                    }
                });
            } else {
                productsHtml = '<p class="text-xs text-slate-400 italic py-2">Belum ada data penjualan.</p>';
            }

            const cardTopProducts = `
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-indigo-100"></div>
                <div class="relative z-10">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4"><i class="fa-solid fa-crown text-indigo-500"></i> Top 3 Produk</h3>
                    <div class="space-y-1">
                        ${productsHtml}
                    </div>
                    <div class="pt-3 mt-2 border-t border-slate-100">
                        <p class="text-xs text-slate-400 leading-relaxed">Produk unggulan yang paling banyak diminati pelanggan.</p>
                    </div>
                </div>
            </div>`;

            // Inject All Cards
            container.innerHTML = cardFinance + cardDebt + cardToday + cardMonthly + cardInventory + cardTopProducts;
        }

        // --- NEW: NOTES FUNCTIONS ---
        function openNotesModal() {
            document.getElementById('notes-modal').classList.remove('hidden');
            renderNotesList();
            setTimeout(() => document.getElementById('note-input').focus(), 100);
        }

        function closeNotesModal() {
            document.getElementById('notes-modal').classList.add('hidden');
        }

        function handleAddNote() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();
            
            if (text) {
                const newNote = {
                    id: Date.now(),
                    text: text,
                    date: new Date().toISOString()
                };
                dbNotes.unshift(newNote); // Add to top
                input.value = '';
                renderNotesList();
                showToast('Catatan ditambahkan');
            }
        }

        function deleteNote(id) {
            dbNotes = dbNotes.filter(n => n.id !== id);
            renderNotesList();
        }

        function renderNotesList() {
            const container = document.getElementById('notes-list-container');
            if(!container) return;
            
            container.innerHTML = '';
            
            if(dbNotes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 opacity-50">
                        <i class="fa-regular fa-note-sticky text-4xl text-slate-300 mb-2"></i>
                        <p class="text-sm text-slate-400">Belum ada catatan</p>
                    </div>
                `;
                return;
            }

            dbNotes.forEach(note => {
                // Format simple time like "14:30" or date if older
                const d = new Date(note.date);
                const timeStr = d.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                
                container.innerHTML += `
                    <div class="group flex items-start justify-between bg-amber-150 border border-amber-100 p-3 rounded-xl hover:shadow-sm transition mb-2">
                        <div class="flex-1 min-w-0 mr-2">
                            <p class="text-slate-700 text-sm leading-relaxed break-words">${note.text}</p>
                            <p class="text-[10px] text-amber-600/60 mt-1 font-medium">${timeStr}</p>
                        </div>
                        <button onclick="deleteNote(${note.id})" class="text-amber-300 hover:text-rose-400 p-1 transition opacity-50 group-hover:opacity-100">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `;
            });
        }

        renderDashboardAccounts(); 
        renderDropdowns(); 
        renderSettingsLists(); 
        renderPOSCategories(); 
        renderPOSCatalog(); 
        renderManagementTable(); 
        renderTransactionHistory();
        renderDebtList();
        renderAccountsDrawer();
        
        // Init Dashboard Stats
        renderDashboardStats();
        renderDateHeader(); // Call function to set date on load

        // OVERRIDE switchPage untuk memanggil renderReports saat tab reports dibuka
        const originalSwitchPage = switchPage;
        switchPage = function(pageId) {
            originalSwitchPage(pageId);
            if(pageId === 'reports') {
                renderReports();
            }
        }
    </script>
</body>
</html>
